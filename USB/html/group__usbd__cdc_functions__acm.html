<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>CDC: Communication Device Class (ACM)</title>
<title>USB Component: CDC: Communication Device Class (ACM)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.15.0</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__usbd__cdc_functions__acm.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Content</a>  </div>
  <div class="headertitle">
<div class="title">CDC: Communication Device Class (ACM)<div class="ingroups"><a class="el" href="group__usbd___dev_class_functions.html">Device Class</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Implement application specific behavior of a Communication Device Class (CDC) USB Device using the sub-class Abstract Control Model (ACM).  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Content</h2></td></tr>
<tr class="memitem:group__usbd__cdc_functions__acm__api"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__cdc_functions__acm__api.html">User API</a></td></tr>
<tr class="memdesc:group__usbd__cdc_functions__acm__api"><td class="mdescLeft">&#160;</td><td class="mdescRight">User API reference of the Communication Device Class (ACM). <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__usbd__cdc_functions__acm__conf"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__cdc_functions__acm__conf.html">Configuration</a></td></tr>
<tr class="memdesc:group__usbd__cdc_functions__acm__conf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configuration of the USB Device CDC (ACM) Class in ÂµVision. <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Description</h2>
<p>Implement application specific behavior of a Communication Device Class (CDC) USB Device using the sub-class Abstract Control Model (ACM). </p>
<p>The CDC (ACM) class in the USB Component is used for data communication. You can typically use it in applications that previously used a serial COM or UART communication.</p>
<p>Refer to:</p>
<ul>
<li><a class="el" href="_c_d_c.html">CDC: Communication Device Class</a> for an overview of the CDC class.</li>
<li><a class="el" href="dev_cdc_tutorial.html">USB Device Virtual COM Port</a> example project.</li>
</ul>
<p>The USB Component allows multiple instances of the CDC class. This feature is used to create USB Composite Devices. Each CDC class instance has a separate files and interface functions:</p>
<ul>
<li>A CDC configuration file <a class="el" href="group__usbd__cdc_functions__acm__conf.html">USBD_Config_CDC_n.h</a>.</li>
<li>An application-specific user source code file, which can be implemented with the <script>link_ext('uv4_ca_sourcefiles');</script> <a class="el" href="group__usbd__cdc_functions__acm.html#USBD_User_CDC_ACM_UCT">USBD_User_CDC_ACM_n.c</a>.</li>
<li>Functions that start with the prefix <b>USBD_CDCn_ACM</b> are available for each instance of a CDC ACM class.</li>
</ul>
<p>This documentation uses <em>n</em> as a placeholder for the instance number <em>0</em> - <em>7</em>. Most applications only require one instance of a CDC ACM class. For the first CDC ACM class instance the instance number is 0:</p>
<ul>
<li><b>USBD_Config_CDC_0.h</b></li>
<li><b>USBD_User_CDC_ACM_0.c</b></li>
<li>The function prefix is <b>USBD_CDC0_ACM</b></li>
</ul>
<p><b>Descriptor</b> <b>Requirements</b> </p>
<p>The following descriptors are required in an USB CDC ACM Device:</p>
<ul>
<li>Standard Device Descriptor</li>
<li>Standard Configuration Descriptor</li>
<li>Interface Association Descriptor</li>
<li>CDC Header Functional Descriptor</li>
<li>CDC Union Functional Descriptor</li>
<li>Call Management Functional Descriptor</li>
<li>Abstract Control Management Functional Descriptor</li>
<li>Standard Interface Descriptor for the CDC Class communication interface</li>
<li>Standard Endpoint Descriptor for Interrupt IN endpoint</li>
<li>Standard Interface Descriptor for the CDC Class data interface</li>
<li>Standard Endpoint Descriptors for Bulk IN and Bulk OUT endpoints</li>
</ul>
<p>The necessary descriptors are automatically generated by the USB Middleware Component. The page <a class="el" href="_u_s_b__descriptors.html">USB Descriptors</a> provides more information on the topic.</p>
<p><b>Software Structure</b></p>
<p>The handling for the CDC class endpoint events is implemented in <b>USBD_CDCn_Int_Thread</b> and <b>USBD_CDCn_Bulk_Thread</b> which are started by <a class="el" href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca">USBD_Initialize</a>. Each instance of a CDC class runs an instance of <b>USBD_CDCn_Int_Thread</b> and <b>USBD_CDCn_Bulk_Thread</b>.</p>
<p>The thread USBD_CDCn_Int_Thread handles Interrupt IN Endpoint whereas the USBD_CDCn_Bulk_Thread handles the Bulk IN and Bulk OUT Endpoints.</p>
<div align="center">
<img src="msc_inline_mscgraph_3.png" alt="msc_inline_mscgraph_3" border="0" usemap="#msc_inline_mscgraph_3.map"/>
<map name="msc_inline_mscgraph_3.map" id="msc_inline_mscgraph_3.map"><area href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca" shape="rect" coords="16,104,105,117" alt=""/>
<area href="group__usbd__core_functions__api.html#gad97153303fc0a6f51c1c20ac050b238f" shape="rect" coords="25,155,96,168" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gad50c470966ad2b4337db6b8c8a5f839a" shape="rect" coords="16,257,105,270" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gad50c470966ad2b4337db6b8c8a5f839a" shape="rect" coords="16,270,105,283" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gad50c470966ad2b4337db6b8c8a5f839a" shape="rect" coords="52,283,69,296" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gaf3ced4ece3f150bb3ce1d2c12babeb95" shape="rect" coords="16,327,105,340" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gaf3ced4ece3f150bb3ce1d2c12babeb95" shape="rect" coords="37,340,84,353" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga5091a4b29df447b17bc6bbe87b17db96" shape="rect" coords="16,359,105,372" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga5091a4b29df447b17bc6bbe87b17db96" shape="rect" coords="37,372,84,385" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445" shape="rect" coords="16,410,105,423" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445" shape="rect" coords="25,423,96,436" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04" shape="rect" coords="16,442,105,455" alt=""/>
<area href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04" shape="rect" coords="40,455,81,468" alt=""/>
<area href="group__usbd__core_functions__api.html#ga9440f139618900f2011034e70cd7a528" shape="rect" coords="16,506,105,519" alt=""/>
<area href="group__usbd__core_functions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="16,557,105,570" alt=""/>
<area href="group__usbd__core_functions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="52,570,69,583" alt=""/>
</map>
</div>
<h2>Implementation </h2>
<p>To <a class="el" href="_u_s_b__device.html#Creation_Steps">create an USB Device</a> with a CDC ACM class:</p>
<ul>
<li>Set the required number for USB:Device:CDC class instances during the <a class="el" href="_u_s_b__device.html#RTE_Software_Component_Selection">RTE Component Selection</a>.</li>
<li>Set the parameters in the configuration file <a class="el" href="group__usbd__cdc_functions__acm__conf.html">USBD_Config_CDC_n.h</a>.</li>
<li>Implement the application specific behavior using one of the following templates.</li>
</ul>
<p><a class="anchor" id="USBD_User_CDC_ACM_UCT"></a><b>User Code Template USBD_User_CDC_ACM_n.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (ACM) Device.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:CDC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_ACM_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Abstract Control Model (ACM) User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V6.4.1</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Local Variables</span></div>
<div class="line"><span class="keyword">static</span>   <a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a>        cdc_acm_line_coding = { 0U, 0U, 0U, 0U };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gae533b6ee1feb71d6210a31f1d83f94e8">USBD_CDCn_ACM_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for initialization</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga54ad02ac3b5e8dbcc40e5fe440076e39">USBD_CDCn_ACM_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga3f89d38c6c6bee03e6c3d58c866fe72c">USBD_CDCn_ACM_Reset</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for reset</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called upon reception of request send encapsulated command sent by the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   buf           buffer that contains send encapsulated command request.</span></div>
<div class="line"><span class="comment">// \param[in]   len           length of send encapsulated command request.</span></div>
<div class="line"><span class="comment">// \return      true          send encapsulated command request processed.</span></div>
<div class="line"><span class="comment">// \return      false         send encapsulated command request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad7ad5e60775a104cdf3dc36eded23f2d">USBD_CDCn_ACM_SendEncapsulatedCommand</a> (<span class="keyword">const</span> uint8_t *buf, uint16_t len) {</div>
<div class="line">  (void)buf;</div>
<div class="line">  (void)len;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called upon reception of request to get encapsulated response sent by the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   max_len       maximum number of data bytes that USB Host expects to receive</span></div>
<div class="line"><span class="comment">// \param[out]  buf           pointer to buffer containing get encapsulated response to be returned to USB Host.</span></div>
<div class="line"><span class="comment">// \param[out]  len           pointer to number of data bytes to be returned to USB Host.</span></div>
<div class="line"><span class="comment">// \return      true          get encapsulated response request processed.</span></div>
<div class="line"><span class="comment">// \return      false         get encapsulated response request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga944044922bbb14f9f8c638408e621abc">USBD_CDCn_ACM_GetEncapsulatedResponse</a> (uint16_t max_len, uint8_t **buf, uint16_t *len) {</div>
<div class="line">  (void)max_len;</div>
<div class="line">  (void)buf;</div>
<div class="line">  (void)len;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to change communication settings.</span></div>
<div class="line"><span class="comment">// \param[in]   line_coding   pointer to CDC_LINE_CODING structure.</span></div>
<div class="line"><span class="comment">// \return      true          set line coding request processed.</span></div>
<div class="line"><span class="comment">// \return      false         set line coding request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaeb540c51afed9b5217086bfde6965e99">USBD_CDCn_ACM_SetLineCoding</a> (<span class="keyword">const</span> <a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a> *line_coding) {</div>
<div class="line">  <span class="comment">// Add code for set line coding</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Store requested settings to local variable</span></div>
<div class="line">  cdc_acm_line_coding = *line_coding;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve communication settings.</span></div>
<div class="line"><span class="comment">// \param[out]  line_coding   pointer to CDC_LINE_CODING structure.</span></div>
<div class="line"><span class="comment">// \return      true          get line coding request processed.</span></div>
<div class="line"><span class="comment">// \return      false         get line coding request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga6c1025b67c21bca8b939f3833acd5349">USBD_CDCn_ACM_GetLineCoding</a> (<a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a> *line_coding) {</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Load settings from ones stored on USBD_CDCn_ACM_SetLineCoding callback</span></div>
<div class="line">  *line_coding = cdc_acm_line_coding;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set control line states.</span></div>
<div class="line"><span class="comment">// \param [in]  state         control line settings bitmap.</span></div>
<div class="line"><span class="comment">//                - bit 0: DTR state</span></div>
<div class="line"><span class="comment">//                - bit 1: RTS state</span></div>
<div class="line"><span class="comment">// \return      true          set control line state request processed.</span></div>
<div class="line"><span class="comment">// \return      false         set control line state request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaf6a0e3a8f8452a4c99d7c379ea533b2b">USBD_CDCn_ACM_SetControlLineState</a> (uint16_t state) {</div>
<div class="line">  <span class="comment">// Add code for set control line state</span></div>
<div class="line"> </div>
<div class="line">  (void)(state);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when new data was received.</span></div>
<div class="line"><span class="comment">// \param [in]  len           number of bytes available for reading.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445">USBD_CDCn_ACM_DataReceived</a> (uint32_t len) {</div>
<div class="line">  <span class="comment">// Add code for handling new data reception</span></div>
<div class="line">  (void)len;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when when all data was sent.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga5091a4b29df447b17bc6bbe87b17db96">USBD_CDCn_ACM_DataSent</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling new data send</span></div>
<div class="line">}</div>
<div class="line"></div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_CDC_ACM_UART_UCT"></a><b>User Code Template USBD_User_CDC_ACM_UART_n.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (ACM) Device that can be used as a USB &lt;-&gt; UART bridge.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:CDC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_ACM_UART_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Abstract Control Model (ACM) USB &lt;-&gt; UART Bridge User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.0.8</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;Driver_USART.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// UART Configuration ----------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define  UART_PORT              n       // UART Port number</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define  UART_BUFFER_SIZE      (512)    // UART Buffer Size</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//------------------------------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define _UART_Driver_(n)        Driver_USART##n</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define  UART_Driver_(n)       _UART_Driver_(n)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">extern</span>   ARM_DRIVER_USART       UART_Driver_(UART_PORT);</div>
<div class="line"><span class="preprocessor">#define  ptrUART              (&amp;UART_Driver_(UART_PORT))</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">// External functions</span></div>
<div class="line"><span class="preprocessor">#ifdef   USB_CMSIS_RTOS</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">extern</span>   <span class="keywordtype">void</span>                   CDCn_ACM_UART_to_USB_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">// Local Variables</span></div>
<div class="line"><span class="keyword">static</span>            uint8_t       uart_rx_buf[UART_BUFFER_SIZE];</div>
<div class="line"><span class="keyword">static</span>            uint8_t       uart_tx_buf[UART_BUFFER_SIZE];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span>   <span class="keyword">volatile</span> int32_t       uart_rx_cnt         =   0;</div>
<div class="line"><span class="keyword">static</span>   <span class="keyword">volatile</span> int32_t       usb_tx_cnt          =   0;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span>   <span class="keywordtype">void</span>                  *cdc_acm_bridge_tid  =   0U;</div>
<div class="line"><span class="keyword">static</span>   <a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a>        cdc_acm_line_coding = { 0U, 0U, 0U, 0U };</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when UART has transmitted or received requested number of bytes.</span></div>
<div class="line"><span class="comment">// \param[in]   event         UART event</span></div>
<div class="line"><span class="comment">//               - ARM_USART_EVENT_SEND_COMPLETE:    all requested data was sent</span></div>
<div class="line"><span class="comment">//               - ARM_USART_EVENT_RECEIVE_COMPLETE: all requested data was received</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> UART_Callback (uint32_t event) {</div>
<div class="line">  int32_t cnt;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (event &amp; ARM_USART_EVENT_SEND_COMPLETE) {</div>
<div class="line">    <span class="comment">// USB -&gt; UART</span></div>
<div class="line">    cnt = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04">USBD_CDC_ACM_ReadData</a>(nU, uart_tx_buf, UART_BUFFER_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (cnt &gt; 0) {</div>
<div class="line">      (void)ptrUART-&gt;Send(uart_tx_buf, (uint32_t)(cnt));</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (event &amp; ARM_USART_EVENT_RECEIVE_COMPLETE) {</div>
<div class="line">    <span class="comment">// UART data received, restart new reception</span></div>
<div class="line">    uart_rx_cnt += UART_BUFFER_SIZE;</div>
<div class="line">    (void)ptrUART-&gt;Receive(uart_rx_buf, UART_BUFFER_SIZE);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread: Sends data received on UART to USB</span></div>
<div class="line"><span class="comment">// \param[in]     arg           not used.</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> CDCn_ACM_UART_to_USB_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN        <span class="keywordtype">void</span> CDCn_ACM_UART_to_USB_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  int32_t cnt, cnt_to_wrap;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line">    <span class="comment">// UART - &gt; USB</span></div>
<div class="line">    <span class="keywordflow">if</span> (ptrUART-&gt;GetStatus().rx_busy != 0U) {</div>
<div class="line">      cnt  = uart_rx_cnt;</div>
<div class="line">      cnt += (int32_t)ptrUART-&gt;GetRxCount();</div>
<div class="line">      cnt -= usb_tx_cnt;</div>
<div class="line">      <span class="keywordflow">if</span> (cnt &gt;= UART_BUFFER_SIZE) {</div>
<div class="line">        <span class="comment">// Dump data received on UART if USB is not consuming fast enough</span></div>
<div class="line">        usb_tx_cnt += cnt;</div>
<div class="line">        cnt = 0U;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (cnt &gt; 0) {</div>
<div class="line">        cnt_to_wrap = (int32_t)(UART_BUFFER_SIZE - ((uint32_t)usb_tx_cnt &amp; (UART_BUFFER_SIZE - 1)));</div>
<div class="line">        <span class="keywordflow">if</span> (cnt &gt; cnt_to_wrap) {</div>
<div class="line">          cnt = cnt_to_wrap;</div>
<div class="line">        }</div>
<div class="line">        cnt = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaf3ced4ece3f150bb3ce1d2c12babeb95">USBD_CDC_ACM_WriteData</a>(nU, (uart_rx_buf + ((uint32_t)usb_tx_cnt &amp; (UART_BUFFER_SIZE - 1))), cnt);</div>
<div class="line">        <span class="keywordflow">if</span> (cnt &gt; 0) {</div>
<div class="line">          usb_tx_cnt += cnt;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    (void)osDelay(10U);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> osRtxThread_t        cdcn_acm_uart_to_usb_thread_cb_mem               __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t             cdcn_acm_uart_to_usb_thread_stack_mem[512U / 8U] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t cdcn_acm_uart_to_usb_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;CDCn_ACM_UART_to_USB_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;cdcn_acm_uart_to_usb_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;cdcn_acm_uart_to_usb_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_CDCn_ACM_UART_to_USB_Thread;</div>
<div class="line">osThreadDef (CDCn_ACM_UART_to_USB_Thread, osPriorityNormal, 1U, 0U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// CDC ACM Callbacks -----------------------------------------------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when new data was received from the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   len           number of bytes available to read.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445">USBD_CDCn_ACM_DataReceived</a> (uint32_t len) {</div>
<div class="line">  int32_t cnt;</div>
<div class="line"> </div>
<div class="line">  (void)(len);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (ptrUART-&gt;GetStatus().tx_busy == 0U) {</div>
<div class="line">    <span class="comment">// Start USB -&gt; UART</span></div>
<div class="line">    cnt = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04">USBD_CDC_ACM_ReadData</a>(nU, uart_tx_buf, UART_BUFFER_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> (cnt &gt; 0) {</div>
<div class="line">      (void)ptrUART-&gt;Send(uart_tx_buf, (uint32_t)(cnt));</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gae533b6ee1feb71d6210a31f1d83f94e8">USBD_CDCn_ACM_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  (void)ptrUART-&gt;Initialize   (UART_Callback);</div>
<div class="line">  (void)ptrUART-&gt;PowerControl (ARM_POWER_FULL);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  cdc_acm_bridge_tid = osThreadNew (CDCn_ACM_UART_to_USB_Thread, NULL, &amp;cdcn_acm_uart_to_usb_thread_attr);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  cdc_acm_bridge_tid = osThreadCreate (osThread (CDCn_ACM_UART_to_USB_Thread), NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga54ad02ac3b5e8dbcc40e5fe440076e39">USBD_CDCn_ACM_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (osThreadTerminate (cdc_acm_bridge_tid) == osOK) {</div>
<div class="line">    cdc_acm_bridge_tid = NULL;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  (void)ptrUART-&gt;Control      (ARM_USART_ABORT_RECEIVE, 0U);</div>
<div class="line">  (void)ptrUART-&gt;PowerControl (ARM_POWER_OFF);</div>
<div class="line">  (void)ptrUART-&gt;Uninitialize ();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga3f89d38c6c6bee03e6c3d58c866fe72c">USBD_CDCn_ACM_Reset</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  (void)ptrUART-&gt;Control      (ARM_USART_ABORT_SEND,    0U);</div>
<div class="line">  (void)ptrUART-&gt;Control      (ARM_USART_ABORT_RECEIVE, 0U);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to change communication settings.</span></div>
<div class="line"><span class="comment">// \param[in]   line_coding   pointer to CDC_LINE_CODING structure.</span></div>
<div class="line"><span class="comment">// \return      true          set line coding request processed.</span></div>
<div class="line"><span class="comment">// \return      false         set line coding request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaeb540c51afed9b5217086bfde6965e99">USBD_CDCn_ACM_SetLineCoding</a> (<span class="keyword">const</span> <a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a> *line_coding) {</div>
<div class="line">  uint32_t data_bits = 0U, parity = 0U, stop_bits = 0U;</div>
<div class="line">  int32_t  status;</div>
<div class="line"> </div>
<div class="line">  (void)ptrUART-&gt;Control (ARM_USART_ABORT_SEND,    0U);</div>
<div class="line">  (void)ptrUART-&gt;Control (ARM_USART_ABORT_RECEIVE, 0U);</div>
<div class="line">  (void)ptrUART-&gt;Control (ARM_USART_CONTROL_TX,    0U);</div>
<div class="line">  (void)ptrUART-&gt;Control (ARM_USART_CONTROL_RX,    0U);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (line_coding-&gt;<a class="code" href="group__usbd__structs.html#a4e6a76c7ae7290a2ffd70897ad631106">bCharFormat</a>) {</div>
<div class="line">    <span class="keywordflow">case</span> 0:                             <span class="comment">// 1 Stop bit</span></div>
<div class="line">      stop_bits = ARM_USART_STOP_BITS_1;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 1:                             <span class="comment">// 1.5 Stop bits</span></div>
<div class="line">      stop_bits = ARM_USART_STOP_BITS_1_5;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 2:                             <span class="comment">// 2 Stop bits</span></div>
<div class="line">      stop_bits = ARM_USART_STOP_BITS_2;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (line_coding-&gt;<a class="code" href="group__usbd__structs.html#a1e40296766f03f33f59f679c6fb845cc">bParityType</a>) {</div>
<div class="line">    <span class="keywordflow">case</span> 0:                             <span class="comment">// None</span></div>
<div class="line">      parity = ARM_USART_PARITY_NONE;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 1:                             <span class="comment">// Odd</span></div>
<div class="line">      parity = ARM_USART_PARITY_ODD;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 2:                             <span class="comment">// Even</span></div>
<div class="line">      parity = ARM_USART_PARITY_EVEN;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (line_coding-&gt;<a class="code" href="group__usbd__structs.html#ada9d5ad8631c5f085c3f402102096f59">bDataBits</a>) {</div>
<div class="line">    <span class="keywordflow">case</span> 5:</div>
<div class="line">      data_bits = ARM_USART_DATA_BITS_5;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 6:</div>
<div class="line">      data_bits = ARM_USART_DATA_BITS_6;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 7:</div>
<div class="line">      data_bits = ARM_USART_DATA_BITS_7;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> 8:</div>
<div class="line">      data_bits = ARM_USART_DATA_BITS_8;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  status = ptrUART-&gt;Control(ARM_USART_MODE_ASYNCHRONOUS  |</div>
<div class="line">                            data_bits                    |</div>
<div class="line">                            parity                       |</div>
<div class="line">                            stop_bits                    ,</div>
<div class="line">                            line_coding-&gt;<a class="code" href="group__usbd__structs.html#a729a933696d5154f550fb297cacecd70">dwDTERate</a>       );</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Store requested settings to local variable</span></div>
<div class="line">  cdc_acm_line_coding = *line_coding;</div>
<div class="line"> </div>
<div class="line">  uart_rx_cnt = 0;</div>
<div class="line">  usb_tx_cnt  = 0;</div>
<div class="line"> </div>
<div class="line">  (void)ptrUART-&gt;Control (ARM_USART_CONTROL_TX, 1U);</div>
<div class="line">  (void)ptrUART-&gt;Control (ARM_USART_CONTROL_RX, 1U);</div>
<div class="line"> </div>
<div class="line">  (void)ptrUART-&gt;Receive (uart_rx_buf, UART_BUFFER_SIZE);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve communication settings.</span></div>
<div class="line"><span class="comment">// \param[out]  line_coding   pointer to CDC_LINE_CODING structure.</span></div>
<div class="line"><span class="comment">// \return      true          get line coding request processed.</span></div>
<div class="line"><span class="comment">// \return      false         get line coding request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga6c1025b67c21bca8b939f3833acd5349">USBD_CDCn_ACM_GetLineCoding</a> (<a class="code" href="group__usbd__structs.html#struct_c_d_c___l_i_n_e___c_o_d_i_n_g">CDC_LINE_CODING</a> *line_coding) {</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Load settings from ones stored on USBD_CDCn_ACM_SetLineCoding callback</span></div>
<div class="line">  *line_coding = cdc_acm_line_coding;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set control line states.</span></div>
<div class="line"><span class="comment">// \param [in]  state         control line settings bitmap.</span></div>
<div class="line"><span class="comment">//                - bit 0: DTR state</span></div>
<div class="line"><span class="comment">//                - bit 1: RTS state</span></div>
<div class="line"><span class="comment">// \return      true          set control line state request processed.</span></div>
<div class="line"><span class="comment">// \return      false         set control line state request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaf6a0e3a8f8452a4c99d7c379ea533b2b">USBD_CDCn_ACM_SetControlLineState</a> (uint16_t state) {</div>
<div class="line">  <span class="comment">// Add code for set control line state</span></div>
<div class="line"> </div>
<div class="line">  (void)(state);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_CDC_ACM_RNDIS_VETH_UCT"></a><b>User Code Template USBD_User_CDC_ACM_RNDIS_VETH_n.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (ACM) Device that can be used for virtual Ethernet using the RNDIS protocol.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:CDC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2018-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_ACM_RNDIS_VETH_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Abstract Control Model (ACM)</span></div>
<div class="line"><span class="comment"> *          Remote Network Driver Interface Specification (RNDIS)</span></div>
<div class="line"><span class="comment"> *          User Module for a Virtual Ethernet</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.0.4</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH_MAC.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH_PHY.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBD_Config_CDC_n.h&quot;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//-------- &lt;&lt;&lt; Use Configuration Wizard in Context Menu &gt;&gt;&gt; --------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Configuration defines</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//   &lt;s.17&gt;MAC Address</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;Ethernet MAC Address in text representation</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;Value FF-FF-FF-FF-FF-FF is not allowed,</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;LSB of first byte must be 0 (an ethernet Multicast bit).</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;Default: &quot;1E-30-6C-A2-45-5E&quot;</span></div>
<div class="line"><span class="preprocessor">#define RNDIS_MAC_ADDR    &quot;1E-30-6C-A2-45-5E&quot;           // RNDIS MAC Address</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//   &lt;o.0..5&gt;Maximum number of multicast addresses &lt;1-32&gt;</span></div>
<div class="line"><span class="preprocessor">#define RNDIS_MCAST_NUM   16                            // RNDIS Number of Multicast Addresses supported</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//   &lt;s.32&gt;RNDIS Vendor Description</span></div>
<div class="line"><span class="preprocessor">#define RNDIS_VENDOR_DESC &quot;Keil NIC (USB &lt;-&gt; ETH)&quot;      // RNDIS Vendor Description</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//   &lt;o.0..23&gt;RNDIS Vendor Id Code &lt;0x000000-0xFFFFFF&gt;</span></div>
<div class="line"><span class="preprocessor">#define RNDIS_VENDOR_ID   0xFFFFFF                      // RNDIS three-byte IEEE-registered Vendor Code</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//------------- &lt;&lt;&lt; end of configuration section &gt;&gt;&gt; ---------------------------</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Global functions exported by this module</span></div>
<div class="line">       ARM_ETH_LINK_STATE RNDISn_GetLinkState  (<span class="keywordtype">void</span>);</div>
<div class="line">       int32_t            RNDISn_SendFrame     (<span class="keyword">const</span> uint8_t *frame, uint32_t len);</div>
<div class="line">       int32_t            RNDISn_ReadFrame     (      uint8_t *frame, uint32_t len);</div>
<div class="line">       uint32_t           RNDISn_GetRxFrameSize(<span class="keywordtype">void</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Local functions</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>               MAC_str_to_addr (<span class="keyword">const</span> <span class="keywordtype">char</span> *mac_str, uint8_t *mac_addr);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>               InitVars        (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>               ResetVars       (<span class="keywordtype">void</span>);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Local variables</span></div>
<div class="line"><span class="keyword">static</span> uint32_t           rndis_state;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_LINK_STATE link_state;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span>               link_state_up;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span>               link_state_down;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           packet_filter;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_MAC_ADDR   mac_address;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_MAC_ADDR   mcast_address[RNDIS_MCAST_NUM];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           get_encapsulated_response_len;</div>
<div class="line"><span class="keyword">static</span> uint32_t           get_encapsulated_response_buf[128/4];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           xmit_ok;</div>
<div class="line"><span class="keyword">static</span> uint32_t           rcv_ok;</div>
<div class="line"><span class="keyword">static</span> uint32_t           xmit_error;</div>
<div class="line"><span class="keyword">static</span> uint32_t           rcv_error;</div>
<div class="line"><span class="keyword">static</span> uint32_t           rcv_no_buffer;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           packet_in [(USBD_CDCn_ACM_SEND_BUF_SIZE   +3)/4];</div>
<div class="line"><span class="keyword">static</span> uint32_t           packet_out[(USBD_CDCn_ACM_RECEIVE_BUF_SIZE+3)/4];</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Local functions</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// MAC Address conversion from string</span></div>
<div class="line"><span class="comment">// \param[in]   mac_str   Pointer to wide string.</span></div>
<div class="line"><span class="comment">// \param[out]  mac_addr  Pointer to address.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> MAC_str_to_addr (<span class="keyword">const</span> <span class="keywordtype">char</span> *mac_str, uint8_t *mac_addr) {</div>
<div class="line">  uint8_t  c;</div>
<div class="line">  uint8_t  n;</div>
<div class="line">  uint32_t i, j;</div>
<div class="line">  uint32_t str_len;</div>
<div class="line"> </div>
<div class="line">  str_len = strlen(mac_str);</div>
<div class="line">  j = 0U;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0U; i &lt; str_len; i++) {</div>
<div class="line">    c = (uint8_t)mac_str[i];</div>
<div class="line">    <span class="keywordflow">if</span>         (c == <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;0&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;9&#39;</span>)) {</div>
<div class="line">      n = c - <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;A&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;F&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;A&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;a&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;f&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;a&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      n = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((j &amp; 1U) != 0U) {</div>
<div class="line">      mac_addr[j&gt;&gt;1] |= n;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      mac_addr[j&gt;&gt;1]  = (uint8_t)((uint32_t)n &lt;&lt; 4);</div>
<div class="line">    }</div>
<div class="line">    j++;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize variables</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> InitVars (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  rndis_state      = RNDIS_UNINITIALIZED;</div>
<div class="line">  link_state       = ARM_ETH_LINK_DOWN;</div>
<div class="line"> </div>
<div class="line">  packet_filter    = 0U;</div>
<div class="line"> </div>
<div class="line">  MAC_str_to_addr(RNDIS_MAC_ADDR, (uint8_t *)&amp;mac_address);</div>
<div class="line">  memset((<span class="keywordtype">void</span> *)mcast_address, 0, <span class="keyword">sizeof</span>(mcast_address));</div>
<div class="line"> </div>
<div class="line">  ResetVars();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Reset variables</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ResetVars (<span class="keywordtype">void</span>) {</div>
<div class="line">  link_state_up    = <span class="keyword">false</span>;</div>
<div class="line">  link_state_down  = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  get_encapsulated_response_len = 0U;</div>
<div class="line"> </div>
<div class="line">  xmit_ok          = 0U;</div>
<div class="line">  rcv_ok           = 0U;</div>
<div class="line">  xmit_error       = 0U;</div>
<div class="line">  rcv_error        = 0U;</div>
<div class="line">  rcv_no_buffer    = 0U;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// USB CDC ACM callback global functions</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gae533b6ee1feb71d6210a31f1d83f94e8">USBD_CDCn_ACM_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  InitVars();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga54ad02ac3b5e8dbcc40e5fe440076e39">USBD_CDCn_ACM_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  InitVars();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga3f89d38c6c6bee03e6c3d58c866fe72c">USBD_CDCn_ACM_Reset</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  InitVars();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called upon reception of request send encapsulated command sent by the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   buf           buffer that contains send encapsulated command request.</span></div>
<div class="line"><span class="comment">// \param[in]   len           length of send encapsulated command request.</span></div>
<div class="line"><span class="comment">// \return      true          send encapsulated command request processed.</span></div>
<div class="line"><span class="comment">// \return      false         send encapsulated command request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad7ad5e60775a104cdf3dc36eded23f2d">USBD_CDCn_ACM_SendEncapsulatedCommand</a> (<span class="keyword">const</span> uint8_t *buf, uint16_t len) {</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_INITIALIZE_MSG_t   *ptr_init_msg;</div>
<div class="line">        REMOTE_NDIS_INITIALIZE_CMPLT_t *ptr_init_cmplt;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_HALT_MSG_t         *ptr_halt_msg;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_QUERY_MSG_t        *ptr_query_msg;</div>
<div class="line">        REMOTE_NDIS_QUERY_CMPLT_t      *ptr_query_cmplt;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_SET_MSG_t          *ptr_set_msg;</div>
<div class="line">        REMOTE_NDIS_SET_CMPLT_t        *ptr_set_cmplt;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_RESET_MSG_t        *ptr_reset_msg;</div>
<div class="line">        REMOTE_NDIS_RESET_CMPLT_t      *ptr_reset_cmplt;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_KEEPALIVE_MSG_t    *ptr_keepalive_msg;</div>
<div class="line">        REMOTE_NDIS_KEEPALIVE_CMPLT_t  *ptr_keepalive_cmplt;</div>
<div class="line">        uint32_t                        status, val;</div>
<div class="line">        uint32_t                        i;</div>
<div class="line">        uint32_t                        num, by;</div>
<div class="line">        uint16_t                        msg_type;</div>
<div class="line"> </div>
<div class="line">  (void)len;</div>
<div class="line"> </div>
<div class="line">  msg_type = __UNALIGNED_UINT16_READ(buf);  <span class="comment">// Extract message type of received message</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// In uninitialized state only allowed messages are INITALIZE and HALT</span></div>
<div class="line">  <span class="keywordflow">if</span> ((rndis_state == RNDIS_UNINITIALIZED)     &amp;&amp;</div>
<div class="line">      (msg_type != REMOTE_NDIS_INITIALIZE_MSG) &amp;&amp;</div>
<div class="line">      (msg_type != REMOTE_NDIS_HALT_MSG))       {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (((uint32_t)buf &amp; 3) != 0) {           <span class="comment">// buf has to be 32 bit aligned</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  status = RNDIS_STATUS_SUCCESS;            <span class="comment">// Default message processing status</span></div>
<div class="line">  get_encapsulated_response_len = 0U;       <span class="comment">// Prepare default no response size</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (msg_type) {                       <span class="comment">// MessageType</span></div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_INITIALIZE_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_init_msg = (<span class="keyword">const</span> REMOTE_NDIS_INITIALIZE_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_init_msg-&gt;MessageLength       != <span class="keyword">sizeof</span>(REMOTE_NDIS_INITIALIZE_MSG_t)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_init_msg-&gt;MajorVersion        != RNDIS_MAJOR_VERSION)                  { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_init_msg-&gt;MinorVersion        != RNDIS_MINOR_VERSION)                  { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_init_msg-&gt;MaxTransferSize     != 16384U)                               { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      rndis_state = RNDIS_INITIALIZED;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_init_cmplt = (REMOTE_NDIS_INITIALIZE_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_init_cmplt-&gt;MessageType            = REMOTE_NDIS_INITIALIZE_CMPLT;</div>
<div class="line">      ptr_init_cmplt-&gt;MessageLength          = <span class="keyword">sizeof</span>(REMOTE_NDIS_INITIALIZE_CMPLT_t);</div>
<div class="line">      ptr_init_cmplt-&gt;RequestID              = ptr_init_msg-&gt;RequestID;</div>
<div class="line">      ptr_init_cmplt-&gt;Status                 = status;</div>
<div class="line">      ptr_init_cmplt-&gt;MajorVersion           = RNDIS_MAJOR_VERSION;</div>
<div class="line">      ptr_init_cmplt-&gt;MinorVersion           = RNDIS_MINOR_VERSION;</div>
<div class="line">      ptr_init_cmplt-&gt;DeviceFlags            = RNDIS_DF_CONNECTIONLESS;</div>
<div class="line">      ptr_init_cmplt-&gt;Medium                 = (uint32_t)NdisMedium802_3;</div>
<div class="line">      ptr_init_cmplt-&gt;MaxPacketsPerTransfer  = 1U;</div>
<div class="line">      ptr_init_cmplt-&gt;MaxTransferSize        = USBD_CDCn_ACM_RECEIVE_BUF_SIZE;</div>
<div class="line">      ptr_init_cmplt-&gt;PacketAlignmentFactor  = 2U;</div>
<div class="line">      ptr_init_cmplt-&gt;Reserved[0]            = 0U;</div>
<div class="line">      ptr_init_cmplt-&gt;Reserved[1]            = 0U;</div>
<div class="line">      get_encapsulated_response_len          = ptr_init_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_HALT_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_halt_msg = (<span class="keyword">const</span> REMOTE_NDIS_HALT_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_halt_msg-&gt;MessageLength != <span class="keyword">sizeof</span>(REMOTE_NDIS_HALT_MSG_t)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      rndis_state = RNDIS_UNINITIALIZED;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// This message does not have a response</span></div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_QUERY_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_query_msg = (<span class="keyword">const</span> REMOTE_NDIS_QUERY_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_query_msg-&gt;MessageLength &lt; 28U) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_query_cmplt = (REMOTE_NDIS_QUERY_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_query_cmplt-&gt;MessageType             = REMOTE_NDIS_QUERY_CMPLT;</div>
<div class="line">      ptr_query_cmplt-&gt;RequestID               = ptr_query_msg-&gt;RequestID;</div>
<div class="line">      ptr_query_cmplt-&gt;InformationBufferOffset = 16U;</div>
<div class="line">      <span class="keywordflow">switch</span> (ptr_query_msg-&gt;Oid) {             <span class="comment">// Handle OID</span></div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_SUPPORTED_LIST:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 23U * 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = OID_GEN_SUPPORTED_LIST;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[1]       = OID_GEN_HARDWARE_STATUS;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[2]       = OID_GEN_MEDIA_SUPPORTED;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[3]       = OID_GEN_MEDIA_IN_USE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[4]       = OID_GEN_MAXIMUM_FRAME_SIZE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[5]       = OID_GEN_LINK_SPEED;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[6]       = OID_GEN_TRANSMIT_BLOCK_SIZE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[7]       = OID_GEN_RECEIVE_BLOCK_SIZE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[8]       = OID_GEN_VENDOR_ID;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[9]       = OID_GEN_VENDOR_DESCRIPTION;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[10]      = OID_GEN_CURRENT_PACKET_FILTER;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[11]      = OID_GEN_MAXIMUM_TOTAL_SIZE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[12]      = OID_GEN_MEDIA_CONNECT_STATUS;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[13]      = OID_GEN_PHYSICAL_MEDIUM;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[14]      = OID_GEN_XMIT_OK;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[15]      = OID_GEN_RCV_OK;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[16]      = OID_GEN_XMIT_ERROR;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[17]      = OID_GEN_RCV_ERROR;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[18]      = OID_GEN_RCV_NO_BUFFER;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[19]      = OID_802_3_PERMANENT_ADDRESS;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[20]      = OID_802_3_CURRENT_ADDRESS;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[21]      = OID_802_3_MULTICAST_LIST;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[22]      = OID_802_3_MAXIMUM_LIST_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_HARDWARE_STATUS:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">            ptr_query_cmplt-&gt;OIDInputBuffer[0]     = (uint32_t)NdisHardwareStatusReady;</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            ptr_query_cmplt-&gt;OIDInputBuffer[0]     = (uint32_t)NdisHardwareStatusNotReady;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MEDIA_SUPPORTED:</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MEDIA_IN_USE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = (uint32_t)NdisMedium802_3;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MAXIMUM_FRAME_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = ETH_MTU_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_LINK_SPEED:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = 100000000U / 100U; <span class="comment">// 100 MBit/s</span></div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_TRANSMIT_BLOCK_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = USBD_CDCn_ACM_SEND_BUF_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_RECEIVE_BLOCK_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = USBD_CDCn_ACM_RECEIVE_BUF_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_VENDOR_ID:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = RNDIS_VENDOR_ID;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_VENDOR_DESCRIPTION:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = strlen(RNDIS_VENDOR_DESC) + 1;</div>
<div class="line">          memset((<span class="keywordtype">void</span> *)&amp;ptr_query_cmplt-&gt;OIDInputBuffer[0], 0, ptr_query_cmplt-&gt;InformationBufferLength + 1U);</div>
<div class="line">          memcpy((<span class="keywordtype">void</span> *)&amp;ptr_query_cmplt-&gt;OIDInputBuffer[0], RNDIS_VENDOR_DESC, strlen(RNDIS_VENDOR_DESC));</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_CURRENT_PACKET_FILTER:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          val = 0U;</div>
<div class="line">          <span class="keywordflow">if</span> ((packet_filter &amp; ARM_ETH_MAC_ADDRESS_MULTICAST) != 0U) { val |= RNDIS_FILTER_ALL_MULTICAST; }</div>
<div class="line">          <span class="keywordflow">if</span> ((packet_filter &amp; ARM_ETH_MAC_ADDRESS_BROADCAST) != 0U) { val |= RNDIS_FILTER_BROADCAST;     }</div>
<div class="line">          <span class="keywordflow">if</span> ((packet_filter &amp; ARM_ETH_MAC_ADDRESS_ALL)       != 0U) { val |= RNDIS_FILTER_PROMISCUOUS;   }</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = val;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MAXIMUM_TOTAL_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = 44U + ETH_MAX_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MEDIA_CONNECT_STATUS:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">            ptr_query_cmplt-&gt;OIDInputBuffer[0]     = (uint32_t)NdisMediaStateConnected;</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            ptr_query_cmplt-&gt;OIDInputBuffer[0]     = (uint32_t)NdisMediaStateDisconnected;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_PHYSICAL_MEDIUM:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = (uint32_t)NdisPhysicalMediumUnspecified;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_XMIT_OK:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = xmit_ok;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_RCV_OK:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = rcv_ok;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_XMIT_ERROR:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = xmit_error;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_RCV_ERROR:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = rcv_error;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_RCV_NO_BUFFER:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = rcv_no_buffer;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_PERMANENT_ADDRESS:</div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_CURRENT_ADDRESS:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 6U;</div>
<div class="line">          memcpy((<span class="keywordtype">void</span> *)&amp;ptr_query_cmplt-&gt;OIDInputBuffer[0], &amp;mac_address, <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR));</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_MULTICAST_LIST:</div>
<div class="line">          <span class="keywordflow">for</span> (i = 0U; i &lt; RNDIS_MCAST_NUM; i++) {</div>
<div class="line">            <span class="keywordflow">if</span> ((__UNALIGNED_UINT32_READ(&amp;mcast_address[0]) == 0U) &amp;&amp; </div>
<div class="line">                (__UNALIGNED_UINT16_READ(&amp;mcast_address[4]) == 0U)) { </div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">if</span> (i == 0U) {</div>
<div class="line">            num = 0U;</div>
<div class="line">            ptr_query_cmplt-&gt;InformationBufferOffset = 0U;</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            num = i;</div>
<div class="line">            <span class="keywordflow">if</span> (i &lt; RNDIS_MCAST_NUM) {</div>
<div class="line">              num = i + 1U;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">              num = i;</div>
<div class="line">            }</div>
<div class="line">            memcpy((<span class="keywordtype">void</span> *)&amp;ptr_query_cmplt-&gt;OIDInputBuffer[0], mcast_address, num * <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR));</div>
<div class="line">          }</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = num * <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_MAXIMUM_LIST_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = RNDIS_MCAST_NUM;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferOffset = 0U;</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 0U;</div>
<div class="line">          status = RNDIS_STATUS_NOT_SUPPORTED;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      ptr_query_cmplt-&gt;Status        = status;</div>
<div class="line">      ptr_query_cmplt-&gt;MessageLength = ptr_query_cmplt-&gt;InformationBufferLength + 24U;</div>
<div class="line">      get_encapsulated_response_len  = ptr_query_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_SET_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_set_msg = (<span class="keyword">const</span> REMOTE_NDIS_SET_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_set_msg-&gt;MessageLength &lt; 28U) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_set_cmplt = (REMOTE_NDIS_SET_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_set_cmplt-&gt;MessageType               = REMOTE_NDIS_SET_CMPLT;</div>
<div class="line">      ptr_set_cmplt-&gt;MessageLength             = <span class="keyword">sizeof</span>(REMOTE_NDIS_SET_CMPLT_t);</div>
<div class="line">      ptr_set_cmplt-&gt;RequestID                 = ptr_set_msg-&gt;RequestID;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">switch</span> (ptr_set_msg-&gt;Oid) {               <span class="comment">// Handle OID</span></div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_MULTICAST_LIST:</div>
<div class="line">          by = ptr_set_msg-&gt;InformationBufferLength;</div>
<div class="line">          <span class="keywordflow">if</span> (by &gt; (<span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR) * RNDIS_MCAST_NUM)) {</div>
<div class="line">            by = <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR) * RNDIS_MCAST_NUM;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">if</span> (by &gt; 0U) {</div>
<div class="line">            memcpy(mcast_address, (<span class="keyword">const</span> <span class="keywordtype">void</span> *)&amp;ptr_set_msg-&gt;OIDInputBuffer[0], by);</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_CURRENT_PACKET_FILTER:</div>
<div class="line">          <span class="keywordflow">if</span> ((ptr_set_msg-&gt;InformationBufferLength == 4U) &amp;&amp;</div>
<div class="line">              (ptr_set_msg-&gt;InformationBufferOffset != 0U)) {</div>
<div class="line">            val = __UNALIGNED_UINT32_READ(((<span class="keyword">const</span> uint8_t *)&amp;ptr_set_msg-&gt;RequestID) + ptr_set_msg-&gt;InformationBufferOffset);</div>
<div class="line">            <span class="keywordflow">if</span> (val != 0U) {</div>
<div class="line">              <span class="keywordflow">if</span> ((val &amp; RNDIS_FILTER_ALL_MULTICAST) != 0U) { packet_filter |= ARM_ETH_MAC_ADDRESS_MULTICAST; }</div>
<div class="line">              <span class="keywordflow">if</span> ((val &amp; RNDIS_FILTER_BROADCAST)     != 0U) { packet_filter |= ARM_ETH_MAC_ADDRESS_BROADCAST; }</div>
<div class="line">              <span class="keywordflow">if</span> ((val &amp; RNDIS_FILTER_PROMISCUOUS)   != 0U) { packet_filter |= ARM_ETH_MAC_ADDRESS_ALL;       }</div>
<div class="line">              <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_DOWN) {</div>
<div class="line">                link_state    = ARM_ETH_LINK_UP;</div>
<div class="line">                link_state_up = <span class="keyword">true</span>;</div>
<div class="line">              }</div>
<div class="line">              rndis_state = RNDIS_DATA_INITIALIZED;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">              <span class="keywordflow">if</span> (rndis_state == RNDIS_DATA_INITIALIZED) {</div>
<div class="line">                rndis_state = RNDIS_INITIALIZED;</div>
<div class="line">              }</div>
<div class="line">            }</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            status = RNDIS_STATUS_FAILURE;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">          status = RNDIS_STATUS_NOT_SUPPORTED;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      ptr_set_cmplt-&gt;Status         = status;</div>
<div class="line">      get_encapsulated_response_len = ptr_set_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_RESET_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_reset_msg = (<span class="keyword">const</span> REMOTE_NDIS_RESET_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_reset_msg-&gt;MessageLength != <span class="keyword">sizeof</span>(REMOTE_NDIS_RESET_MSG_t)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      ResetVars();</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_reset_cmplt = (REMOTE_NDIS_RESET_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_reset_cmplt-&gt;MessageType             = REMOTE_NDIS_RESET_CMPLT;</div>
<div class="line">      ptr_reset_cmplt-&gt;MessageLength           = <span class="keyword">sizeof</span>(REMOTE_NDIS_RESET_CMPLT_t);</div>
<div class="line">      ptr_reset_cmplt-&gt;Status                  = status;</div>
<div class="line">      ptr_reset_cmplt-&gt;AddressingReset         = 0U;</div>
<div class="line">      get_encapsulated_response_len            = ptr_reset_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_KEEPALIVE_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_keepalive_msg = (<span class="keyword">const</span> REMOTE_NDIS_KEEPALIVE_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_keepalive_msg-&gt;MessageLength != <span class="keyword">sizeof</span>(REMOTE_NDIS_KEEPALIVE_MSG_t)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_keepalive_cmplt = (REMOTE_NDIS_KEEPALIVE_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_keepalive_cmplt-&gt;MessageType         = REMOTE_NDIS_KEEPALIVE_CMPLT;</div>
<div class="line">      ptr_keepalive_cmplt-&gt;MessageLength       = <span class="keyword">sizeof</span>(REMOTE_NDIS_KEEPALIVE_CMPLT_t);</div>
<div class="line">      ptr_keepalive_cmplt-&gt;RequestID           = ptr_keepalive_msg-&gt;RequestID;</div>
<div class="line">      ptr_keepalive_cmplt-&gt;Status              = status;</div>
<div class="line">      get_encapsulated_response_len            = ptr_keepalive_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (get_encapsulated_response_len != 0U) {</div>
<div class="line">    <span class="comment">// If response is prepared send notification over Interrupt Endpoint</span></div>
<div class="line">    (void)<a class="code" href="group__usbd__cdc_functions__acm__api.html#ga06aa95aa796ce37fcedfc771a0ab074c">USBD_CDC_ACM_Notify_ResponseAvailable</a> (n);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called upon reception of request to get encapsulated response sent by the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   max_len       maximum number of data bytes that USB Host expects to receive</span></div>
<div class="line"><span class="comment">// \param[out]  buf           pointer to buffer containing get encapsulated response to be returned to USB Host.</span></div>
<div class="line"><span class="comment">// \param[out]  len           pointer to number of data bytes to be returned to USB Host.</span></div>
<div class="line"><span class="comment">// \return      true          get encapsulated response request processed.</span></div>
<div class="line"><span class="comment">// \return      false         get encapsulated response request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga944044922bbb14f9f8c638408e621abc">USBD_CDCn_ACM_GetEncapsulatedResponse</a> (uint16_t max_len, uint8_t **buf, uint16_t *len) {</div>
<div class="line">  REMOTE_NDIS_INDICATE_STATUS_MSG_t *ptr_indicate_status_msg;</div>
<div class="line">  uint32_t                           status;</div>
<div class="line"> </div>
<div class="line">  (void)max_len;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (link_state_up || link_state_down) {   <span class="comment">// Generate unsolicited INDICATE STATUS message if link status has changed</span></div>
<div class="line">    <span class="keywordflow">if</span> (link_state_up) {</div>
<div class="line">      status = RNDIS_STATUS_MEDIA_CONNECT;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      status = RNDIS_STATUS_MEDIA_DISCONNECT;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Prepare INDICATE STATUS message</span></div>
<div class="line">    ptr_indicate_status_msg = (REMOTE_NDIS_INDICATE_STATUS_MSG_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">    ptr_indicate_status_msg-&gt;MessageType        = REMOTE_NDIS_INDICATE_STATUS_MSG;</div>
<div class="line">    ptr_indicate_status_msg-&gt;MessageLength      = 20U;</div>
<div class="line">    ptr_indicate_status_msg-&gt;Status             = status;</div>
<div class="line">    ptr_indicate_status_msg-&gt;StatusBufferLength = 0U;</div>
<div class="line">    ptr_indicate_status_msg-&gt;StatusBufferOffset = 0U;</div>
<div class="line">    get_encapsulated_response_len               = 20U;</div>
<div class="line"> </div>
<div class="line">    link_state_up   = <span class="keyword">false</span>;</div>
<div class="line">    link_state_down = <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (get_encapsulated_response_len != 0U) {    <span class="comment">// If response is available return it</span></div>
<div class="line">    *buf = (uint8_t *)get_encapsulated_response_buf;</div>
<div class="line">    *len = (uint16_t) get_encapsulated_response_len;</div>
<div class="line">    get_encapsulated_response_len = 0U;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called when all data was sent</span></div>
<div class="line"><span class="comment">// \return                    none.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga5091a4b29df447b17bc6bbe87b17db96">USBD_CDCn_ACM_DataSent</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called when new data was received</span></div>
<div class="line"><span class="comment">// \param[in]   len           number of bytes available to read.</span></div>
<div class="line"><span class="comment">// \return                    none.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445">USBD_CDCn_ACM_DataReceived</a> (uint32_t len) {</div>
<div class="line">  (void)len;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Global functions exported for Virtual Ethernet driver</span></div>
<div class="line"> </div>
<div class="line">ARM_ETH_LINK_STATE RNDISn_GetLinkState (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="keywordflow">if</span> (rndis_state == RNDIS_DATA_INITIALIZED) {</div>
<div class="line">    <span class="keywordflow">return</span> ARM_ETH_LINK_UP;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> ARM_ETH_LINK_DOWN;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int32_t RNDISn_SendFrame (<span class="keyword">const</span> uint8_t *frame, uint32_t len) {</div>
<div class="line">  REMOTE_NDIS_PACKET_MSG_t *ptr_packet_msg;</div>
<div class="line">   int32_t                  usb_cdc_acm_status;</div>
<div class="line"> </div>
<div class="line">  ptr_packet_msg = (REMOTE_NDIS_PACKET_MSG_t *)((<span class="keywordtype">void</span> *)packet_in);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ((rndis_state == RNDIS_DATA_INITIALIZED) &amp;&amp;</div>
<div class="line">      (len &gt;= ETH_MIN_SIZE)                   &amp;&amp;</div>
<div class="line">      (len &lt;= ETH_MAX_SIZE))                   {</div>
<div class="line">    memcpy((<span class="keywordtype">void</span> *)&amp;ptr_packet_msg-&gt;PayLoad[0], frame, len);</div>
<div class="line">    ptr_packet_msg-&gt;MessageType              = REMOTE_NDIS_PACKET_MSG;</div>
<div class="line">    ptr_packet_msg-&gt;MessageLength            = len + 44U;</div>
<div class="line">    ptr_packet_msg-&gt;DataOffset               = 36U;</div>
<div class="line">    ptr_packet_msg-&gt;DataLength               = len;</div>
<div class="line">    ptr_packet_msg-&gt;OutOfBandDataOffset      = 0U;</div>
<div class="line">    ptr_packet_msg-&gt;OutOfBandDataLength      = 0U;</div>
<div class="line">    ptr_packet_msg-&gt;NumOutOfBandDataElements = 0U;</div>
<div class="line">    ptr_packet_msg-&gt;PerPacketInfoOffset      = 0U;</div>
<div class="line">    ptr_packet_msg-&gt;PerPacketInfoLength      = 0U;</div>
<div class="line">    ptr_packet_msg-&gt;Reserved[0]              = 0U;</div>
<div class="line">    ptr_packet_msg-&gt;Reserved[1]              = 0U;</div>
<div class="line">    usb_cdc_acm_status = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaf3ced4ece3f150bb3ce1d2c12babeb95">USBD_CDC_ACM_WriteData</a> (n, (<span class="keyword">const</span> uint8_t *)ptr_packet_msg, (int32_t)ptr_packet_msg-&gt;MessageLength);</div>
<div class="line">    <span class="keywordflow">if</span> (usb_cdc_acm_status == (int32_t)ptr_packet_msg-&gt;MessageLength) {</div>
<div class="line">      rcv_ok++;</div>
<div class="line">      <span class="keywordflow">return</span> ARM_DRIVER_OK;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (usb_cdc_acm_status &lt; 0) {</div>
<div class="line">      rcv_error++;</div>
<div class="line">      <span class="keywordflow">return</span> ARM_DRIVER_ERROR;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (usb_cdc_acm_status == 0) {</div>
<div class="line">      <span class="keywordflow">return</span> ARM_DRIVER_ERROR_BUSY;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> ARM_DRIVER_ERROR;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">int32_t RNDISn_ReadFrame (uint8_t *frame, uint32_t len) {</div>
<div class="line">  REMOTE_NDIS_PACKET_MSG_t *ptr_packet_msg;</div>
<div class="line">  uint32_t                  data_len;</div>
<div class="line">   int32_t                  usb_cdc_acm_status;</div>
<div class="line"> </div>
<div class="line">  ptr_packet_msg = (REMOTE_NDIS_PACKET_MSG_t *)((<span class="keywordtype">void</span> *)packet_out);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> ((rndis_state == RNDIS_DATA_INITIALIZED) &amp;&amp;</div>
<div class="line">      (len &gt;= ETH_MIN_SIZE)                   &amp;&amp;</div>
<div class="line">      (len &lt;= ETH_MAX_SIZE))                   {</div>
<div class="line">    usb_cdc_acm_status = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04">USBD_CDC_ACM_ReadData</a> (n, (uint8_t *)ptr_packet_msg, USBD_CDCn_ACM_RECEIVE_BUF_SIZE);</div>
<div class="line">    <span class="keywordflow">if</span> ((usb_cdc_acm_status != 0) &amp;&amp; (usb_cdc_acm_status == (int32_t)ptr_packet_msg-&gt;MessageLength)) {</div>
<div class="line">      data_len = len;</div>
<div class="line">      <span class="keywordflow">if</span> (data_len &gt; ptr_packet_msg-&gt;DataLength) {</div>
<div class="line">        data_len = ptr_packet_msg-&gt;DataLength;</div>
<div class="line">      }</div>
<div class="line">      memcpy(frame, (<span class="keyword">const</span> <span class="keywordtype">void</span> *)&amp;ptr_packet_msg-&gt;PayLoad[0], data_len);</div>
<div class="line">      xmit_ok++;</div>
<div class="line">      <span class="keywordflow">return</span> (int32_t)data_len;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (usb_cdc_acm_status &lt; 0) {</div>
<div class="line">      xmit_error++;</div>
<div class="line">      <span class="keywordflow">return</span> ARM_DRIVER_ERROR;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (usb_cdc_acm_status == 0) {</div>
<div class="line">      <span class="keywordflow">return</span> ARM_DRIVER_ERROR_BUSY;</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line">uint32_t RNDISn_GetRxFrameSize (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint32_t avail_data_len;</div>
<div class="line"> </div>
<div class="line">  avail_data_len = (uint32_t)<a class="code" href="group__usbd__cdc_functions__acm__api.html#gaa47cae7099ed7985469575d21fac7bb8">USBD_CDC_ACM_DataAvailable</a> (n);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (avail_data_len &gt; 44U) {</div>
<div class="line">    avail_data_len -= 44U;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> avail_data_len;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_CDC_ACM_RNDIS_ETH_UCT"></a><b>User Code Template USBD_User_CDC_ACM_RNDIS_ETH_n.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (ACM) Device that can be used as a USB &lt;-&gt; Ethernet bridge using the RNDIS protocol.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:CDC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2018-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_ACM_RNDIS_ETH_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Abstract Control Model (ACM)</span></div>
<div class="line"><span class="comment"> *          Remote Network Driver Interface Specification (RNDIS)</span></div>
<div class="line"><span class="comment"> *          User Module for an USB CDC ACM RNDIS Ethernet Bridge</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.0.4</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;RTE_Components.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH_MAC.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH_PHY.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBD_Config_CDC_n.h&quot;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">//-------- &lt;&lt;&lt; Use Configuration Wizard in Context Menu &gt;&gt;&gt; --------------------</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// Configuration defines</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">//   &lt;o&gt;Ethernet MAC Driver Index &lt;0-255&gt;</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;Select Ethernet MAC driver index</span></div>
<div class="line"><span class="preprocessor">#define ETH_MAC_NUM       0</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//   &lt;o&gt;Ethernet PHY Driver Index &lt;0-255&gt;</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;Select Ethernet PHY driver index</span></div>
<div class="line"><span class="preprocessor">#define ETH_PHY_NUM       0</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//   &lt;s.17&gt;MAC Address</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;Ethernet MAC Address in text representation</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;Value FF-FF-FF-FF-FF-FF is not allowed,</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;LSB of first byte must be 0 (an ethernet Multicast bit).</span></div>
<div class="line"><span class="comment">//     &lt;i&gt;Default: &quot;1E-30-6C-A2-45-5E&quot;</span></div>
<div class="line"><span class="preprocessor">#define RNDIS_MAC_ADDR    &quot;1E-30-6C-A2-45-5E&quot;           // RNDIS MAC Address</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//   &lt;o.0..5&gt;Maximum number of multicast addresses &lt;1-32&gt;</span></div>
<div class="line"><span class="preprocessor">#define RNDIS_MCAST_NUM   16                            // RNDIS Number of Multicast Addresses supported</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//   &lt;s.32&gt;RNDIS Vendor Description</span></div>
<div class="line"><span class="preprocessor">#define RNDIS_VENDOR_DESC &quot;Keil NIC (USB &lt;-&gt; ETH)&quot;      // RNDIS Vendor Description</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//   &lt;o.0..23&gt;RNDIS Vendor Id Code &lt;0x000000-0xFFFFFF&gt;</span></div>
<div class="line"><span class="preprocessor">#define RNDIS_VENDOR_ID   0xFFFFFF                      // RNDIS three-byte IEEE-registered Vendor Code</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">//------------- &lt;&lt;&lt; end of configuration section &gt;&gt;&gt; ---------------------------</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> ARM_DRIVER_ETH_MAC ARM_Driver_ETH_MAC_(ETH_MAC_NUM);</div>
<div class="line"><span class="keyword">extern</span> ARM_DRIVER_ETH_PHY ARM_Driver_ETH_PHY_(ETH_PHY_NUM);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ARM_DRIVER_ETH_MAC *EthMac = &amp;ARM_Driver_ETH_MAC_(ETH_MAC_NUM);</div>
<div class="line"><span class="keyword">static</span> ARM_DRIVER_ETH_PHY *EthPhy = &amp;ARM_Driver_ETH_PHY_(ETH_PHY_NUM);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Local functions</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>               MAC_str_to_addr (<span class="keyword">const</span> <span class="keywordtype">char</span> *mac_str, uint8_t *mac_addr);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>               InitVars        (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>               ResetVars       (<span class="keywordtype">void</span>);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span>               EthMac_Notify   (uint32_t event);</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Local variables</span></div>
<div class="line"><span class="keyword">static</span> uint32_t           rndis_state;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_LINK_STATE link_state;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_LINK_INFO  link_info;</div>
<div class="line"><span class="keyword">static</span> uint32_t           link_speed;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span>               link_state_up;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span>               link_state_down;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           packet_filter;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_MAC_ADDR   mac_address;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_MAC_ADDR   mcast_address[RNDIS_MCAST_NUM];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           get_encapsulated_response_len;</div>
<div class="line"><span class="keyword">static</span> uint32_t           get_encapsulated_response_buf[128/4];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           xmit_ok;</div>
<div class="line"><span class="keyword">static</span> uint32_t           rcv_ok;</div>
<div class="line"><span class="keyword">static</span> uint32_t           xmit_error;</div>
<div class="line"><span class="keyword">static</span> uint32_t           rcv_error;</div>
<div class="line"><span class="keyword">static</span> uint32_t           rcv_no_buffer;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           packet_in [(USBD_CDCn_ACM_SEND_BUF_SIZE   +3)/4];</div>
<div class="line"><span class="keyword">static</span> uint32_t           packet_out[(USBD_CDCn_ACM_RECEIVE_BUF_SIZE+3)/4];</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Threads</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> ThreadConnection (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ThreadDataIN     (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ThreadDataOUT    (<span class="keywordtype">void</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> osRtxThread_t      thread_cb_mem_connection           __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t           thread_stack_mem_connection[512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t      thread_cb_mem_data_in              __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t           thread_stack_mem_data_in   [512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t      thread_cb_mem_data_out             __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t           thread_stack_mem_data_out  [512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t thread_attr_connection = {</div>
<div class="line">  <span class="stringliteral">&quot;ThreadConnection&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;thread_cb_mem_connection,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;thread_stack_mem_connection[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t thread_attr_data_in = {</div>
<div class="line">  <span class="stringliteral">&quot;ThreadDataIN&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;thread_cb_mem_data_in,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;thread_stack_mem_data_in[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t thread_attr_data_out = {</div>
<div class="line">  <span class="stringliteral">&quot;ThreadDataOUT&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;thread_cb_mem_data_out,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;thread_stack_mem_data_out[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> ThreadConnection (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ThreadDataIN     (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ThreadDataOUT    (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_ThreadConnection;</div>
<div class="line">osThreadDef(ThreadConnection, osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_ThreadDataIN;</div>
<div class="line">osThreadDef(ThreadDataIN,  osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_ThreadDataOUT;</div>
<div class="line">osThreadDef(ThreadDataOUT, osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *thread_id_Connection;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *thread_id_DataIN;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *thread_id_DataOUT;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// MAC Address conversion from string</span></div>
<div class="line"><span class="comment">// \param[in]   mac_str   Pointer to wide string.</span></div>
<div class="line"><span class="comment">// \param[out]  mac_addr  Pointer to address.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> MAC_str_to_addr (<span class="keyword">const</span> <span class="keywordtype">char</span> *mac_str, uint8_t *mac_addr) {</div>
<div class="line">  uint8_t  c;</div>
<div class="line">  uint8_t  n;</div>
<div class="line">  uint32_t i, j;</div>
<div class="line">  uint32_t str_len;</div>
<div class="line"> </div>
<div class="line">  str_len = strlen(mac_str);</div>
<div class="line">  j = 0U;</div>
<div class="line">  <span class="keywordflow">for</span> (i = 0U; i &lt; str_len; i++) {</div>
<div class="line">    c = (uint8_t)mac_str[i];</div>
<div class="line">    <span class="keywordflow">if</span>         (c == <span class="charliteral">&#39;-&#39;</span>) {</div>
<div class="line">      <span class="keywordflow">continue</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;0&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;9&#39;</span>)) {</div>
<div class="line">      n = c - <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;A&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;F&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;A&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;a&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;f&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;a&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      n = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((j &amp; 1U) != 0U) {</div>
<div class="line">      mac_addr[j&gt;&gt;1] |= n;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      mac_addr[j&gt;&gt;1]  = (uint8_t)((uint32_t)n &lt;&lt; 4);</div>
<div class="line">    }</div>
<div class="line">    j++;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize variables</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> InitVars (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  rndis_state      = RNDIS_UNINITIALIZED;</div>
<div class="line">  link_state       = ARM_ETH_LINK_DOWN;</div>
<div class="line">  link_info.speed  = 0U;</div>
<div class="line">  link_info.duplex = 0U;</div>
<div class="line">  link_speed       = 0U;</div>
<div class="line"> </div>
<div class="line">  packet_filter    = 0U;</div>
<div class="line"> </div>
<div class="line">  memset((<span class="keywordtype">void</span> *)mcast_address, 0, <span class="keyword">sizeof</span>(mcast_address));</div>
<div class="line"> </div>
<div class="line">  ResetVars();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Reset variables</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ResetVars (<span class="keywordtype">void</span>) {</div>
<div class="line">  link_state_up    = <span class="keyword">false</span>;</div>
<div class="line">  link_state_down  = <span class="keyword">false</span>;</div>
<div class="line"> </div>
<div class="line">  get_encapsulated_response_len = 0U;</div>
<div class="line"> </div>
<div class="line">  xmit_ok          = 0U;</div>
<div class="line">  rcv_ok           = 0U;</div>
<div class="line">  xmit_error       = 0U;</div>
<div class="line">  rcv_error        = 0U;</div>
<div class="line">  rcv_no_buffer    = 0U;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Initialize Ethernet (MAC and PHY) Interface</span></div>
<div class="line"><span class="comment">// \return      true    initialization succeeded.</span></div>
<div class="line"><span class="comment">// \return      false   initialization failed.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">bool</span> ENET_Initialize (<span class="keywordtype">void</span>) {</div>
<div class="line">  ARM_ETH_MAC_CAPABILITIES eth_capabilities;</div>
<div class="line"> </div>
<div class="line">  packet_filter   = ARM_ETH_MAC_ADDRESS_BROADCAST;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize Media Access Controller</span></div>
<div class="line">  eth_capabilities = EthMac-&gt;GetCapabilities();</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (EthMac-&gt;Initialize(EthMac_Notify)    != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  <span class="keywordflow">if</span> (EthMac-&gt;PowerControl(ARM_POWER_FULL) != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (eth_capabilities.mac_address != 0U) {</div>
<div class="line">    <span class="comment">// Hardware provided MAC address</span></div>
<div class="line">    <span class="keywordflow">if</span> (EthMac-&gt;GetMacAddress(&amp;mac_address) != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  } <span class="keywordflow">else</span> {</div>
<div class="line">    <span class="comment">// MAC address defined as ETH_MAC_ADDR string</span></div>
<div class="line">    MAC_str_to_addr(RNDIS_MAC_ADDR, (uint8_t *)&amp;mac_address);</div>
<div class="line">    <span class="keywordflow">if</span> (EthMac-&gt;SetMacAddress(&amp;mac_address) != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize Physical Media Interface</span></div>
<div class="line">  <span class="keywordflow">if</span> (EthPhy-&gt;Initialize(EthMac-&gt;PHY_Read, EthMac-&gt;PHY_Write) != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  <span class="keywordflow">if</span> (EthPhy-&gt;PowerControl(ARM_POWER_FULL)                    != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  <span class="keywordflow">if</span> (EthPhy-&gt;SetInterface(eth_capabilities.media_interface)  != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  <span class="keywordflow">if</span> (EthPhy-&gt;SetMode(ARM_ETH_PHY_AUTO_NEGOTIATE)             != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create Threads</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  thread_id_Connection = osThreadNew(ThreadConnection, NULL, &amp;thread_attr_connection);</div>
<div class="line">  thread_id_DataIN     = osThreadNew(ThreadDataIN,     NULL, &amp;thread_attr_data_in);</div>
<div class="line">  thread_id_DataOUT    = osThreadNew(ThreadDataOUT,    NULL, &amp;thread_attr_data_out);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  thread_id_Connection = osThreadCreate(osThread(ThreadConnection), NULL);</div>
<div class="line">  thread_id_DataIN     = osThreadCreate(osThread(ThreadDataIN),     NULL);</div>
<div class="line">  thread_id_DataOUT    = osThreadCreate(osThread(ThreadDataOUT),    NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">  <span class="comment">// Set initial signal to Connection thread to check for current connection</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osThreadFlagsSet(thread_id_Connection, 1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osSignalSet(thread_id_Connection, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Uninitialize Ethernet (MAC and PHY) Interface</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> ENET_Uninitialize (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  packet_filter = ARM_ETH_MAC_ADDRESS_BROADCAST;</div>
<div class="line"> </div>
<div class="line">  (void)EthMac-&gt;SetMacAddress(&amp;mac_address);</div>
<div class="line">  (void)EthMac-&gt;SetAddressFilter(NULL, 0);</div>
<div class="line">  (void)EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                       (uint32_t)(link_info.speed                           ) |</div>
<div class="line">                       (uint32_t)(link_info.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                        packet_filter);</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Terminate threads</span></div>
<div class="line">  <span class="keywordflow">if</span> (thread_id_Connection != NULL) { (void)osThreadTerminate(thread_id_Connection); thread_id_Connection = NULL; }</div>
<div class="line">  <span class="keywordflow">if</span> (thread_id_DataIN     != NULL) { (void)osThreadTerminate(thread_id_DataIN);     thread_id_DataIN     = NULL; }</div>
<div class="line">  <span class="keywordflow">if</span> (thread_id_DataOUT    != NULL) { (void)osThreadTerminate(thread_id_DataOUT);    thread_id_DataOUT    = NULL; }</div>
<div class="line"> </div>
<div class="line">  (void)EthPhy-&gt;PowerControl(ARM_POWER_OFF);</div>
<div class="line">  (void)EthPhy-&gt;Uninitialize();</div>
<div class="line"> </div>
<div class="line">  (void)EthMac-&gt;PowerControl(ARM_POWER_OFF);</div>
<div class="line">  (void)EthMac-&gt;Uninitialize();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gae533b6ee1feb71d6210a31f1d83f94e8">USBD_CDCn_ACM_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  InitVars();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (ACM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga54ad02ac3b5e8dbcc40e5fe440076e39">USBD_CDCn_ACM_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  InitVars();</div>
<div class="line">  ENET_Uninitialize();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga3f89d38c6c6bee03e6c3d58c866fe72c">USBD_CDCn_ACM_Reset</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  InitVars();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called upon reception of request send encapsulated command sent by the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   buf           buffer that contains send encapsulated command request.</span></div>
<div class="line"><span class="comment">// \param[in]   len           length of send encapsulated command request.</span></div>
<div class="line"><span class="comment">// \return      true          send encapsulated command request processed.</span></div>
<div class="line"><span class="comment">// \return      false         send encapsulated command request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad7ad5e60775a104cdf3dc36eded23f2d">USBD_CDCn_ACM_SendEncapsulatedCommand</a> (<span class="keyword">const</span> uint8_t *buf, uint16_t len) {</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_INITIALIZE_MSG_t   *ptr_init_msg;</div>
<div class="line">        REMOTE_NDIS_INITIALIZE_CMPLT_t *ptr_init_cmplt;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_HALT_MSG_t         *ptr_halt_msg;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_QUERY_MSG_t        *ptr_query_msg;</div>
<div class="line">        REMOTE_NDIS_QUERY_CMPLT_t      *ptr_query_cmplt;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_SET_MSG_t          *ptr_set_msg;</div>
<div class="line">        REMOTE_NDIS_SET_CMPLT_t        *ptr_set_cmplt;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_RESET_MSG_t        *ptr_reset_msg;</div>
<div class="line">        REMOTE_NDIS_RESET_CMPLT_t      *ptr_reset_cmplt;</div>
<div class="line">  <span class="keyword">const</span> REMOTE_NDIS_KEEPALIVE_MSG_t    *ptr_keepalive_msg;</div>
<div class="line">        REMOTE_NDIS_KEEPALIVE_CMPLT_t  *ptr_keepalive_cmplt;</div>
<div class="line">        uint32_t                        status, val;</div>
<div class="line">        uint32_t                        i;</div>
<div class="line">        uint32_t                        num, by;</div>
<div class="line">        uint16_t                        msg_type;</div>
<div class="line"> </div>
<div class="line">  (void)len;</div>
<div class="line"> </div>
<div class="line">  msg_type = __UNALIGNED_UINT16_READ(buf);  <span class="comment">// Extract message type of received message</span></div>
<div class="line"> </div>
<div class="line">  <span class="comment">// In uninitialized state only allowed messages are INITALIZE and HALT</span></div>
<div class="line">  <span class="keywordflow">if</span> ((rndis_state == RNDIS_UNINITIALIZED)     &amp;&amp;</div>
<div class="line">      (msg_type != REMOTE_NDIS_INITIALIZE_MSG) &amp;&amp;</div>
<div class="line">      (msg_type != REMOTE_NDIS_HALT_MSG))       {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (((uint32_t)buf &amp; 3) != 0) {           <span class="comment">// buf has to be 32 bit aligned</span></div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  status = RNDIS_STATUS_SUCCESS;            <span class="comment">// Default message processing status</span></div>
<div class="line">  get_encapsulated_response_len = 0U;       <span class="comment">// Prepare default no response size</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (msg_type) {                       <span class="comment">// MessageType</span></div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_INITIALIZE_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_init_msg = (<span class="keyword">const</span> REMOTE_NDIS_INITIALIZE_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_init_msg-&gt;MessageLength       != <span class="keyword">sizeof</span>(REMOTE_NDIS_INITIALIZE_MSG_t)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_init_msg-&gt;MajorVersion        != RNDIS_MAJOR_VERSION)                  { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_init_msg-&gt;MinorVersion        != RNDIS_MINOR_VERSION)                  { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_init_msg-&gt;MaxTransferSize     != 16384U)                               { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      (void)ENET_Initialize ();</div>
<div class="line">      rndis_state = RNDIS_INITIALIZED;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_init_cmplt = (REMOTE_NDIS_INITIALIZE_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_init_cmplt-&gt;MessageType            = REMOTE_NDIS_INITIALIZE_CMPLT;</div>
<div class="line">      ptr_init_cmplt-&gt;MessageLength          = <span class="keyword">sizeof</span>(REMOTE_NDIS_INITIALIZE_CMPLT_t);</div>
<div class="line">      ptr_init_cmplt-&gt;RequestID              = ptr_init_msg-&gt;RequestID;</div>
<div class="line">      ptr_init_cmplt-&gt;Status                 = status;</div>
<div class="line">      ptr_init_cmplt-&gt;MajorVersion           = RNDIS_MAJOR_VERSION;</div>
<div class="line">      ptr_init_cmplt-&gt;MinorVersion           = RNDIS_MINOR_VERSION;</div>
<div class="line">      ptr_init_cmplt-&gt;DeviceFlags            = RNDIS_DF_CONNECTIONLESS;</div>
<div class="line">      ptr_init_cmplt-&gt;Medium                 = (uint32_t)NdisMedium802_3;</div>
<div class="line">      ptr_init_cmplt-&gt;MaxPacketsPerTransfer  = 1U;</div>
<div class="line">      ptr_init_cmplt-&gt;MaxTransferSize        = USBD_CDCn_ACM_RECEIVE_BUF_SIZE;</div>
<div class="line">      ptr_init_cmplt-&gt;PacketAlignmentFactor  = 2U;</div>
<div class="line">      ptr_init_cmplt-&gt;Reserved[0]            = 0U;</div>
<div class="line">      ptr_init_cmplt-&gt;Reserved[1]            = 0U;</div>
<div class="line">      get_encapsulated_response_len          = ptr_init_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_HALT_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_halt_msg = (<span class="keyword">const</span> REMOTE_NDIS_HALT_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_halt_msg-&gt;MessageLength != <span class="keyword">sizeof</span>(REMOTE_NDIS_HALT_MSG_t)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      (void)ENET_Uninitialize ();</div>
<div class="line">      rndis_state = RNDIS_UNINITIALIZED;</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// This message does not have a response</span></div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_QUERY_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_query_msg = (<span class="keyword">const</span> REMOTE_NDIS_QUERY_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_query_msg-&gt;MessageLength &lt; 28U) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_query_cmplt = (REMOTE_NDIS_QUERY_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_query_cmplt-&gt;MessageType             = REMOTE_NDIS_QUERY_CMPLT;</div>
<div class="line">      ptr_query_cmplt-&gt;RequestID               = ptr_query_msg-&gt;RequestID;</div>
<div class="line">      ptr_query_cmplt-&gt;InformationBufferOffset = 16U;</div>
<div class="line">      <span class="keywordflow">switch</span> (ptr_query_msg-&gt;Oid) {             <span class="comment">// Handle OID</span></div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_SUPPORTED_LIST:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 23U * 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = OID_GEN_SUPPORTED_LIST;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[1]       = OID_GEN_HARDWARE_STATUS;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[2]       = OID_GEN_MEDIA_SUPPORTED;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[3]       = OID_GEN_MEDIA_IN_USE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[4]       = OID_GEN_MAXIMUM_FRAME_SIZE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[5]       = OID_GEN_LINK_SPEED;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[6]       = OID_GEN_TRANSMIT_BLOCK_SIZE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[7]       = OID_GEN_RECEIVE_BLOCK_SIZE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[8]       = OID_GEN_VENDOR_ID;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[9]       = OID_GEN_VENDOR_DESCRIPTION;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[10]      = OID_GEN_CURRENT_PACKET_FILTER;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[11]      = OID_GEN_MAXIMUM_TOTAL_SIZE;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[12]      = OID_GEN_MEDIA_CONNECT_STATUS;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[13]      = OID_GEN_PHYSICAL_MEDIUM;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[14]      = OID_GEN_XMIT_OK;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[15]      = OID_GEN_RCV_OK;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[16]      = OID_GEN_XMIT_ERROR;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[17]      = OID_GEN_RCV_ERROR;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[18]      = OID_GEN_RCV_NO_BUFFER;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[19]      = OID_802_3_PERMANENT_ADDRESS;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[20]      = OID_802_3_CURRENT_ADDRESS;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[21]      = OID_802_3_MULTICAST_LIST;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[22]      = OID_802_3_MAXIMUM_LIST_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_HARDWARE_STATUS:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">            ptr_query_cmplt-&gt;OIDInputBuffer[0]     = (uint32_t)NdisHardwareStatusReady;</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            ptr_query_cmplt-&gt;OIDInputBuffer[0]     = (uint32_t)NdisHardwareStatusNotReady;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MEDIA_SUPPORTED:</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MEDIA_IN_USE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = (uint32_t)NdisMedium802_3;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MAXIMUM_FRAME_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = ETH_MTU_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_LINK_SPEED:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = link_speed / 100U;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_TRANSMIT_BLOCK_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = USBD_CDCn_ACM_SEND_BUF_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_RECEIVE_BLOCK_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = USBD_CDCn_ACM_RECEIVE_BUF_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_VENDOR_ID:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = RNDIS_VENDOR_ID;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_VENDOR_DESCRIPTION:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = strlen(RNDIS_VENDOR_DESC) + 1;</div>
<div class="line">          memset((<span class="keywordtype">void</span> *)&amp;ptr_query_cmplt-&gt;OIDInputBuffer[0], 0, ptr_query_cmplt-&gt;InformationBufferLength + 1U);</div>
<div class="line">          memcpy((<span class="keywordtype">void</span> *)&amp;ptr_query_cmplt-&gt;OIDInputBuffer[0], RNDIS_VENDOR_DESC, strlen(RNDIS_VENDOR_DESC));</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_CURRENT_PACKET_FILTER:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          val = 0U;</div>
<div class="line">          <span class="keywordflow">if</span> ((packet_filter &amp; ARM_ETH_MAC_ADDRESS_MULTICAST) != 0U) { val |= RNDIS_FILTER_ALL_MULTICAST; }</div>
<div class="line">          <span class="keywordflow">if</span> ((packet_filter &amp; ARM_ETH_MAC_ADDRESS_BROADCAST) != 0U) { val |= RNDIS_FILTER_BROADCAST;     }</div>
<div class="line">          <span class="keywordflow">if</span> ((packet_filter &amp; ARM_ETH_MAC_ADDRESS_ALL)       != 0U) { val |= RNDIS_FILTER_PROMISCUOUS;   }</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = val;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MAXIMUM_TOTAL_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = 44U + ETH_MAX_SIZE;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_MEDIA_CONNECT_STATUS:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">            ptr_query_cmplt-&gt;OIDInputBuffer[0]     = (uint32_t)NdisMediaStateConnected;</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            ptr_query_cmplt-&gt;OIDInputBuffer[0]     = (uint32_t)NdisMediaStateDisconnected;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_PHYSICAL_MEDIUM:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = (uint32_t)NdisPhysicalMediumUnspecified;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_XMIT_OK:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = xmit_ok;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_RCV_OK:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = rcv_ok;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_XMIT_ERROR:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = xmit_error;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_RCV_ERROR:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = rcv_error;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_RCV_NO_BUFFER:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = rcv_no_buffer;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_PERMANENT_ADDRESS:</div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_CURRENT_ADDRESS:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 6U;</div>
<div class="line">          memcpy((<span class="keywordtype">void</span> *)&amp;ptr_query_cmplt-&gt;OIDInputBuffer[0], &amp;mac_address, <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR));</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_MULTICAST_LIST:</div>
<div class="line">          <span class="keywordflow">for</span> (i = 0U; i &lt; RNDIS_MCAST_NUM; i++) {</div>
<div class="line">            <span class="keywordflow">if</span> ((__UNALIGNED_UINT32_READ(&amp;mcast_address[0]) == 0U) &amp;&amp; </div>
<div class="line">                (__UNALIGNED_UINT16_READ(&amp;mcast_address[4]) == 0U)) { </div>
<div class="line">              <span class="keywordflow">break</span>;</div>
<div class="line">            }</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">if</span> (i == 0U) {</div>
<div class="line">            num = 0U;</div>
<div class="line">            ptr_query_cmplt-&gt;InformationBufferOffset = 0U;</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            num = i;</div>
<div class="line">            <span class="keywordflow">if</span> (i &lt; RNDIS_MCAST_NUM) {</div>
<div class="line">              num = i + 1U;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">              num = i;</div>
<div class="line">            }</div>
<div class="line">            memcpy((<span class="keywordtype">void</span> *)&amp;ptr_query_cmplt-&gt;OIDInputBuffer[0], mcast_address, num * <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR));</div>
<div class="line">          }</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = num * <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR);</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_MAXIMUM_LIST_SIZE:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 4U;</div>
<div class="line">          ptr_query_cmplt-&gt;OIDInputBuffer[0]       = RNDIS_MCAST_NUM;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferOffset = 0U;</div>
<div class="line">          ptr_query_cmplt-&gt;InformationBufferLength = 0U;</div>
<div class="line">          status = RNDIS_STATUS_NOT_SUPPORTED;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      ptr_query_cmplt-&gt;Status        = status;</div>
<div class="line">      ptr_query_cmplt-&gt;MessageLength = ptr_query_cmplt-&gt;InformationBufferLength + 24U;</div>
<div class="line">      get_encapsulated_response_len  = ptr_query_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_SET_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_set_msg = (<span class="keyword">const</span> REMOTE_NDIS_SET_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_set_msg-&gt;MessageLength &lt; 28U) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_set_cmplt = (REMOTE_NDIS_SET_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_set_cmplt-&gt;MessageType               = REMOTE_NDIS_SET_CMPLT;</div>
<div class="line">      ptr_set_cmplt-&gt;MessageLength             = <span class="keyword">sizeof</span>(REMOTE_NDIS_SET_CMPLT_t);</div>
<div class="line">      ptr_set_cmplt-&gt;RequestID                 = ptr_set_msg-&gt;RequestID;</div>
<div class="line"> </div>
<div class="line">      <span class="keywordflow">switch</span> (ptr_set_msg-&gt;Oid) {               <span class="comment">// Handle OID</span></div>
<div class="line">        <span class="keywordflow">case</span> OID_802_3_MULTICAST_LIST:</div>
<div class="line">          by = ptr_set_msg-&gt;InformationBufferLength;</div>
<div class="line">          <span class="keywordflow">if</span> (by &gt; (<span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR) * RNDIS_MCAST_NUM)) {</div>
<div class="line">            by = <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR) * RNDIS_MCAST_NUM;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">if</span> (by &gt; 0U) {</div>
<div class="line">            memcpy(mcast_address, (<span class="keyword">const</span> <span class="keywordtype">void</span> *)&amp;ptr_set_msg-&gt;OIDInputBuffer[0], by);</div>
<div class="line">            num = by / <span class="keyword">sizeof</span>(ARM_ETH_MAC_ADDR);</div>
<div class="line">            <span class="keywordflow">if</span> (EthMac-&gt;SetAddressFilter(mcast_address, num) != ARM_DRIVER_OK) {</div>
<div class="line">              status = RNDIS_STATUS_FAILURE;</div>
<div class="line">            }</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> OID_GEN_CURRENT_PACKET_FILTER:</div>
<div class="line">          <span class="keywordflow">if</span> ((ptr_set_msg-&gt;InformationBufferLength == 4U) &amp;&amp;</div>
<div class="line">              (ptr_set_msg-&gt;InformationBufferOffset != 0U)) {</div>
<div class="line">            val = __UNALIGNED_UINT32_READ(((<span class="keyword">const</span> uint8_t *)&amp;ptr_set_msg-&gt;RequestID) + ptr_set_msg-&gt;InformationBufferOffset);</div>
<div class="line">            <span class="keywordflow">if</span> (val != 0U) {</div>
<div class="line">              <span class="keywordflow">if</span> ((val &amp; RNDIS_FILTER_ALL_MULTICAST) != 0U) { packet_filter |= ARM_ETH_MAC_ADDRESS_MULTICAST; }</div>
<div class="line">              <span class="keywordflow">if</span> ((val &amp; RNDIS_FILTER_BROADCAST)     != 0U) { packet_filter |= ARM_ETH_MAC_ADDRESS_BROADCAST; }</div>
<div class="line">              <span class="keywordflow">if</span> ((val &amp; RNDIS_FILTER_PROMISCUOUS)   != 0U) { packet_filter |= ARM_ETH_MAC_ADDRESS_ALL;       }</div>
<div class="line">              (void)EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                                   (uint32_t)(link_info.speed                           ) |</div>
<div class="line">                                   (uint32_t)(link_info.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                                    packet_filter);</div>
<div class="line">              rndis_state = RNDIS_DATA_INITIALIZED;</div>
<div class="line">            } <span class="keywordflow">else</span> {</div>
<div class="line">              <span class="keywordflow">if</span> (rndis_state == RNDIS_DATA_INITIALIZED) {</div>
<div class="line">                rndis_state = RNDIS_INITIALIZED;</div>
<div class="line">              }</div>
<div class="line">            }</div>
<div class="line">          } <span class="keywordflow">else</span> {</div>
<div class="line">            status = RNDIS_STATUS_FAILURE;</div>
<div class="line">          }</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>:</div>
<div class="line">          status = RNDIS_STATUS_NOT_SUPPORTED;</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line"> </div>
<div class="line">      ptr_set_cmplt-&gt;Status         = status;</div>
<div class="line">      get_encapsulated_response_len = ptr_set_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_RESET_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_reset_msg = (<span class="keyword">const</span> REMOTE_NDIS_RESET_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_reset_msg-&gt;MessageLength != <span class="keyword">sizeof</span>(REMOTE_NDIS_RESET_MSG_t)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      ResetVars();</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Set flags to message processing threads</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>      (void)osThreadFlagsSet(thread_id_DataIN,  1U);</div>
<div class="line">      (void)osThreadFlagsSet(thread_id_DataOUT, 1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>      (void)osSignalSet(thread_id_DataIN,  1U);</div>
<div class="line">      (void)osSignalSet(thread_id_DataOUT, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_reset_cmplt = (REMOTE_NDIS_RESET_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_reset_cmplt-&gt;MessageType             = REMOTE_NDIS_RESET_CMPLT;</div>
<div class="line">      ptr_reset_cmplt-&gt;MessageLength           = <span class="keyword">sizeof</span>(REMOTE_NDIS_RESET_CMPLT_t);</div>
<div class="line">      ptr_reset_cmplt-&gt;Status                  = status;</div>
<div class="line">      ptr_reset_cmplt-&gt;AddressingReset         = 0U;</div>
<div class="line">      get_encapsulated_response_len            = ptr_reset_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> REMOTE_NDIS_KEEPALIVE_MSG:</div>
<div class="line">      <span class="comment">// Check message is valid</span></div>
<div class="line">      ptr_keepalive_msg = (<span class="keyword">const</span> REMOTE_NDIS_KEEPALIVE_MSG_t *)((<span class="keyword">const</span> <span class="keywordtype">void</span> *)buf);</div>
<div class="line">      <span class="keywordflow">if</span> (ptr_keepalive_msg-&gt;MessageLength != <span class="keyword">sizeof</span>(REMOTE_NDIS_KEEPALIVE_MSG_t)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">      <span class="comment">// Prepare response</span></div>
<div class="line">      ptr_keepalive_cmplt = (REMOTE_NDIS_KEEPALIVE_CMPLT_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">      ptr_keepalive_cmplt-&gt;MessageType         = REMOTE_NDIS_KEEPALIVE_CMPLT;</div>
<div class="line">      ptr_keepalive_cmplt-&gt;MessageLength       = <span class="keyword">sizeof</span>(REMOTE_NDIS_KEEPALIVE_CMPLT_t);</div>
<div class="line">      ptr_keepalive_cmplt-&gt;RequestID           = ptr_keepalive_msg-&gt;RequestID;</div>
<div class="line">      ptr_keepalive_cmplt-&gt;Status              = status;</div>
<div class="line">      get_encapsulated_response_len            = ptr_keepalive_cmplt-&gt;MessageLength;</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (get_encapsulated_response_len != 0U) {</div>
<div class="line">    <span class="comment">// If response is prepared send notification over Interrupt Endpoint</span></div>
<div class="line">    (void)<a class="code" href="group__usbd__cdc_functions__acm__api.html#ga06aa95aa796ce37fcedfc771a0ab074c">USBD_CDC_ACM_Notify_ResponseAvailable</a> (n);</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called upon reception of request to get encapsulated response sent by the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   max_len       maximum number of data bytes that USB Host expects to receive</span></div>
<div class="line"><span class="comment">// \param[out]  buf           pointer to buffer containing get encapsulated response to be returned to USB Host.</span></div>
<div class="line"><span class="comment">// \param[out]  len           pointer to number of data bytes to be returned to USB Host.</span></div>
<div class="line"><span class="comment">// \return      true          get encapsulated response request processed.</span></div>
<div class="line"><span class="comment">// \return      false         get encapsulated response request not supported or not processed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga944044922bbb14f9f8c638408e621abc">USBD_CDCn_ACM_GetEncapsulatedResponse</a> (uint16_t max_len, uint8_t **buf, uint16_t *len) {</div>
<div class="line">  REMOTE_NDIS_INDICATE_STATUS_MSG_t *ptr_indicate_status_msg;</div>
<div class="line">  uint32_t                           status;</div>
<div class="line"> </div>
<div class="line">  (void)max_len;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (link_state_up || link_state_down) {   <span class="comment">// Generate unsolicited INDICATE STATUS message if link status has changed</span></div>
<div class="line">    <span class="keywordflow">if</span> (link_state_up) {</div>
<div class="line">      status = RNDIS_STATUS_MEDIA_CONNECT;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      status = RNDIS_STATUS_MEDIA_DISCONNECT;</div>
<div class="line">    }</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Prepare INDICATE STATUS message</span></div>
<div class="line">    ptr_indicate_status_msg = (REMOTE_NDIS_INDICATE_STATUS_MSG_t *)((<span class="keywordtype">void</span> *)get_encapsulated_response_buf);</div>
<div class="line">    ptr_indicate_status_msg-&gt;MessageType        = REMOTE_NDIS_INDICATE_STATUS_MSG;</div>
<div class="line">    ptr_indicate_status_msg-&gt;MessageLength      = 20U;</div>
<div class="line">    ptr_indicate_status_msg-&gt;Status             = status;</div>
<div class="line">    ptr_indicate_status_msg-&gt;StatusBufferLength = 0U;</div>
<div class="line">    ptr_indicate_status_msg-&gt;StatusBufferOffset = 0U;</div>
<div class="line">    get_encapsulated_response_len               = 20U;</div>
<div class="line"> </div>
<div class="line">    link_state_up   = <span class="keyword">false</span>;</div>
<div class="line">    link_state_down = <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (get_encapsulated_response_len != 0U) {    <span class="comment">// If response is available return it</span></div>
<div class="line">    *buf = (uint8_t *)get_encapsulated_response_buf;</div>
<div class="line">    *len = (uint16_t) get_encapsulated_response_len;</div>
<div class="line">    get_encapsulated_response_len = 0U;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called when all data was sent</span></div>
<div class="line"><span class="comment">// \return                    none.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga5091a4b29df447b17bc6bbe87b17db96">USBD_CDCn_ACM_DataSent</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Callback function called when new data was received</span></div>
<div class="line"><span class="comment">// \param[in]   len           number of bytes available to read.</span></div>
<div class="line"><span class="comment">// \return                    none.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__acm__api.html#ga0d867febbbe62a72bb95c806ece16445">USBD_CDCn_ACM_DataReceived</a> (uint32_t len) {</div>
<div class="line"> </div>
<div class="line">  (void)len;</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osThreadFlagsSet(thread_id_DataOUT, 1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osSignalSet(thread_id_DataOUT, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon Ethernet MAC Event</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> EthMac_Notify (uint32_t event) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">switch</span> (event) {</div>
<div class="line">    <span class="keywordflow">case</span> ARM_ETH_MAC_EVENT_RX_FRAME:</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>      (void)osThreadFlagsSet(thread_id_DataIN, 1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>      (void)osSignalSet(thread_id_DataIN, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling ETH Connection</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> ThreadConnection (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> ThreadConnection (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  ARM_ETH_LINK_STATE link_state_local;</div>
<div class="line">  uint32_t           speed_local;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osThreadFlagsWait(1U, osFlagsWaitAll, 500U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osSignalWait(1U, 500U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    link_state_local = EthPhy-&gt;GetLinkState();</div>
<div class="line">    <span class="keywordflow">if</span> (link_state_local == ARM_ETH_LINK_UP) {</div>
<div class="line">      link_info = EthPhy-&gt;GetLinkInfo();</div>
<div class="line">      <span class="keywordflow">switch</span> (link_info.speed) {</div>
<div class="line">        <span class="keywordflow">case</span> 0:  speed_local =   10000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 1:  speed_local =  100000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 2:  speed_local = 1000000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>: speed_local = 0U;</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      speed_local = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (link_speed != speed_local) {</div>
<div class="line">      link_speed = speed_local;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (link_state != link_state_local) {</div>
<div class="line">      link_state = link_state_local;</div>
<div class="line">      <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                             (uint32_t)(link_info.speed                           ) |</div>
<div class="line">                             (uint32_t)(link_info.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                              packet_filter);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_TX, 1U);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_RX, 1U);</div>
<div class="line">        link_state_down = <span class="keyword">false</span>;</div>
<div class="line">        link_state_up   = <span class="keyword">true</span>;</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_FLUSH,</div>
<div class="line">                              ARM_ETH_MAC_FLUSH_TX |</div>
<div class="line">                              ARM_ETH_MAC_FLUSH_RX);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_TX, 0U);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_RX, 0U);</div>
<div class="line">        link_state_up   = <span class="keyword">false</span>;</div>
<div class="line">        link_state_down = <span class="keyword">true</span>;</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling Data IN (ETH -&gt; USB)</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> ThreadDataIN (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> ThreadDataIN (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  REMOTE_NDIS_PACKET_MSG_t *ptr_packet_msg;</div>
<div class="line">  uint32_t                  eth_rx_size;</div>
<div class="line">   int32_t                  usb_cdc_acm_status;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  ptr_packet_msg = (REMOTE_NDIS_PACKET_MSG_t *)((<span class="keywordtype">void</span> *)packet_in);</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osThreadFlagsWait(1U, osFlagsWaitAll, osWaitForever);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osSignalWait(1U, osWaitForever);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">      eth_rx_size = EthMac-&gt;GetRxFrameSize();</div>
<div class="line">      <span class="keywordflow">if</span> (eth_rx_size == 0) {           <span class="comment">// No new data available on the Ethernet</span></div>
<div class="line">        <span class="keywordflow">break</span>;                          <span class="comment">// exit the loop, and wait for new message</span></div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> ((link_state  == ARM_ETH_LINK_UP)        &amp;&amp;</div>
<div class="line">          (rndis_state == RNDIS_DATA_INITIALIZED) &amp;&amp;</div>
<div class="line">          (eth_rx_size &gt;= ETH_MIN_SIZE)           &amp;&amp;</div>
<div class="line">          (eth_rx_size &lt;= ETH_MAX_SIZE))           {</div>
<div class="line">        (void)EthMac-&gt;ReadFrame((uint8_t *)&amp;ptr_packet_msg-&gt;PayLoad[0], eth_rx_size);</div>
<div class="line">        ptr_packet_msg-&gt;MessageType              = REMOTE_NDIS_PACKET_MSG;</div>
<div class="line">        ptr_packet_msg-&gt;MessageLength            = eth_rx_size + 44U;</div>
<div class="line">        ptr_packet_msg-&gt;DataOffset               = 36U;</div>
<div class="line">        ptr_packet_msg-&gt;DataLength               = eth_rx_size;</div>
<div class="line">        ptr_packet_msg-&gt;OutOfBandDataOffset      = 0U;</div>
<div class="line">        ptr_packet_msg-&gt;OutOfBandDataLength      = 0U;</div>
<div class="line">        ptr_packet_msg-&gt;NumOutOfBandDataElements = 0U;</div>
<div class="line">        ptr_packet_msg-&gt;PerPacketInfoOffset      = 0U;</div>
<div class="line">        ptr_packet_msg-&gt;PerPacketInfoLength      = 0U;</div>
<div class="line">        ptr_packet_msg-&gt;Reserved[0]              = 0U;</div>
<div class="line">        ptr_packet_msg-&gt;Reserved[1]              = 0U;</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          usb_cdc_acm_status = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gaf3ced4ece3f150bb3ce1d2c12babeb95">USBD_CDC_ACM_WriteData</a> (n, (<span class="keyword">const</span> uint8_t *)ptr_packet_msg, (int32_t)ptr_packet_msg-&gt;MessageLength);</div>
<div class="line">        } <span class="keywordflow">while</span> (usb_cdc_acm_status == 0);</div>
<div class="line">        <span class="keywordflow">if</span> (usb_cdc_acm_status == (int32_t)ptr_packet_msg-&gt;MessageLength) {</div>
<div class="line">          rcv_ok++;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">          rcv_error++;</div>
<div class="line">        }</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        (void)EthMac-&gt;ReadFrame(NULL, 0);       <span class="comment">// Dump packet</span></div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Thread handling Data OUT (USB -&gt; ETH)</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> ThreadDataOUT (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> ThreadDataOUT (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  REMOTE_NDIS_PACKET_MSG_t *ptr_packet_msg;</div>
<div class="line">  uint32_t                  eth_tx_size;</div>
<div class="line">   int32_t                  usb_cdc_acm_status, eth_mac_status;</div>
<div class="line"> </div>
<div class="line">  (void)(arg);</div>
<div class="line"> </div>
<div class="line">  eth_tx_size = 0U;</div>
<div class="line"> </div>
<div class="line">  ptr_packet_msg = (REMOTE_NDIS_PACKET_MSG_t *)((<span class="keywordtype">void</span> *)packet_out);</div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osThreadFlagsWait(1U, osFlagsWaitAll, osWaitForever);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osSignalWait(1U, osWaitForever);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">      usb_cdc_acm_status = <a class="code" href="group__usbd__cdc_functions__acm__api.html#gad73c4ad0493dba23185404855d73af04">USBD_CDC_ACM_ReadData</a> (n, (uint8_t *)ptr_packet_msg, USBD_CDC0_ACM_RECEIVE_BUF_SIZE);</div>
<div class="line">      <span class="keywordflow">if</span> (usb_cdc_acm_status == 0) {    <span class="comment">// No new data available on the USB</span></div>
<div class="line">        <span class="keywordflow">break</span>;                          <span class="comment">// exit the loop, and wait for new message</span></div>
<div class="line">      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (usb_cdc_acm_status &gt; (int32_t)ptr_packet_msg-&gt;DataLength) {</div>
<div class="line">        eth_tx_size = ptr_packet_msg-&gt;DataLength;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> ((link_state  == ARM_ETH_LINK_UP)        &amp;&amp;</div>
<div class="line">          (rndis_state == RNDIS_DATA_INITIALIZED) &amp;&amp;</div>
<div class="line">          (eth_tx_size &gt;= ETH_MIN_SIZE)           &amp;&amp;</div>
<div class="line">          (eth_tx_size &lt;= ETH_MAX_SIZE))           {</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          eth_mac_status = EthMac-&gt;SendFrame((uint8_t *)&amp;ptr_packet_msg-&gt;PayLoad[0], (uint32_t)(eth_tx_size), 0U);</div>
<div class="line">        } <span class="keywordflow">while</span> (eth_mac_status == ARM_DRIVER_ERROR_BUSY);</div>
<div class="line">        <span class="keywordflow">if</span> (eth_mac_status == ARM_DRIVER_OK) {</div>
<div class="line">          xmit_ok++;</div>
<div class="line">        } <span class="keywordflow">else</span> {</div>
<div class="line">          xmit_error++;</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue May 25 2021 13:57:48 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
