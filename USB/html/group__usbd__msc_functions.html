<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>MSC: Mass Storage Class</title>
<title>USB Component: MSC: Mass Storage Class</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.15.0</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__usbd__msc_functions.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Content</a>  </div>
  <div class="headertitle">
<div class="title">MSC: Mass Storage Class<div class="ingroups"><a class="el" href="group__usbd___dev_class_functions.html">Device Class</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Implement application specific behavior of a Mass Storage Class (MSC) USB Device.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Content</h2></td></tr>
<tr class="memitem:group__usbd__msc_functions__api"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__msc_functions__api.html">User API</a></td></tr>
<tr class="memdesc:group__usbd__msc_functions__api"><td class="mdescLeft">&#160;</td><td class="mdescRight">User API reference of the Mass Storage Class. <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__usbd__msc_functions__conf"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__msc_functions__conf.html">Configuration</a></td></tr>
<tr class="memdesc:group__usbd__msc_functions__conf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configuration of the USB Device MSC Class in ÂµVision. <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Description</h2>
<p>Implement application specific behavior of a Mass Storage Class (MSC) USB Device. </p>
<p>The MSC class in the USB Component is used for data storage.</p>
<p>Refer to:</p>
<ul>
<li><a class="el" href="_m_s_c.html">MSC: Mass Storage Class</a> for an overview of the MSC class.</li>
<li><a class="el" href="dev_msc_tutorial.html">USB Device Mass Storage</a> for example projects that use the MSC class.</li>
</ul>
<p>The USB Component allows multiple instances of the MSC class. Each MSC class instance has a separate files and interface functions:</p>
<ul>
<li>A configuration file <a class="el" href="group__usbd__msc_functions__conf.html">USBD_Config_MSC_n.h</a>.</li>
<li>An application-specific user source code file, which can be implemented with the <script>link_ext('uv4_ca_sourcefiles');</script> <b>USBD_User_MSC_<em>n</em>.c</b>.</li>
<li>Functions that start with the prefix <b>USBD_MSCn_</b> are available for each instance of a MSC class.</li>
</ul>
<p>This documentation uses <em>n</em> as a placeholder for the instance number <em>0</em> - <em>3</em>. Most applications only require one instance of a MSC class. For the first MSC class instance the instance number is 0:</p>
<ul>
<li><b>USBD_Config_MSC_0.h</b></li>
<li><b>USBD_User_MSC_0.c</b></li>
<li>The function prefix is <b>USBD_MSC0_</b></li>
</ul>
<p><b>Software</b> <b>Structure</b> </p>
<p>The handling for the MSC class endpoint events is implemented in <b>USBD_MSCn_Thread</b> which is started by <a class="el" href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca">USBD_Initialize</a>. Each instance of a MSC class runs an instance of <b>USBD_MSCn_Thread</b> which calls the data functions <a class="el" href="group__usbd__msc_functions__api.html#ga59e44d763427732071b46f7ac408efbf">USBD_MSCn_Read</a> and <a class="el" href="group__usbd__msc_functions__api.html#ga06735f888bd06c9b6d4af2c7a0a6dbed">USBD_MSCn_Write</a>.</p>
<div align="center">
<img src="msc_inline_mscgraph_7.png" alt="msc_inline_mscgraph_7" border="0" usemap="#msc_inline_mscgraph_7.map"/>
<map name="msc_inline_mscgraph_7.map" id="msc_inline_mscgraph_7.map"><area href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca" shape="rect" coords="31,91,120,104" alt=""/>
<area href="group__usbd__core_functions__api.html#gad97153303fc0a6f51c1c20ac050b238f" shape="rect" coords="40,142,111,155" alt=""/>
<area href="group__usbd__msc_functions__api.html#ga06735f888bd06c9b6d4af2c7a0a6dbed" shape="rect" coords="31,244,120,257" alt=""/>
<area href="group__usbd__msc_functions__api.html#ga59e44d763427732071b46f7ac408efbf" shape="rect" coords="34,295,117,308" alt=""/>
<area href="group__usbd__core_functions__api.html#ga9440f139618900f2011034e70cd7a528" shape="rect" coords="31,346,120,359" alt=""/>
<area href="group__usbd__core_functions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="25,397,126,410" alt=""/>
</map>
</div>
<h2>Implementation </h2>
<p>To <a class="el" href="_u_s_b__device.html#Creation_Steps">create an USB Device</a> with a MSC class:</p>
<ul>
<li>Set the required number for USB:Device:MSC class instances during the <a class="el" href="_u_s_b__device.html#RTE_Software_Component_Selection">RTE Component Selection</a>.</li>
<li>Set the parameters in the configuration file <a class="el" href="group__usbd__msc_functions__conf.html">USBD_Config_MSC_n.h</a>.</li>
<li>Implement the application specific behavior using a <a class="el" href="group__usbd__msc_functions.html#UCT_USBD_User_MSC">template</a>.</li>
</ul>
<p><b>Media</b> <b>Ownership</b> </p>
<p>Sometimes, it is required to implement the ownership control over attached media and changing the ownership between USB and File System. This is required if you have a device that connects to a PC as a USB MSC device while the storage media also needs to be accessible to a user application. Using the two functions <a class="el" href="group__usbd__msc_functions__api.html#gaa4980d1e78856e15cd45345a8ede31fb">USBD_MSCn_SetMediaOwnerUSB</a> and <a class="el" href="group__usbd__msc_functions__api.html#gaf123b5ca1fd48de139d22432b2f5440e">USBD_MSCn_SetMediaOwnerFS</a> you can change the owner of the media to either the USB (the host PC) or the File System (the user application). The user code template <a class="el" href="group__usbd__msc_functions.html#USBD_MSC_UCT">USBD_MSC.c</a> provides means to manage the ownership.</p>
<p>The following picture shows the connection of the device to the PC and the user application running on the device:</p>
<div class="image">
<img src="usbd_msc_media_access.png" alt="usbd_msc_media_access.png"/>
<div class="caption">
USB MSC Device connected to a PC with a user application accessing the attached storage medium</div></div>
<p> In the file <a class="el" href="group__usbd__msc_functions.html#USBD_MSC_UCT">USBD_MSC.c</a> the variable <code>usbd_msc0_media_own</code> is used to set the ownership of the media device to the application or the File System. In the file <a class="el" href="group__usbd__msc_functions.html#USBD_User_MSC_UCT">USBD_User_MSC.c</a> the variable is used to initialize it at the beginning of the application (in the <b>USBD_MSCn_Initialize</b> function) and to check the ownership of the media (in the <b>USBD_MSCn_CheckMedia</b> function). The application then only makes use of the two functions <b>USBD_MSCn_SetMediaOwnerUSB</b> and <b>USBD_MSCn_SetMediaOwnerFS</b> as explained in this <a class="el" href="group__usbd__msc_functions.html#USBD_User_MSC_Application">code example</a>.</p>
<p><a class="anchor" id="UCT_USBD_User_MSC"></a><b>User</b> <b>Code</b> <b>Templates</b> <br/>
 There are three user code templates available that help to add support for a MSC device:</p>
<ol type="1">
<li><a class="el" href="group__usbd__msc_functions.html#USBD_User_MSC_UCT">USBD_User_MSC.c</a> contains all the callback functions that need to be implemented by the user.</li>
<li><a class="el" href="group__usbd__msc_functions.html#USBD_MSC_UCT">USBD_MSC.c</a> is a code template for the application specific functionality of a USB Device MSC instance and implements ownership control for attached media devices.</li>
<li><a class="el" href="group__usbd__msc_functions.html#USBD_User_MSC_LUN">USBD_User_MSC_LUN.c</a> is a code template that includes the required callback functions to implement multiple logical units (LUNs).</li>
</ol>
<p><a class="anchor" id="USBD_User_MSC_UCT"></a><b>User</b> <b>Code</b> <b>Template</b> <b>USBD_User_MSC.c</b> </p>
<p>The following source code can be used to implement the application specific behavior of a USB MSC Device.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:MSC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_MSC_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Mass Storage Device class (MSC) User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V6.3.4</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">// If the USE_FILE_SYSTEM value is 1 then File System is used and media can</span></div>
<div class="line"><span class="comment">// be accessed from application code or can be accessed by USB Mass Storage</span></div>
<div class="line"><span class="comment">// requests, default media in that case is one selected as default in File</span></div>
<div class="line"><span class="comment">// System Configuration file.</span></div>
<div class="line"><span class="comment">// If the USE_FILE_SYSTEM value is 0 then File System is not used and media</span></div>
<div class="line"><span class="comment">// can only be accessed by USB Mass Storage requests, default media in that</span></div>
<div class="line"><span class="comment">// case is RAM memory containing dummy disk image.</span></div>
<div class="line"><span class="preprocessor">#define USE_FILE_SYSTEM   1             // 1 = File System is used, 0 = File System is not used</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"><span class="comment">// Definition MEDIA_DRIVE is used to define Drive to be used for media</span></div>
<div class="line"><span class="comment">// Available options are:</span></div>
<div class="line"><span class="comment">//   &quot;R:&quot; or &quot;R0:&quot; if media is RAM</span></div>
<div class="line"><span class="comment">//   &quot;M:&quot; or &quot;M0:&quot; if media is Memory Card 0</span></div>
<div class="line"><span class="comment">//           &quot;M1:&quot; if media is Memory Card 1</span></div>
<div class="line"><span class="comment">//   &quot;N:&quot; or &quot;N0:&quot; if media is NAND Flash 0</span></div>
<div class="line"><span class="comment">//           &quot;N1:&quot; if media is NAND Flash 1</span></div>
<div class="line"><span class="preprocessor">#define MEDIA_DRIVE     &quot;M0:&quot;</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              // If File System is used</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#include &quot;rl_fs.h&quot;</span></div>
<div class="line"><span class="preprocessor">#define  MEDIA_OWN_USB     (1U     )    // Media owned by USB (bit mask)</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define  MEDIA_OWN_CHG     (1U &lt;&lt; 1)    // Media ownership change requested (bit mask)</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">extern</span> </div>
<div class="line"><span class="keyword">volatile</span> uint8_t  usbd_mscn_media_own;</div>
<div class="line"><span class="keyword">volatile</span> uint8_t  usbd_mscn_media_own;  <span class="comment">// USB MSCn media ownership</span></div>
<div class="line"><span class="keyword">static</span>   int32_t  drv_id;               <span class="comment">// FAT drive id</span></div>
<div class="line"><span class="keyword">static</span>   <span class="keywordtype">bool</span>     media_ok;             <span class="comment">// Media is initialized and ok</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span>   uint32_t memory   [8192/4];    <span class="comment">// Memory in RAM for dummy disk image</span></div>
<div class="line"><span class="keyword">static</span>   uint32_t block_buf[ 512/4];    <span class="comment">// Buffer for block read/write to media</span></div>
<div class="line"><span class="keyword">extern</span></div>
<div class="line"><span class="keyword">const</span>    uint8_t  memory_disk_image[4096];  <span class="comment">// Dummy Memory Disk Image</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB MSC class instance.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__msc_functions__api.html#ga1c8c5ad7ab90f84e11122d878fae2350">USBD_MSCn_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              // If File System is used</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t param_status;</div>
<div class="line"> </div>
<div class="line">  usbd_mscn_media_own = MEDIA_OWN_USB;  <span class="comment">// Initially media is owned by USB</span></div>
<div class="line">  media_ok            = <span class="keyword">false</span>;          <span class="comment">// Current media status (not initialized = not ok)</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (finit (MEDIA_DRIVE) != fsOK) {    <span class="comment">// Initialize File System</span></div>
<div class="line">    <span class="keywordflow">return</span>;                             <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  drv_id = fs_ioc_get_id (MEDIA_DRIVE); <span class="comment">// Get ID of media drive</span></div>
<div class="line">  <span class="keywordflow">if</span> (drv_id &lt; 0)           { <span class="keywordflow">return</span>; } <span class="comment">// If ID is invalid exit</span></div>
<div class="line"> </div>
<div class="line">  param_status = 0U;                    <span class="comment">// Parameter for function call is 0</span></div>
<div class="line">                                        <span class="comment">// Initialize media</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_device_ctrl (drv_id, fsDevCtrlCodeControlMedia, &amp;param_status) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span>;                             <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_lock (drv_id)) {           <span class="comment">// Lock media for USB usage</span></div>
<div class="line">    <span class="keywordflow">return</span>;                             <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  media_ok = <span class="keyword">true</span>;                      <span class="comment">// Media was initialized and is ok</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>                                        <span class="comment">// Copy the dummy image from code to RAM</span></div>
<div class="line">  memcpy (memory, memory_disk_image, <span class="keyword">sizeof</span>(memory_disk_image));</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// \brief Called during USBD_Uninitialize to de-initialize the USB MSC class instance.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__msc_functions__api.html#ga8fccca7a1b5aa4794f85cf6fa10403bd">USBD_MSCn_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get cache information.</span></div>
<div class="line"><span class="comment">// \param[out]    buffer               cache buffer address.</span></div>
<div class="line"><span class="comment">// \param[out]    size                 cache buffer size.</span></div>
<div class="line"><span class="comment">// \return        true                 operation succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                operation failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__msc_functions__api.html#gaad99aeaa60c8c0bd8f00e56779144f96">USBD_MSCn_GetCacheInfo</a> (uint32_t *buffer, uint32_t *size) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              // If File System is used</span></div>
<div class="line"><span class="preprocessor"></span>  fsIOC_Cache cache_info;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get cache settings of File System</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_get_cache(drv_id, &amp;cache_info) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;                       <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Use File Systems cache for MSC</span></div>
<div class="line">  *buffer = (uint32_t)cache_info.buffer;<span class="comment">// Cache buffer from File System</span></div>
<div class="line">  *size   = cache_info.size;            <span class="comment">// Cache size</span></div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  *buffer = (uint32_t)block_buf;        <span class="comment">// Local buffer for data</span></div>
<div class="line">  *size   = <span class="keyword">sizeof</span>(block_buf);          <span class="comment">// Size of local buffer</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get media capacity.</span></div>
<div class="line"><span class="comment">// \param[out]    block_count          total number of blocks on media.</span></div>
<div class="line"><span class="comment">// \param[out]    block_size           media block size.</span></div>
<div class="line"><span class="comment">// \return        true                 operation succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                operation failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__msc_functions__api.html#ga46b589d16e70290eb5d039767257766a">USBD_MSCn_GetMediaCapacity</a> (uint32_t *block_count, uint32_t *block_size) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              // If File System is used</span></div>
<div class="line"><span class="preprocessor"></span>  fsMediaInfo media_info;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Read media information of actual media</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_read_info(drv_id, &amp;media_info) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;                       <span class="comment">// Exit if failed</span></div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  *block_count = media_info.block_cnt;  <span class="comment">// Total number of blocks on media</span></div>
<div class="line">  *block_size  = media_info.read_blen;  <span class="comment">// Block size of blocks on media</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  *block_count = <span class="keyword">sizeof</span>(memory)/512U;   <span class="comment">// Total number of blocks on media</span></div>
<div class="line">  *block_size  = 512U;                  <span class="comment">// Block size of blocks on media</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Read data from media.</span></div>
<div class="line"><span class="comment">// \param[in]     lba                  logical address of first block to read.</span></div>
<div class="line"><span class="comment">// \param[in]     cnt                  number of contiguous blocks to read from media.</span></div>
<div class="line"><span class="comment">// \param[out]    buf                  data buffer for data read from media.</span></div>
<div class="line"><span class="comment">// \return        true                 read succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                read failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__msc_functions__api.html#ga59e44d763427732071b46f7ac408efbf">USBD_MSCn_Read</a> (uint32_t lba, uint32_t cnt, uint8_t *buf) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              // If File System is used</span></div>
<div class="line"><span class="preprocessor"></span>                                        <span class="comment">// Read data directly from media</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_read_sector (drv_id, lba, buf, cnt) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>                                        <span class="comment">// Read data from dummy image in RAM</span></div>
<div class="line">  memcpy (buf, &amp;memory[lba * (512U/4U)], cnt * 512U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write data to media.</span></div>
<div class="line"><span class="comment">// \param[in]     lba                  logical address of first block to write.</span></div>
<div class="line"><span class="comment">// \param[in]     cnt                  number of contiguous blocks to write to media.</span></div>
<div class="line"><span class="comment">// \param[out]    buf                  data buffer containing data to write to media.</span></div>
<div class="line"><span class="comment">// \return        true                 write succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                write failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__msc_functions__api.html#ga06735f888bd06c9b6d4af2c7a0a6dbed">USBD_MSCn_Write</a> (uint32_t lba, uint32_t cnt, <span class="keyword">const</span> uint8_t *buf) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              // If File System is used</span></div>
<div class="line"><span class="preprocessor"></span>                                        <span class="comment">// Write data directly to media</span></div>
<div class="line">  <span class="keywordflow">if</span> (fs_ioc_write_sector (drv_id, lba, buf, cnt) != fsOK) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">  }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>                                        <span class="comment">// Write data to image in RAM</span></div>
<div class="line">  memcpy (&amp;memory[lba * (512U/4U)], buf, cnt * 512U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check media presence and write protect status.</span></div>
<div class="line"><span class="comment">//        (if media is not owned by USB it returns that media is not ready)</span></div>
<div class="line"><span class="comment">// \return                             media presence and write protected status</span></div>
<div class="line"><span class="comment">//                bit 1:               write protect bit</span></div>
<div class="line"><span class="comment">//                 - value 1:            media is write protected</span></div>
<div class="line"><span class="comment">//                 - value 0:            media is not write protected</span></div>
<div class="line"><span class="comment">//                bit 0:               media presence bit</span></div>
<div class="line"><span class="comment">//                 - value 1:            media is present</span></div>
<div class="line"><span class="comment">//                 - value 0:            media is not present</span></div>
<div class="line">uint32_t <a class="code" href="group__usbd__msc_functions__api.html#ga81d52d4cb73b423b0a990f038df7afac">USBD_MSCn_CheckMedia</a> (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (USE_FILE_SYSTEM == 1)              // If File System is used</span></div>
<div class="line"><span class="preprocessor"></span>       uint32_t param_status;</div>
<div class="line">       uint8_t  media_state;            <span class="comment">// Bit 0. media ready, Bit 1. media write protect</span></div>
<div class="line"><span class="keyword">static</span> uint8_t  media_ready_ex = 0U;    <span class="comment">// Previous media ready state</span></div>
<div class="line">       uint8_t  own;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Get current media status</span></div>
<div class="line">  media_state = 0U;</div>
<div class="line">  <span class="keywordflow">switch</span> (fs_ioc_device_ctrl (drv_id, fsDevCtrlCodeCheckMedia, &amp;param_status)) {</div>
<div class="line">    <span class="keywordflow">case</span> fsOK:</div>
<div class="line">      <span class="keywordflow">if</span> (param_status &amp; FS_MEDIA_NOCHKMEDIA) {</div>
<div class="line">        <span class="comment">// If check media not available on hardware layer</span></div>
<div class="line">        media_state  =  USBD_MSC_MEDIA_READY;</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (param_status &amp; FS_MEDIA_INSERTED) {</div>
<div class="line">        media_state  =  USBD_MSC_MEDIA_READY;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">if</span> (param_status &amp; FS_MEDIA_PROTECTED) {</div>
<div class="line">        media_state |=  USBD_MSC_MEDIA_PROTECTED;</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> fsError:</div>
<div class="line">    <span class="keywordflow">case</span> fsUnsupported:</div>
<div class="line">    <span class="keywordflow">case</span> fsAccessDenied:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidParameter:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidDrive:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidPath:</div>
<div class="line">    <span class="keywordflow">case</span> fsUninitializedDrive:</div>
<div class="line">    <span class="keywordflow">case</span> fsDriverError:</div>
<div class="line">    <span class="keywordflow">case</span> fsMediaError:</div>
<div class="line">    <span class="keywordflow">case</span> fsNoMedia:</div>
<div class="line">    <span class="keywordflow">case</span> fsNoFileSystem:</div>
<div class="line">    <span class="keywordflow">case</span> fsNoFreeSpace:</div>
<div class="line">    <span class="keywordflow">case</span> fsFileNotFound:</div>
<div class="line">    <span class="keywordflow">case</span> fsDirNotEmpty:</div>
<div class="line">    <span class="keywordflow">case</span> fsTooManyOpenFiles:</div>
<div class="line">    <span class="keywordflow">case</span> fsAlreadyExists:</div>
<div class="line">    <span class="keywordflow">case</span> fsNotDirectory:</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Store current owner so no new request can interfere</span></div>
<div class="line">  own = usbd_mscn_media_own;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// De-initialize media according to previous owner</span></div>
<div class="line">  <span class="keywordflow">if</span> (own &amp; MEDIA_OWN_CHG) {                    <span class="comment">// If owner change requested</span></div>
<div class="line">    <span class="keywordflow">if</span> (own &amp; MEDIA_OWN_USB) {                  <span class="comment">// If new requested owner is USB (previous owner was File System)</span></div>
<div class="line">      (void)funmount (MEDIA_DRIVE);             <span class="comment">// De-initialize media and dismount Drive</span></div>
<div class="line">    } <span class="keywordflow">else</span> {                                    <span class="comment">// If new requested owner is File System (previous owner was USB)</span></div>
<div class="line">      (void)fs_ioc_unlock (drv_id);             <span class="comment">// Un-lock media</span></div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize media according to current owner</span></div>
<div class="line">  <span class="keywordflow">if</span> ((own &amp; MEDIA_OWN_CHG)        ||           <span class="comment">// If owner change requested or</span></div>
<div class="line">      (media_state ^ media_ready_ex)) {         <span class="comment">// if media ready state has changed (disconnect(SD remove)/connect(SD insert))</span></div>
<div class="line">    <span class="keywordflow">if</span> (media_state &amp; USBD_MSC_MEDIA_READY) {   <span class="comment">// If media is ready</span></div>
<div class="line">      <span class="keywordflow">if</span> (own &amp; MEDIA_OWN_USB){                 <span class="comment">// If current owner is USB</span></div>
<div class="line">        media_ok     = <span class="keyword">false</span>;                   <span class="comment">// Invalidate current media status (not initialized = not ok)</span></div>
<div class="line">        param_status = 0U;                      <span class="comment">// Parameter for function call is 0</span></div>
<div class="line">        <span class="keywordflow">if</span> (fs_ioc_device_ctrl (drv_id, fsDevCtrlCodeControlMedia, &amp;param_status) == fsOK) {</div>
<div class="line">                                                <span class="comment">// Initialization of media has succeeded</span></div>
<div class="line">          <span class="keywordflow">if</span> (fs_ioc_lock (drv_id) == fsOK) {   <span class="comment">// If lock media for USB usage has succeeded</span></div>
<div class="line">            media_ok = <span class="keyword">true</span>;                    <span class="comment">// Media was initialized and is ok</span></div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      } <span class="keywordflow">else</span> {                                  <span class="comment">// If current owner is File System</span></div>
<div class="line">        <span class="keywordflow">if</span> (fmount (MEDIA_DRIVE) == fsOK) {     <span class="comment">// Initialize media and Mount Drive for File System usage</span></div>
<div class="line">          media_ok = <span class="keyword">true</span>;                      <span class="comment">// Media was initialized and is ok</span></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (own &amp; MEDIA_OWN_CHG) {</div>
<div class="line">      usbd_mscn_media_own &amp;= ~MEDIA_OWN_CHG;    <span class="comment">// Clear request to change media owner if it was handled</span></div>
<div class="line">    }</div>
<div class="line">    media_ready_ex = media_state &amp; USBD_MSC_MEDIA_READY;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// If media is not ok or owned by File System return that it is not ready for USB</span></div>
<div class="line">  <span class="keywordflow">if</span> ((!media_ok) || (!(usbd_mscn_media_own &amp; MEDIA_OWN_USB))) {</div>
<div class="line">    <span class="keywordflow">return</span> 0U;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> media_state;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">return</span> USBD_MSC_MEDIA_READY;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
</div><!-- fragment --><p><a class="anchor" id="USBD_MSC_UCT"></a><b>User</b> <b>Code</b> <b>Template</b> <b>USBD_MSC_n.c</b> </p>
<p>The following source code can be used to implement ownership control for attached media devices.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:MSC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_MSC_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: Functions for media ownership control between USB and File System</span></div>
<div class="line"><span class="comment"> * Rev.:    V6.3.6</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * USBD_MSC_n.c is a code template for the application specific functionality of</span></div>
<div class="line"><span class="comment"> * the USB Device MSC class n instance. It implements the ownership control over</span></div>
<div class="line"><span class="comment"> * media and changing the owner of media between USB and File System.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * USBD_MSC_n.h is the related header file.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * To select USB as owner of media you can call function:</span></div>
<div class="line"><span class="comment"> *   USBD_MSCn_SetMediaOwnerUSB ()</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * To select File System as owner of media you can call function:</span></div>
<div class="line"><span class="comment"> *   USBD_MSCn_SetMediaOwnerFS  ()</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;USBD_MSC_n.h&quot;</span>                 <span class="comment">// Media ownership control for USB Device</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBD_Config_MSC_n.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">volatile</span> uint8_t usbd_mscn_media_own;    <span class="comment">// USB MSCn media ownership</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">int32_t <a class="code" href="group__usbd__msc_functions__api.html#gaa4980d1e78856e15cd45345a8ede31fb">USBD_MSCn_SetMediaOwnerUSB</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint32_t timeout_cnt;</div>
<div class="line"> </div>
<div class="line">  timeout_cnt = 300U;                   <span class="comment">// 3 second timeout (300 * 10 ms)</span></div>
<div class="line">  usbd_mscn_media_own = USBD_MSCn_MEDIA_OWN_CHG | USBD_MSCn_MEDIA_OWN_USB;</div>
<div class="line">  <span class="keywordflow">while</span> (usbd_mscn_media_own &amp; USBD_MSCn_MEDIA_OWN_CHG) {</div>
<div class="line">    (void)osDelay(10);</div>
<div class="line">    <span class="keywordflow">if</span> ((--timeout_cnt) == 0) { <span class="keywordflow">return</span> USBD_MSCn_ERROR; }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> USBD_MSCn_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">int32_t <a class="code" href="group__usbd__msc_functions__api.html#gaf123b5ca1fd48de139d22432b2f5440e">USBD_MSCn_SetMediaOwnerFS</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  uint32_t timeout_cnt;</div>
<div class="line"> </div>
<div class="line">  timeout_cnt = 300U;                   <span class="comment">// 3 second timeout (300 * 10 ms)</span></div>
<div class="line">  usbd_mscn_media_own = USBD_MSCn_MEDIA_OWN_CHG;</div>
<div class="line">  <span class="keywordflow">while</span> (usbd_mscn_media_own &amp; USBD_MSCn_MEDIA_OWN_CHG) {</div>
<div class="line">    <span class="keywordflow">if</span>(!<a class="code" href="group__usbd__core_functions__api.html#gabcbbc7a70c6050fbaec107968a581487">USBD_Configured</a>(USBD_MSCn_DEV)) {</div>
<div class="line">      <span class="comment">/* USB device not configured, so call CheckMedia to do ownership handling */</span></div>
<div class="line">      (void)<a class="code" href="group__usbd__msc_functions__api.html#ga81d52d4cb73b423b0a990f038df7afac">USBD_MSCn_CheckMedia</a>();</div>
<div class="line">    }</div>
<div class="line">    (void)osDelay(10);</div>
<div class="line">    <span class="keywordflow">if</span> ((--timeout_cnt) == 0) { <span class="keywordflow">return</span> USBD_MSCn_ERROR; }</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> USBD_MSCn_OK;</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_MSC_Application"></a><b>Code</b> <b>Example</b> </p>
<p>This code snippet shows how to use the two functions in a user application: </p>
<div class="fragment"><div class="line">:</div>
<div class="line"><span class="keywordflow">switch</span> (DeviceState) {</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">case</span> DEV_IDLE:</div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">case</span> DEV_START_DOING_SOMETHING:</div>
<div class="line">    <span class="comment">// hide logical unit</span></div>
<div class="line">    USBD_MSC0_SetMediaOwnerFS();  </div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Application has now access to the media</span></div>
<div class="line">    <span class="comment">// and can do something here (e.g. fopen, fread, fwrite, fclose, ...)</span></div>
<div class="line">    DeviceState = DEV_DO_IT;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">  </div>
<div class="line">  <span class="keywordflow">case</span> DEV_STOP_DOING_SOMETHING:</div>
<div class="line">    <span class="comment">// show logical unit</span></div>
<div class="line">    USBD_MSC0_SetMediaOwnerUSB();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// Media is now under control of the USB Host</span></div>
<div class="line">    <span class="comment">// and cannot be accessed by the application</span></div>
<div class="line">    DeviceState = DEV_IDLE;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">break</span>;</div>
<div class="line">}</div>
<div class="line">:</div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_MSC_LUN"></a><b>User</b> <b>Code</b> <b>Template</b> <b>USBD_User_MSC_LUN.c</b> </p>
<p>The following source code can be used to implement multiple logical units (LUNs) in a USB device.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:MSC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_MSC_LUN_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Mass Storage Device class (MSC) with 2 Logical</span></div>
<div class="line"><span class="comment"> *          Units User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.1.1</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;stdbool.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span>   uint32_t memory   [2][8192/4];         <span class="comment">// Memory in RAM for dummy disk image</span></div>
<div class="line"><span class="keyword">static</span>   uint32_t block_buf[    512/4];         <span class="comment">// Buffer for block read/write to media</span></div>
<div class="line"><span class="keyword">extern</span></div>
<div class="line"><span class="keyword">const</span>    uint8_t  memory_disk_image[4096];      <span class="comment">// Dummy Memory Disk Image</span></div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize all Logical Units of the USB MSC class instance.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__msc_functions__api.html#ga1c8c5ad7ab90f84e11122d878fae2350">USBD_MSCn_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">                                        <span class="comment">// Copy the dummy image from code to RAM</span></div>
<div class="line">  memcpy (&amp;memory[0][0], memory_disk_image, <span class="keyword">sizeof</span>(memory_disk_image));</div>
<div class="line">  memcpy (&amp;memory[1][0], memory_disk_image, <span class="keyword">sizeof</span>(memory_disk_image));</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize all Logical Units of the USB MSC class instance.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__msc_functions__api.html#ga8fccca7a1b5aa4794f85cf6fa10403bd">USBD_MSCn_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get cache information.</span></div>
<div class="line"><span class="comment">// \param[out]    buffer               cache buffer address.</span></div>
<div class="line"><span class="comment">// \param[out]    size                 cache buffer size.</span></div>
<div class="line"><span class="comment">// \return        true                 operation succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                operation failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__msc_functions__api.html#gaad99aeaa60c8c0bd8f00e56779144f96">USBD_MSCn_GetCacheInfo</a> (uint32_t *buffer, uint32_t *size) {</div>
<div class="line"> </div>
<div class="line">  *buffer = (uint32_t)block_buf;        <span class="comment">// Local buffer for data</span></div>
<div class="line">  *size   = <span class="keyword">sizeof</span>(block_buf);          <span class="comment">// Size of local buffer</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get maximum number of logical units.</span></div>
<div class="line"><span class="comment">// \return                             number of logical units that device contains</span></div>
<div class="line"><span class="comment">//                                       - value &gt; 0 and &lt;= 4 : maximum number of logical units</span></div>
<div class="line"><span class="comment">//                                       - value 0 :            use setting from configuration file</span></div>
<div class="line">uint8_t <a class="code" href="group__usbd__msc_functions__api.html#ga075e3bbb0c78a0e83d78dd409f01101f">USBD_MSCn_GetMaxLUN</a> (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> 2U;                            <span class="comment">// Device contains 2 logical units</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Get media capacity of a logical unit.</span></div>
<div class="line"><span class="comment">// \param[in]     lun                  logical unit number.</span></div>
<div class="line"><span class="comment">// \param[out]    block_count          total number of blocks on media.</span></div>
<div class="line"><span class="comment">// \param[out]    block_size           media block size.</span></div>
<div class="line"><span class="comment">// \return        true                 operation succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                operation failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__msc_functions__api.html#ga12d89d9bbfed3128e671dd3ab9b187f7">USBD_MSCn_LUN_GetMediaCapacity</a> (uint8_t lun, uint32_t *block_count, uint32_t *block_size) {</div>
<div class="line"> </div>
<div class="line">  (void)lun;</div>
<div class="line"> </div>
<div class="line">  *block_count =(<span class="keyword">sizeof</span>(memory)/2)/512; <span class="comment">// Total number of blocks on media</span></div>
<div class="line">  *block_size  = 512U;                  <span class="comment">// Block size of blocks on media</span></div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Read data from media of a logical unit.</span></div>
<div class="line"><span class="comment">// \param[in]     lun                  logical unit number.</span></div>
<div class="line"><span class="comment">// \param[in]     lba                  logical address of first block to read.</span></div>
<div class="line"><span class="comment">// \param[in]     cnt                  number of contiguous blocks to read from media.</span></div>
<div class="line"><span class="comment">// \param[out]    buf                  data buffer for data read from media.</span></div>
<div class="line"><span class="comment">// \return        true                 read succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                read failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__msc_functions__api.html#gadeef9441a8e207282144212f67df06e5">USBD_MSCn_LUN_Read</a> (uint8_t lun, uint32_t lba, uint32_t cnt, uint8_t *buf) {</div>
<div class="line"> </div>
<div class="line">                                        <span class="comment">// Read data from dummy image in RAM</span></div>
<div class="line">  memcpy (buf, &amp;memory[lun][lba * (512U/4U)], cnt * 512U);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Write data to media of a logical unit.</span></div>
<div class="line"><span class="comment">// \param[in]     lun                  logical unit number.</span></div>
<div class="line"><span class="comment">// \param[in]     lba                  logical address of first block to write.</span></div>
<div class="line"><span class="comment">// \param[in]     cnt                  number of contiguous blocks to write to media.</span></div>
<div class="line"><span class="comment">// \param[out]    buf                  data buffer containing data to write to media.</span></div>
<div class="line"><span class="comment">// \return        true                 write succeeded.</span></div>
<div class="line"><span class="comment">// \return        false                write failed.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__msc_functions__api.html#ga22d4749863f47b288ae07fc05435eb36">USBD_MSCn_LUN_Write</a> (uint8_t lun, uint32_t lba, uint32_t cnt, <span class="keyword">const</span> uint8_t *buf) {</div>
<div class="line"> </div>
<div class="line">                                        <span class="comment">// Write data to image in RAM</span></div>
<div class="line">  memcpy (&amp;memory[lun][lba * (512U/4U)], buf, cnt * 512U);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Check media presence and write protect status of a logical unit.</span></div>
<div class="line"><span class="comment">//        (if media is not owned by USB it returns that media is not ready)</span></div>
<div class="line"><span class="comment">// \param[in]     lun                  logical unit number.</span></div>
<div class="line"><span class="comment">// \return                             media presence and write protected status</span></div>
<div class="line"><span class="comment">//                bit 1:               write protect bit</span></div>
<div class="line"><span class="comment">//                 - value 1:            media is write protected</span></div>
<div class="line"><span class="comment">//                 - value 0:            media is not write protected</span></div>
<div class="line"><span class="comment">//                bit 0:               media presence bit</span></div>
<div class="line"><span class="comment">//                 - value 1:            media is present</span></div>
<div class="line"><span class="comment">//                 - value 0:            media is not present</span></div>
<div class="line">uint32_t <a class="code" href="group__usbd__msc_functions__api.html#ga026e3aa14519dbe54e2576d95df993be">USBD_MSCn_LUN_CheckMedia</a> (uint8_t lun) {</div>
<div class="line"> </div>
<div class="line">  (void)lun;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> USBD_MSC_MEDIA_READY;</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue May 25 2021 13:57:50 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
