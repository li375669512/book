<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>MSC: Mass Storage Class</title>
<title>USB Component: MSC: Mass Storage Class</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.15.0</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__usbh__msc_functions.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Content</a>  </div>
  <div class="headertitle">
<div class="title">MSC: Mass Storage Class<div class="ingroups"><a class="el" href="group__usbh___dev_class_functions.html">Device Class</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>USB Host functions to support Mass Storage Class (MSC) USB Devices.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Content</h2></td></tr>
<tr class="memitem:group__usbh__msc_functions__api"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbh__msc_functions__api.html">User API</a></td></tr>
<tr class="memdesc:group__usbh__msc_functions__api"><td class="mdescLeft">&#160;</td><td class="mdescRight">User API reference of the Mass Storage Class. <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__usbh__msc_functions__conf"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbh__msc_functions__conf.html">Configuration</a></td></tr>
<tr class="memdesc:group__usbh__msc_functions__conf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configuration of the USB Host MSC Class in ÂµVision. <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Description</h2>
<p>USB Host functions to support Mass Storage Class (MSC) USB Devices. </p>
<p>The <b>Mass Storage Class (MSC)</b> in the USB Host Component provides physical access to a data storage device. The USB MSC drive in the <b>File System</b> Component gives file I/O access to that data storage.</p>
<p><b>Software Stack</b> <br/>
 The following picture shows how the software stack is built-up for MSC device support:</p>
<div class="image">
<img src="usbh_msc_sw_stack.png" alt="usbh_msc_sw_stack.png"/>
</div>
<p>Refer to:</p>
<ul>
<li><a class="el" href="_m_s_c.html">MSC: Mass Storage Class</a> for an overview of the MSC class.</li>
<li><a class="el" href="host_msc_tutorial.html">USB Host Mass Storage</a> for an example project that uses the MSC class.</li>
</ul>
<p><b>Software Structure</b> <br/>
 The application starts the USB Host by calling <a class="el" href="group__usbh__core_functions__api.html#ga4420c0add78ae79e8e7ce035227ef4c5">USBH_Initialize</a>. The USB Host Core will wait until an USB MSC device is attached to the system. As soon as this happens it will enumerate the device and it will be ready to be used by the application.</p>
<p>The data functions <a class="el" href="group__usbh__msc_functions__api.html#ga8fbe5bb0db9f02eb026fc37daf1fc6b3">USBH_MSC_Read</a> and <a class="el" href="group__usbh__msc_functions__api.html#gaea01ed67542b6a8b16c29a1dbc3d1273">USBH_MSC_Write</a> can be either called by the user thread directly or called indirectly when the user thread is using file system routines like fread/fwrite which use the USB MSC Device as media for data storage.</p>
<div align="center">
<img src="msc_inline_mscgraph_11.png" alt="msc_inline_mscgraph_11" border="0" usemap="#msc_inline_mscgraph_11.map"/>
<map name="msc_inline_mscgraph_11.map" id="msc_inline_mscgraph_11.map"><area href="group__usbh__core_functions__api.html#ga4420c0add78ae79e8e7ce035227ef4c5" shape="rect" coords="56,91,145,104" alt=""/>
<area href="group__usbh__msc_functions__api.html#ga8fbe5bb0db9f02eb026fc37daf1fc6b3" shape="rect" coords="62,263,139,276" alt=""/>
<area href="group__usbh__msc_functions__api.html#gaea01ed67542b6a8b16c29a1dbc3d1273" shape="rect" coords="59,314,142,327" alt=""/>
<area href="group__usbh__core_functions__api.html#gaf98f4e13ff57a8bf1c49cd46a8034d3f" shape="rect" coords="50,384,151,397" alt=""/>
</map>
</div>
<h2>Implementation </h2>
<p>Steps to <a class="el" href="_u_s_b__host.html#Create_a_USB_Host_Application">create an USB Host</a> application with MSC support:</p>
<ul>
<li>In the <a class="el" href="_u_s_b__device.html#RTE_Software_Component_Selection">Manage Run-Time Environment</a> window select <b>USB:Host:MSC</b> for support of the MSC class and <b>File System:CORE</b>, <b>File System:Drive:USB</b> for using the <b>File</b> <b>System</b> Component with support for USB mass storage devices. For the <b>File System:Drive:USB</b> you have to set the number to the number of devices you need to support simultaneously.</li>
<li>Configure the number of USB MSC devices connected in the file <a class="el" href="group__usbh__msc_functions__conf.html">USBH_Config_MSC.h</a>.</li>
<li>Use the functions of the related <script>link_ext('uv4_ca_sourcefiles');</script> file (<b>USBH_MSC.c</b>) to access the data storage.</li>
</ul>
<p><a class="anchor" id="USBH_MSC_UCT"></a><b>User Code Template USBH_MSC.c</b> </p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Host:MSC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBH_MSC.c</span></div>
<div class="line"><span class="comment"> * Purpose: Functions to access USB storage device via USB Host</span></div>
<div class="line"><span class="comment"> * Rev.:    V6.4.3</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * USBH_MSC.c is a code template for the application specific functionality of</span></div>
<div class="line"><span class="comment"> * the USB Host MSC class. It implements the access to a USB storage device and</span></div>
<div class="line"><span class="comment"> * allows file I/O via the File System component.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * USBH_MSC.h is the related header file.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * First to enable USB Host Controller (if not already enabled) call:</span></div>
<div class="line"><span class="comment"> *   USBH_Initialize (ctrl_num);</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * To access files on a USB storage device use below code sample:</span></div>
<div class="line"><span class="comment"> *   int32_t media_status, media_status_previous = USBH_MSC_ERROR_DRIVE;</span></div>
<div class="line"><span class="comment"> *   for (;;) {</span></div>
<div class="line"><span class="comment"> *     media_status = USBH_MSC_DriveGetMediaStatus (drive_name);</span></div>
<div class="line"><span class="comment"> *     if ((media_status          == USBH_MSC_OK) &amp;&amp; </span></div>
<div class="line"><span class="comment"> *         (media_status_previous != USBH_MSC_OK)) {</span></div>
<div class="line"><span class="comment"> *       switch (USBH_MSC_DriveMount (drive_name)) {</span></div>
<div class="line"><span class="comment"> *         case USBH_MSC_OK:</span></div>
<div class="line"><span class="comment"> *           fopen (...);</span></div>
<div class="line"><span class="comment"> *           break;</span></div>
<div class="line"><span class="comment"> *         case USBH_MSC_ERROR_FORMAT:</span></div>
<div class="line"><span class="comment"> *           fformat (drive_name, &quot;/FAT32&quot;);</span></div>
<div class="line"><span class="comment"> *           fopen (...);</span></div>
<div class="line"><span class="comment"> *           break;</span></div>
<div class="line"><span class="comment"> *         case USBH_MSC_ERROR:</span></div>
<div class="line"><span class="comment"> *           // Mount error</span></div>
<div class="line"><span class="comment"> *           break;</span></div>
<div class="line"><span class="comment"> *       }</span></div>
<div class="line"><span class="comment"> *     }</span></div>
<div class="line"><span class="comment"> *     media_status_previous = media_status;</span></div>
<div class="line"><span class="comment"> *     osWait (1000);   // polling interval for media status (1 second)</span></div>
<div class="line"><span class="comment"> *   }</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Now file I/O can be performed using fopen, fread, fwrite, fclose and other</span></div>
<div class="line"><span class="comment"> * functions of the File System component</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * When drive is not to be used any more call:</span></div>
<div class="line"><span class="comment"> *   USBH_MSC_DriveUnmount (drive_name);</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * When USB Host Controller is not to be used any more call:</span></div>
<div class="line"><span class="comment"> *   USBH_Uninitialize (ctrl_num);</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdint.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;RTE_Components.h&quot;</span>             <span class="comment">// Component selection</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBH_MSC.h&quot;</span>                   <span class="comment">// Access storage via USB Host</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#if (!defined (RTE_FileSystem_Drive_USB_0) &amp;&amp; !defined (RTE_FileSystem_Drive_USB_1))</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">  #error &quot;Project does not contain USB storage device support&quot;</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span></div>
<div class="line"></div>
<div class="line">int32_t USBH_MSC_DriveGetMediaStatus (<span class="keyword">const</span> <span class="keywordtype">char</span> *drive_name) {</div>
<div class="line">  usbStatus ustatus;</div>
<div class="line">  uint8_t   drive_num;</div>
<div class="line"> </div>
<div class="line">  drive_num = (uint8_t)(drive_name[1] - <span class="charliteral">&#39;0&#39;</span>);   <span class="comment">// get drive number from drive name</span></div>
<div class="line"> </div>
<div class="line">  ustatus = <a class="code" href="group__usbh__msc_functions__api.html#ga2480185d26ff2652737fce77586ddcd8">USBH_MSC_GetStatus</a> (drive_num);</div>
<div class="line">  <span class="keywordflow">if</span> (ustatus != usbOK) <span class="keywordflow">return</span> USBH_MSC_ERROR_DRIVE;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> USBH_MSC_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">int32_t USBH_MSC_DriveMount (<span class="keyword">const</span> <span class="keywordtype">char</span> *drive_name) {</div>
<div class="line">  fsStatus  fstatus;</div>
<div class="line"> </div>
<div class="line">  fstatus = finit (drive_name);</div>
<div class="line">  <span class="keywordflow">if</span> (fstatus != fsOK)   <span class="keywordflow">return</span> USBH_MSC_ERROR;</div>
<div class="line"> </div>
<div class="line">  fstatus = fmount (drive_name);</div>
<div class="line">  <span class="keywordflow">switch</span> (fstatus)  {</div>
<div class="line">    <span class="keywordflow">case</span> fsOK:</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">case</span> fsNoFileSystem:</div>
<div class="line">      <span class="keywordflow">return</span> USBH_MSC_ERROR_FORMAT;</div>
<div class="line">    <span class="keywordflow">case</span> fsError:</div>
<div class="line">    <span class="keywordflow">case</span> fsUnsupported:</div>
<div class="line">    <span class="keywordflow">case</span> fsAccessDenied:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidParameter:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidDrive:</div>
<div class="line">    <span class="keywordflow">case</span> fsInvalidPath:</div>
<div class="line">    <span class="keywordflow">case</span> fsUninitializedDrive:</div>
<div class="line">    <span class="keywordflow">case</span> fsDriverError:</div>
<div class="line">    <span class="keywordflow">case</span> fsMediaError:</div>
<div class="line">    <span class="keywordflow">case</span> fsNoMedia:</div>
<div class="line">    <span class="keywordflow">case</span> fsNoFreeSpace:</div>
<div class="line">    <span class="keywordflow">case</span> fsFileNotFound:</div>
<div class="line">    <span class="keywordflow">case</span> fsDirNotEmpty:</div>
<div class="line">    <span class="keywordflow">case</span> fsTooManyOpenFiles:</div>
<div class="line">    <span class="keywordflow">case</span> fsAlreadyExists:</div>
<div class="line">    <span class="keywordflow">case</span> fsNotDirectory:</div>
<div class="line">      <span class="keywordflow">return</span> USBH_MSC_ERROR;</div>
<div class="line">  }</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> USBH_MSC_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">int32_t USBH_MSC_DriveUnmount (<span class="keyword">const</span> <span class="keywordtype">char</span> *drive_name) {</div>
<div class="line">  fsStatus fstatus;</div>
<div class="line"> </div>
<div class="line">  fstatus = funmount (drive_name);</div>
<div class="line">  <span class="keywordflow">if</span> (fstatus != fsOK) <span class="keywordflow">return</span> USBH_MSC_ERROR;</div>
<div class="line"> </div>
<div class="line">  fstatus = funinit (drive_name);</div>
<div class="line">  <span class="keywordflow">if</span> (fstatus != fsOK) <span class="keywordflow">return</span> USBH_MSC_ERROR;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> USBH_MSC_OK;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">uint64_t USBH_MSC_DriveGetCapacity (<span class="keyword">const</span> <span class="keywordtype">char</span> *drive_name) {</div>
<div class="line">  usbStatus ustatus;</div>
<div class="line">  uint32_t  block_count;</div>
<div class="line">  uint32_t  block_size;</div>
<div class="line">  uint8_t   drive_num;</div>
<div class="line"> </div>
<div class="line">  drive_num = (uint8_t)(drive_name[1] - <span class="charliteral">&#39;0&#39;</span>);   <span class="comment">// get drive number from drive name</span></div>
<div class="line"> </div>
<div class="line">  ustatus = <a class="code" href="group__usbh__msc_functions__api.html#ga2480185d26ff2652737fce77586ddcd8">USBH_MSC_GetStatus</a> (drive_num);</div>
<div class="line">  <span class="keywordflow">if</span> (ustatus != usbOK) <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">  ustatus = <a class="code" href="group__usbh__msc_functions__api.html#ga168fe4c5c2cf222ab3df02841887a0ed">USBH_MSC_ReadCapacity</a> (drive_num, &amp;block_count, &amp;block_size);</div>
<div class="line">  <span class="keywordflow">if</span> (ustatus != usbOK) <span class="keywordflow">return</span> 0;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> (((uint64_t)block_count) * ((uint64_t)block_size));</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue May 25 2021 13:57:52 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
