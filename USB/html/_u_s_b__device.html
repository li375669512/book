<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>USB Device</title>
<title>USB Component: USB Device</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.15.0</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('_u_s_b__device.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">USB Device </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#Creation_Steps">Create an Application</a><ul><li class="level2"><a href="#RTE_Software_Component_Selection">RTE Component Selection</a></li>
<li class="level2"><a href="#USB_Driver_Configuration">USB Driver and Controller</a></li>
<li class="level2"><a href="#USB_Device_Configuration">USB Device Configuration</a></li>
<li class="level2"><a href="#USB_Device_Class_Configuration">USB Device Class Configuration and USB Endpoint Settings</a></li>
<li class="level2"><a href="#usbd_system_resources">System Resource Configuration</a></li>
<li class="level2"><a href="#User_Code_Implementation">User Code Implementation</a></li>
<li class="level2"><a href="#Overriding_Descriptors">Changing Default USB Descriptors</a></li>
<li class="level2"><a href="#usbd_debugging">Debugging</a></li>
</ul>
</li>
</ul>
</div>
<div class="textblock"><p>This chapter describes the software structure of the USB Device Component and its use for creating applications. The USB Device Component simplifies the software development of microcontroller systems that interface to a USB Host.</p>
<p><b>Attributes of the USB Device Component:</b></p>
<ul>
<li>Supports <a class="el" href="_u_s_b__transfer__rates.html">Low-Speed</a>, <a class="el" href="_u_s_b__transfer__rates.html">Full-Speed</a> and <a class="el" href="_u_s_b__transfer__rates.html">High-Speed</a>.</li>
<li>Supports standard <a class="el" href="_u_s_b__classes.html">USB Classes</a> with multiple device class instances.</li>
<li>Supports composite devices. Combine USB Device Classes to create a <a class="el" href="dev_comp_tutorial.html">composite device</a>.</li>
<li>Supports multiple USB Devices on a single microcontroller with more than one USB Device controller.</li>
<li>Provides <script>link_ext('uv4_ca_sourcefiles');</script> for implementing the USB Device functionality.</li>
<li>Provides an user-friendly configuration file for each device class to generate <a class="el" href="_u_s_b__descriptors.html">USB Descriptors</a>.</li>
<li>Flexibly assigns <a class="el" href="_u_s_b__endpoints.html">USB Endpoints</a> to the microcontroller USB Device peripheral.</li>
<li>Provides <a class="el" href="_u_s_b__device__tutorial.html">Examples</a> to show the use of the software stack.</li>
</ul>
<p>For interfacing to an USB Host Computer, additional software may be required. Page <a class="el" href="usb_sw_utilities.html">USB Host Computer Applications</a> shows an example for such a software running on Windows PCs.</p>
<h2>RTE Components </h2>
<p>The picture shows the relationship between RTE Components and the microcontroller's USB Device peripheral (USB Controller). RTE Components provide configuration files and user code templates. <b>Configuration files</b> configure the RTE Components, hardware interfaces, memory resources and USB Device driver parameters. They can have an impact on multiple RTE Components (for example RTE_Device.h configures the USB Controller 0 <em>and</em> Driver_USBD0). <b>User code templates</b> provide the skeleton for implementing the USB Device functionality.</p>
<p>The grey area around the RTE Components USB Device 1 and Driver_USBD1, as well as USB Controller 1 means that these components are optional and can only be used if a microcontroller device has multiple USB controllers present. If this is the case, an USB Device Class can be connected to any of the USB Device Instances.</p>
<div class="image">
<img src="usb_device_blocks_config_files.png" alt="usb_device_blocks_config_files.png"/>
<div class="caption">
USB Device Structure</div></div>
<p> USB Device peripherals can have one or more of the following USB Device Classes:</p>
<ul>
<li><a class="el" href="_a_d_c.html">Audio Device Class (ADC)</a> is used to exchange streaming audio data between the USB Host and the USB Device.</li>
<li><a class="el" href="_c_d_c.html">Communication Device Class (CDC)</a> provides virtual communication port functionality to the USB Host.</li>
<li><a class="el" href="_h_i_d.html">Human Interface Device (HID)</a> is typically used to implement a keyboard, joystick, or mouse. The HID Class can be also used for low bandwidth data exchange.</li>
<li><a class="el" href="_m_s_c.html">Mass Storage Class (MSC)</a> is used to connect various storage devices to an USB Host. Mass Storage Class media can be an SD card, internal or external Flash memory, or RAM.</li>
<li><a class="el" href="_custom_class.html">Custom Class</a> is used to implement either a standard or a vendor specific USB Device Class.</li>
</ul>
<p>Generic information about USB Device Classes can be found on the USB-IF's <a href="http://www.usb.org/developers/docs/devclass_docs/" class="el" target="_blank">Approved Class Specification Documents</a> page.</p>
<p>Multiple RTE Component instances can interface with more than one USB Controller or can implement multiple USB Device Classes. RTE Component instances are numbered. The number is appended to the RTE Component name, related configuration files, and user code templates. Each RTE Component has a separate configuration file. For example, for HID 0 and HID 1 the configuration files have the name <b>USB_Config_HID_0.h</b> and <b>USB_Config_HID_1.h</b>. </p>
<dl class="section note"><dt>Note</dt><dd>The default configuration settings are pre-configured for one instance of an USB Device or USB Device Class in a non-composite device peripheral. For other combinations the settings <em>need</em> to be edited to ensure proper operation. The <a class="el" href="dev_comp_tutorial.html">USB Composite Device</a> example shows how to implement and configure a composite devices</dd></dl>
<h1><a class="anchor" id="Creation_Steps"></a>
Create an Application</h1>
<p>The steps to create a microcontroller application that uses USB communication with an USB Device controller are:</p>
<ol type="1">
<li>Select <a class="el" href="_u_s_b__device.html#RTE_Software_Component_Selection">RTE Components</a> along with the USB Device Classes that are required for your application.</li>
<li><a class="el" href="_u_s_b__device.html#USB_Driver_Configuration">Enable and configure the USB Device Driver</a>.</li>
<li>Configure the <a class="el" href="_u_s_b__device.html#USB_Device_Configuration">USB Device</a> that connects the USB Middleware to the microcontroller USB peripheral.</li>
<li>Configure <a class="el" href="_u_s_b__device.html#USB_Device_Class_Configuration">USB Device Class Configuration and USB Endpoint Settings</a> for each selected USB Device Class and instance.</li>
<li>Configure the <a class="el" href="_u_s_b__device.html#usbd_system_resources">System Resources</a> according to the USB Device component's <a class="el" href="usb_resource_requirements.html#usbd_res_req">Resource Requirements</a>.</li>
<li>Implement the <a class="el" href="_u_s_b__device.html#User_Code_Implementation">Application Code</a> using code templates that are provided for the USB Device Classes.</li>
<li>If required by your application, you can <a class="el" href="_u_s_b__device.html#Overriding_Descriptors">change the default USB Device descriptors</a>.</li>
<li><a class="el" href="_u_s_b__device.html#usbd_debugging">Debug</a> you application using the built-in mechanisms of the USB Component.</li>
</ol>
<p>For interfacing to an USB Host computer, standard USB Device Classes drivers can be used. This may require additional software development for the USB Host application. An exemplary application for interfacing to an USB HID Device is explained <a class="el" href="usb_sw_utilities.html#hid_client_app">here</a>.</p>
<h2><a class="anchor" id="RTE_Software_Component_Selection"></a>
RTE Component Selection</h2>
<p>Only a few steps are necessary to complete the RTE Component selection:</p>
<ol type="1">
<li>From the USB Component:<ul>
<li>Select <b>USB:CORE</b> that provides the basic functionality required for USB communication.</li>
<li>Set <b>USB:Device</b> to '1'. This creates one USB Device for communication with the USB Host.</li>
<li>Select the desired USB Classes (HID, MSC, CDC, ADC, or Custom Class). For example, set <b>USB:Device:HID</b> to '1' to create a single HID Class Device. If you select more than one class or multiple instances of the same class on the same device, you will create a <b>Composite USB Device</b>.</li>
</ul>
</li>
<li>From the Drivers Component:<ul>
<li>Select an appropriate USB Device driver suitable for your application.</li>
</ul>
</li>
<li>From the Device Component:<ul>
<li>Additional device specific drivers may be required according to the validation output.</li>
</ul>
</li>
<li>From the CMSIS Component:<ul>
<li>Select the <b>CMSIS:CORE</b> to provide the core interface to the processor.</li>
<li>Select a suitable <b>CMSIS:RTOS</b> or <b>CMSIS:RTOS2</b> that is a required for the application.</li>
</ul>
</li>
</ol>
<div class="image">
<img src="rteusbx.png" alt="rteusbx.png"/>
<div class="caption">
RTE Component Selection</div></div>
 <dl class="section note"><dt>Note</dt><dd><ul>
<li>Most microcontrollers have only one USB Controller implemented in hardware and only one driver <b>Driver_USBD0</b> is available. In this case, only one <b>USB:Device</b> can be selected to generate <b>USB Device 0</b>.</li>
<li>On a single <b>USB Device 0</b> an USB Composite Device may be implemented that combines multiple USB Device Classes.</li>
<li>When a microcontroller implements multiple USB Controllers an additional <b>USB Device 1</b> can be generated by setting <b>USB:Device</b> to '2'.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="USB_Driver_Configuration"></a>
USB Driver and Controller</h2>
<p>The USB Device Driver and the USB Controller of the microcontroller need to be correctly configured. In particular this means:</p>
<ul>
<li><p class="startli">The USB Device Driver selected under the Drivers Component is typically configured with the <b>RTE_Device.h</b> configuration file. While this file provides multiple options, it is typically sufficient to enable the USB Device peripheral related to this driver. Some microcontrollers may require settings that are related to a physical layer interface <b></b>(PHY). The picture below shows two possible variants. Either, the USB PHY is integrated into the controller, or an external chip is used for providing the USB signal lines:</p>
<div class="image">
<img src="usb_phy.png" alt="usb_phy.png"/>
<div class="caption">
USB Controller and PHY Setups</div></div>
</li>
<li>The USB Controller of the microcontroller typically needs specific clock settings. Consult the user's guide of the microcontroller to understand the requirements. Alternatively, you may copy the setup of an USB Device example (in case your hardware setup is similar to that of the chosen evaluation boards).</li>
</ul>
<h2><a class="anchor" id="USB_Device_Configuration"></a>
USB Device Configuration</h2>
<p>The configuration file <b>USBD_Config_<em>n</em>.c</b> is listed in the Project Windows under the Component USB and contains a number of important settings for the specific USB Device.</p>
<ul>
<li>The <b>Driver_USBD#</b> number is set according to the selected USB Controller. This specifies which driver will be used for the USB Device determining the pin-out as well. For single USB Device Controllers it will be '0'.</li>
<li><b>High-Speed</b> may be selected if supported by the USB Controller.</li>
<li>The <b>Vendor</b> <b>ID</b> (VID) needs to be set to a private VID. The default Vendor ID is owned by Keil and must not be used for actual products. Please visit <a href="http://www.usb.org/developers/vendor/" class="el" target="_blank">USB-IF</a> for more information on how to apply for a valid Vendor ID.</li>
<li>Every device variant needs an unique <b>Product</b> <b>ID</b>. Together with the <b>VID</b>, it is used by the Host computer's operating system to find a driver for your device.</li>
<li>The <b>Device Release Number</b> will be shown in Windows and Linux systems as “Firmware Revision”. The number will be interpreted as “binary coded decimal”, meaning that 0x0101 will be shown as firmware revision 1.01.</li>
<li>The <b>Manufacturer</b>, <b>Product</b> and the <b>Serial</b> <b>Number</b> <b>String</b> can be set to identify the USB Device on the USB Host.</li>
</ul>
<p>Refer to <a class="el" href="group__usbd__core_functions__conf.html">USB Core Configuration</a> for more configuration options of the USB Device.</p>
<dl class="section note"><dt>Note</dt><dd>You can configure the USB Device at run-time using the functions from the <a class="el" href="group__usbd__core_functions__api.html">USB Device Core API</a>. The section <a class="el" href="group__usbd__core_functions.html">USB Device Core</a> explains the details. Implement the run-time specific behavior with the user code template <a class="el" href="group__usbd__class_functions.html#USBD_User_Device_UCT">USBD_User_Device_n.c</a>.</dd></dl>
<h2><a class="anchor" id="USB_Device_Class_Configuration"></a>
USB Device Class Configuration and USB Endpoint Settings</h2>
<p>The USB Device Class Parameters and Endpoint Settings are configured in separate files for each USB Device Class and separately for each instance. The configuration files contain Device Class specific Endpoint Settings Numbers and are listed in the Project Window under the Component USB.</p>
<ul>
<li><b>USBD_Config_ADC_<em>n</em>.h</b> configuration for Audio Device Class (ADC).</li>
<li><b>USBD_Config_CDC_<em>n</em>.h</b> configuration for Communication Device Class (CDC).</li>
<li><b>USBD_Config_HID_<em>n</em>.h</b> configuration for Human Interface Device Class (HID).</li>
<li><b>USBD_Config_MSC_<em>n</em>.h</b> configuration for Mass Storage Device Class (MSC).</li>
<li><b>USBD_Config_CustomClass_<em>n</em>.h</b> configuration for Custom Class.</li>
</ul>
<p>Each <a class="el" href="_u_s_b__endpoints.html">USB Endpoint</a> can only be used once on the same USB Device. It has to be made sure that the different USB Device Classes or multiple instances of the same USB Device Class use different Endpoints. The default configuration supports applications that use a single USB Device Class. The remaining parameters are specific settings that configure parameters for USB communication speed and the USB Device Class.</p>
<h2><a class="anchor" id="usbd_system_resources"></a>
System Resource Configuration</h2>
<p>For proper operation, the USB Device Component requires some system configuration settings. The requirements are:</p>
<ul>
<li>Additional <b>stack</b> size of <b>512 bytes</b>. This can be configured in the device's <script>link_ext('startup_device');</script> file (<code>Stack_Size</code>).</li>
<li>The USB Device Component uses CMSIS-RTOS threads. In case <b>RTX v5</b> is used <b>no changes to RTX settings</b> are necessary as all resources are allocated statically. In case <b>RTX v4</b> is used you need to change following settings in <script>link_ext('RTX-Conf-CM4');</script> file:<ul>
<li>Increase the <b>Number of concurrent running user threads</b> by number of threads required by USB Device</li>
<li>Increase the <b>Number of threads with user-provided stack size</b> by number of threads required by USB Device</li>
<li>Increase <b>Total stack size [bytes] for threads with user-provided stack size</b> by size of threads required by USB Device</li>
<li>Enable <b>User Timers</b> if HID class is used</li>
</ul>
</li>
</ul>
<p>For more information, check the USB Device component's <a class="el" href="usb_resource_requirements.html#usbd_res_req">Resource Requirements</a> section.</p>
<h2><a class="anchor" id="User_Code_Implementation"></a>
User Code Implementation</h2>
 <script>link_ext('uv4_ca_sourcefiles');</script> files provide function templates used to implement USB Device Class functionality. The available functions are explained in the <a class="el" href="group__usbd___dev_class_functions.html">Reference</a> section of the USB Component. These routines can be adapted to the needs of the microcontroller application, in case different then default functionality is needed.</p>
<p>The following templates are available for the USB Device component: </p>
<table class="doxtable">
<tr>
<th>Template Name </th><th>Purpose  </th></tr>
<tr>
<td><a class="el" href="group__usbd__adc_functions.html#USBD_User_ADC_UCT">USBD_User_ADC_n.c</a> </td><td>Required functions to create an ADC device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__cdc_functions__acm.html#USBD_User_CDC_ACM_UCT">USBD_User_CDC_ACM_n.c</a> </td><td>Required functions to create a CDC (ACM) device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__cdc_functions__acm.html#USBD_User_CDC_ACM_RNDIS_VETH_UCT">USBD_User_CDC_ACM_RNDIS_VETH_n.c</a> </td><td>Required functions to create a CDC (ACM) RNDIS virtual Ethernet device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__cdc_functions__acm.html#USBD_User_CDC_ACM_RNDIS_ETH_UCT">USBD_User_CDC_ACM_RNDIS_ETH_n.c</a> </td><td>Required functions to create a CDC (ACM) RNDIS and Ethernet bridge device (Ethernet-over-USB). </td></tr>
<tr>
<td><a class="el" href="group__usbd__cdc_functions__acm.html#USBD_User_CDC_ACM_UART_UCT">USBD_User_CDC_ACM_UART_n.c</a> </td><td>Required functions to create a CDC (ACM) device demonstrating a USB &lt;-&gt; UART bridge. </td></tr>
<tr>
<td><a class="el" href="group__usbd__cdc_functions__ncm.html#USBD_User_CDC_NCM_UCT">USBD_User_CDC_NCM_n.c</a> </td><td>Required functions to create a CDC (NCM) device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__cdc_functions__ncm.html#USBD_User_CDC_NCM_ETH_UCT">USBD_User_CDC_NCM_ETH_n.c</a> </td><td>Required functions to create a CDC (NCM) device (Ethernet-over-USB). </td></tr>
<tr>
<td><a class="el" href="group__usbd__class_functions.html#USBD_User_Cust_UCT">USBD_User_CustomClass_n.c</a> </td><td>Required functions to create a device supporting a custom USB Device class. </td></tr>
<tr>
<td><a class="el" href="group__usbd__class_functions.html#USBD_User_Device_UCT">USBD_User_Device_n.c</a> </td><td>Required functions for run-time configuration of the USB Device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__core_functions.html#USBD_User_Device_SerNum_UCT">USBD_User_SerNum_n.c</a> </td><td>Example for run-time configuration: Changing the serial number of the USB Device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__hid_functions.html#USBD_User_HID_UCT">USBD_User_HID_n.c</a> </td><td>Required functions to create a HID device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__hid_functions.html#USBD_User_HID_Mouse_UCT">USBD_User_HID_Mouse_n.c</a> </td><td>Implements functions to create a USB HID device acting as a mouse pointer input device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__msc_functions.html#USBD_User_MSC_UCT">USBD_User_MSC_n.c</a> </td><td>Required functions to create a MSC device. </td></tr>
<tr>
<td><a class="el" href="group__usbd__msc_functions.html#USBD_MSC_UCT">USBD_MSC_n.c</a> </td><td>Shows how to get access to storage media either from the application/File System or from the USB host. </td></tr>
</table>
<h2><a class="anchor" id="Overriding_Descriptors"></a>
Changing Default USB Descriptors</h2>
<p>If there are different requirements regarding the <a class="el" href="_u_s_b__descriptors.html">USB Descriptors</a> than the USB Component allows, a user can change any or all of the default USB descriptors. Default descriptors are the ones that library creates based on <a class="el" href="_u_s_b__device.html#USB_Device_Configuration">Device</a> and <a class="el" href="_u_s_b__device.html#USB_Device_Class_Configuration">Classes</a> configuration file settings and are located in code memory.</p>
<p>The descriptors can be changed in two of the following ways:</p>
<ul>
<li><b>Static change</b></li>
</ul>
<p>Static change of descriptors can be done to replace default descriptors if they will not change at runtime. The descriptors can be easily overridden by user code by creating descriptors with the same name.</p>
<table class="doxtable">
<tr>
<th>USB Device Descriptor </th><th>Purpose  </th></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_ep0_descriptor</code>[] </td><td>Control Endpoint 0 descriptor </td></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_device_descriptor</code>[] </td><td>USB Device descriptor </td></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_string_descriptor</code>[] </td><td>String descriptors </td></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_device_qualifier_fs</code>[] </td><td>Device qualifier for low/full-speed </td></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_device_qualifier_hs</code>[] </td><td>Device qualifier for high-speed </td></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_config_descriptor_fs</code>[] </td><td>Configuration descriptor for low/full-speed </td></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_config_descriptor_hs</code>[] </td><td>Configuration descriptor for high-speed </td></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_other_speed_config_descriptor_fs</code>[] </td><td>Other speed configuration descriptor for low/full-speed </td></tr>
<tr>
<td><code>const</code> <code>uint8_t</code> <code>usbdn_other_speed_config_descriptor_hs</code>[] </td><td>Other speed configuration descriptor for high-speed </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd><ul>
<li><code>n</code> in <code>usbdn_</code> represents the USB Device instance. So for the USB Device 0 instance, you have to use <code>usbd0_</code>...</li>
</ul>
</dd></dl>
<p><b>Code Example</b> </p>
<div class="fragment"><div class="line"><span class="comment">// Statically change USB Device 0 Device Descriptor</span></div>
<div class="line"><span class="keyword">const</span> uint8_t usbd0_device_descriptor[] = { </div>
<div class="line">  18U,         <span class="comment">// bLength = 7 bytes</span></div>
<div class="line">  1U,          <span class="comment">// bDescriptorType = 1 = Device Descriptor Type</span></div>
<div class="line">  0U,2U,       <span class="comment">// bcdUSB = 2.00 (little-endian)</span></div>
<div class="line">  0U,          <span class="comment">// bDeviceClass = 0 = Defined in interface</span></div>
<div class="line">  0U,          <span class="comment">// bDeviceSubClass = 0 = Defined in interface</span></div>
<div class="line">  0U,          <span class="comment">// bDeviceProtocol = 0 = Defined in interface</span></div>
<div class="line">  64U,         <span class="comment">// bMaxPacketSize = 64</span></div>
<div class="line">  0x51U,0xC2U, <span class="comment">// idVendor = 0xC251 (little-endian)</span></div>
<div class="line">  0x34U,0x12U, <span class="comment">// idProduct = 0x1234 (little-endian)</span></div>
<div class="line">  0U,1U,       <span class="comment">// bcdDevice = 1.00 (little-endian)</span></div>
<div class="line">  0U,          <span class="comment">// iManufacturer = 0 = No Manufacturer string</span></div>
<div class="line">  0U,          <span class="comment">// iProduct = 0 = No Product string</span></div>
<div class="line">  0U,          <span class="comment">// iSerialNumber = 0 = No Serial Number string</span></div>
<div class="line">  1U           <span class="comment">// bNumConfigurations = 1 = 1 configuration</span></div>
<div class="line">};</div>
</div><!-- fragment --><ul>
<li><b>Dynamic change</b></li>
</ul>
<p>Dynamic change of descriptors can be done to change descriptors at runtime. The <code>struct</code> <b>usbd_desc_t</b> contains the required information. It is stored in RAM and contains pointers to the USB descriptors. If you change the pointers in the structure to the point to the externally created ones, you can change the descriptors at runtime.</p>
<p>The actual variable names of the structures holding descriptor pointers are <code>usbdn_desc</code> (n indicating the USB Device instance number). The following code example shows how to override the device descriptor for the <b>USB Device 0</b> (<code>usbd0_desc</code>):</p>
<p><b>Code Example</b> </p>
<div class="fragment"><div class="line"><span class="comment">// Dynamically change USB Device 0 Device Descriptor</span></div>
<div class="line"><span class="keyword">const</span> uint8_t dev0_device_descriptor[] = { </div>
<div class="line">  18U,         <span class="comment">// bLength = 7 bytes</span></div>
<div class="line">  1U,          <span class="comment">// bDescriptorType = 1 = Device Descriptor Type</span></div>
<div class="line">  0U,2U,       <span class="comment">// bcdUSB = 2.00 (little-endian)</span></div>
<div class="line">  0U,          <span class="comment">// bDeviceClass = 0 = Defined in interface</span></div>
<div class="line">  0U,          <span class="comment">// bDeviceSubClass = 0 = Defined in interface</span></div>
<div class="line">  0U,          <span class="comment">// bDeviceProtocol = 0 = Defined in interface</span></div>
<div class="line">  64U,         <span class="comment">// bMaxPacketSize = 64</span></div>
<div class="line">  0x51U,0xC2U, <span class="comment">// idVendor = 0xC251 (little-endian)</span></div>
<div class="line">  0x34U,0x12U, <span class="comment">// idProduct = 0x1234 (little-endian)</span></div>
<div class="line">  0U,1U,       <span class="comment">// bcdDevice = 1.00 (little-endian)</span></div>
<div class="line">  0U,          <span class="comment">// iManufacturer = 0 = No Manufacturer string</span></div>
<div class="line">  0U,          <span class="comment">// iProduct = 0 = No Product string</span></div>
<div class="line">  0U,          <span class="comment">// iSerialNumber = 0 = No Serial Number string</span></div>
<div class="line">  1U           <span class="comment">// bNumConfigurations = 1 = 1 configuration</span></div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> usbd_desc_t usbd0_desc;</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> main (<span class="keywordtype">void</span>) {</div>
<div class="line"> </div>
<div class="line">...</div>
<div class="line">usbd0_desc.device_descriptor = (uint8_t *)dev0_device_descriptor;</div>
<div class="line">...</div>
<div class="line"> </div>
<div class="line">}</div>
</div><!-- fragment --><dl class="section note"><dt>Note</dt><dd>For changing just serial number string use function <a class="el" href="group__usbd__core_functions__api.html#ga3ccf0ff5b34716f104e3891158b5c6d6">USBD_SetSerialNumber</a>!</dd>
<dd>
For non high-speed capable device following descriptors are not important:<ul>
<li><a class="el" href="_u_s_b__device__qualifier__descriptor.html">Device Qualifier Descriptor</a> for low/full-speed</li>
<li><a class="el" href="_u_s_b__device__qualifier__descriptor.html">Device Qualifier Descriptor</a> for high-speed</li>
<li><a class="el" href="_u_s_b__configuration__descriptor.html">Configuration Descriptor</a> for low/full-speed</li>
<li><a class="el" href="_u_s_b__configuration__descriptor.html">Configuration Descriptor</a> for high-speed</li>
<li>Other speed <a class="el" href="_u_s_b__configuration__descriptor.html">Configuration Descriptor</a> for low/full-speed</li>
<li>Other speed <a class="el" href="_u_s_b__configuration__descriptor.html">Configuration Descriptor</a> high-speed</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="usbd_debugging"></a>
Debugging</h2>
<p>USB Device Component is distributed in library form and doesn't allow direct code debug. However it can be easily configured to generate debug events and provide dynamic visibility to the component operation.</p>
<p>Following variants can be selected for the <b>USB:CORE</b> component in the <b>Manage Run-Time Environment</b> window:</p>
<ul>
<li><b>Debug</b>: this variant supports event annotations for the <script>link_ext('Event-Recorder-About');</script> and makes it very easy to analyze the internal operation of the USB Device Component during application debug. <a class="el" href="_u_s_b__device.html#usbDevEvrSupport">Event Recorder Support</a> below explains how to configure and use this variant.</li>
<li><b>Release</b>: this variant does not include additional debugging code. Use this variant when deploying the application.</li>
</ul>
<p>The figure below shows selection of the <b>Debug</b> variant. </p>
<div class="image">
<img src="usbd_debug_variant.png" alt="usbd_debug_variant.png"/>
</div>
<p>The <a class="el" href="group__usbd__evr.html">USB Device:Debug Events</a> describes the events implemented in the USB Device Component.</p>
<p><a class="anchor" id="usbDevEvrSupport"></a></p>
<h2>Event Recorder Support </h2>
 <script>link_ext('Event-Recorder-About');</script> is a powerful tool that provides visibility to the dynamic execution of the program.</p>
<p>The USB Device Component generates <a class="el" href="group__usbd__evr.html">a broad set of Debug Events</a> for the Event Recorder and implements required infrastructure to interface with it.</p>
<p>To use the Event Recorder it is required to create an image with event generation support. The necessary steps are:</p>
<ol type="1">
<li> <script>link_ext('Debug-Variant-Select');</script>: in the RTE management dialog select the <b>Debug</b> variant for the <b>USB:CORE</b> software component.</li>
<li> <script>link_ext('Event-Recorder-Enable');</script>: in the RTE management dialog enable the software component <b>Compiler:Event Recorder</b>.</li>
<li>Ensure that Event Recorder is initialized preferably by <script>link_ext('RTX5-Event-Recorder-Config');</script> if CMSIS-RTOS2 RTX v5 is used, or alternatively by calling the function <script>link_ext('Event-Recorder-Initialize-Func');</script> in the application code.</li>
<li><a class="el" href="_u_s_b__device.html#usbDevEvrConfig">Event Recorder Configuration</a>: if necessary, adjust default Event Recorder configuration.</li>
<li>Build the application code, download it to the target hardware and start debug session.</li>
</ol>
<p>Now, when the USB Device generates event information, it can be viewed in the <script>link_ext('uv4-Event-Recorder');</script>.</p>
<p><a class="anchor" id="usbDevEvrConfig"></a></p>
<h2>Event Recorder Configuration </h2>
<p>This section describes the configuration settings for the Event Recorder. The usage requires the debug variant of the <b>USB:CORE</b> software component; refer to <a class="el" href="_u_s_b__device.html#usbDevEvrSupport">Event Recorder Support</a> for more information.</p>
<p><b>USB Event Generation Configuration</b></p>
<p>Selecting the <b>USB:CORE</b> debug variant will add the file <code>USB_Debug.c</code> to your project. Use this file to set the event generation configuration for USB core, drivers, and device classes separately. The file is available for USB Device and Host components.</p>
<div class="image">
<img src="USBD_USB_Debug_c.png" alt="USBD_USB_Debug_c.png"/>
<div class="caption">
USB_Debug.c file for event generation configuration</div></div>
<p> The following settings are available for event generation configuration of each module:</p>
<ul>
<li><b>Off</b> means no events will be generated by the module</li>
<li><b>Errors</b> means only error events will be generated by the module</li>
<li><b>Errors + API</b> means error and API call events will be generated by the module</li>
<li><b>All</b> means all available events will be generated by the module. Besides error and API call events, this contains operation and detailed events.</li>
</ul>
<p><b>Event IDs</b></p>
<p>The USB Device component uses the following event IDs: </p>
<table class="doxtable">
<tr>
<th>Component </th><th>Event ID  </th></tr>
<tr>
<td>USBD_Core </td><td>0xA0 </td></tr>
<tr>
<td>USBD_Driver </td><td>0xA1 </td></tr>
<tr>
<td>USBD_CC </td><td>0xA2 </td></tr>
<tr>
<td>USBD_ADC </td><td>0xA3 </td></tr>
<tr>
<td>USBD_CDC </td><td>0xA4 </td></tr>
<tr>
<td>USBD_HID </td><td>0xA5 </td></tr>
<tr>
<td>USBD_MSC </td><td>0xA6 </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue May 25 2021 13:57:46 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
