<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>CDC: Communication Device Class (NCM)</title>
<title>USB Component: CDC: Communication Device Class (NCM)</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">USB Component
   &#160;<span id="projectnumber">Version 6.15.0</span>
   </div>
   <div id="projectbrief">MDK Middleware for USB Device and Host Communication</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('group__usbd__cdc_functions__ncm.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#groups">Content</a>  </div>
  <div class="headertitle">
<div class="title">CDC: Communication Device Class (NCM)<div class="ingroups"><a class="el" href="group__usbd___dev_class_functions.html">Device Class</a></div></div>  </div>
</div><!--header-->
<div class="contents">

<p>Implement application specific behavior of a Communication Device Class (CDC) USB Device using the sub-class Network Control Model (NCM) for <a href="https://en.wikipedia.org/wiki/Ethernet_over_USB" target="_blank">Ethernet-over-USB</a> applications.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="groups"></a>
Content</h2></td></tr>
<tr class="memitem:group__usbd__cdc_functions__ncm__api"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__cdc_functions__ncm__api.html">User API</a></td></tr>
<tr class="memdesc:group__usbd__cdc_functions__ncm__api"><td class="mdescLeft">&#160;</td><td class="mdescRight">User API reference of the Communication Device Class (NCM). <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:group__usbd__cdc_functions__ncm__conf"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__usbd__cdc_functions__ncm__conf.html">Configuration</a></td></tr>
<tr class="memdesc:group__usbd__cdc_functions__ncm__conf"><td class="mdescLeft">&#160;</td><td class="mdescRight">Configuration of the USB Device CDC (NCM) Class in µVision. <br/></td></tr>
<tr class="separator:"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Description</h2>
<p>Implement application specific behavior of a Communication Device Class (CDC) USB Device using the sub-class Network Control Model (NCM) for <a href="https://en.wikipedia.org/wiki/Ethernet_over_USB" target="_blank">Ethernet-over-USB</a> applications. </p>
<p>The ability to connect Ethernet devices via USB ports is known as <b>Ethernet-over-USB</b>. Various industry protocols are available to achieve this. One of the most advanced protocols is the CDC (NCM) class which is supported by the USB Component.</p>
<p>The <a href="http://www.linux-usb.org/usbnet/" target="_blank">usbnet</a> Kernel module in Linux hosts enables you to attach a USB Device to the host to emulate an Ethernet device. There is no native Ethernet-over-USB support in Windows.</p>
<p>Refer to:</p>
<ul>
<li><a class="el" href="_c_d_c.html">CDC: Communication Device Class</a> for an overview of the CDC class.</li>
<li><a class="el" href="dev_cdc_ncm.html">Ethernet-over-USB (for Linux hosts)</a> example project.</li>
</ul>
<p>The USB Component allows multiple instances of the CDC class. This feature is used to create USB Composite Devices. Each CDC class instance has a separate files and interface functions:</p>
<ul>
<li>A CDC configuration file <a class="el" href="group__usbd__cdc_functions__ncm__conf.html">USBD_Config_CDC_n.h</a>.</li>
<li>An application-specific user source code file, which can be implemented with the <script>link_ext('uv4_ca_sourcefiles');</script> <a class="el" href="group__usbd__cdc_functions__ncm.html#USBD_User_CDC_NCM_UCT">USBD_User_CDC_NCM_n.c</a>, or <a class="el" href="group__usbd__cdc_functions__ncm.html#USBD_User_CDC_NCM_ETH_UCT">USBD_User_CDC_NCM_ETH_n.c</a>.</li>
<li>Functions that start with the prefix <b>USBD_CDCn_NCM</b> are available for each instance of a CDC NCM class.</li>
</ul>
<p>This documentation uses <em>n</em> as a placeholder for the instance number <em>0</em> - <em>7</em>. Most applications only require one instance of a CDC NCM class. For the first CDC NCM class instance the instance number is 0:</p>
<ul>
<li><b>USBD_Config_CDC_0.h</b></li>
<li><b>USBD_User_CDC_NCM_0.c</b></li>
<li>The function prefix is <b>USBD_CDC0_NCM</b></li>
</ul>
<p><b>Descriptor</b> <b>Requirements</b> The following descriptors are required in an USB CDC NCM Device:</p>
<ul>
<li>Standard Device Descriptor</li>
<li>Standard Configuration Descriptor</li>
<li>Interface Association Descriptor</li>
<li>CDC Header Functional Descriptor</li>
<li>CDC Union Functional Descriptor</li>
<li>CDC Ethernet Networking Functional Descriptor</li>
<li>NCM Functional Descriptor</li>
<li>Standard Interface Descriptor for the CDC Class communication interface</li>
<li>Standard Endpoint Descriptor for Interrupt IN endpoint</li>
<li>Standard Interface Descriptor for the CDC Class data interface</li>
<li>Standard Endpoint Descriptors for Bulk IN and Bulk OUT endpoints</li>
</ul>
<p>The necessary descriptors are automatically generated by the USB Middleware Component. The page <a class="el" href="_u_s_b__descriptors.html">USB Descriptors</a> provides more information on the topic.</p>
<p><b>Software Structure</b></p>
<p>The handling for the CDC class endpoint events is implemented in <b>USBD_CDCn_Int_Thread</b> and <b>USBD_CDCn_Bulk_Thread</b> which are started by <a class="el" href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca">USBD_Initialize</a>. Each instance of a CDC class runs an instance of <b>USBD_CDCn_Int_Thread</b> and <b>USBD_CDCn_Bulk_Thread</b>.</p>
<p>The thread USBD_CDCn_Int_Thread handles Interrupt IN Endpoint whereas the USBD_CDCn_Bulk_Thread handles the Bulk IN and Bulk OUT Endpoints.</p>
<div align="center">
<img src="msc_inline_mscgraph_4.png" alt="msc_inline_mscgraph_4" border="0" usemap="#msc_inline_mscgraph_4.map"/>
<map name="msc_inline_mscgraph_4.map" id="msc_inline_mscgraph_4.map"><area href="group__usbd__core_functions__api.html#ga65ba44a47e3fa46a15f70bab9917c8ca" shape="rect" coords="16,104,105,117" alt=""/>
<area href="group__usbd__core_functions__api.html#gad97153303fc0a6f51c1c20ac050b238f" shape="rect" coords="25,155,96,168" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" shape="rect" coords="16,250,105,263" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" shape="rect" coords="16,263,105,276" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f" shape="rect" coords="34,276,87,289" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" shape="rect" coords="16,314,105,327" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" shape="rect" coords="16,327,105,340" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55" shape="rect" coords="22,340,99,353" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae9c578e2dbb6b54b8963adee536aea11" shape="rect" coords="16,378,105,391" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae9c578e2dbb6b54b8963adee536aea11" shape="rect" coords="13,391,108,404" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae9fa4907d191f9e78483d588eef7081f" shape="rect" coords="16,410,105,423" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae9fa4907d191f9e78483d588eef7081f" shape="rect" coords="16,423,105,436" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" shape="rect" coords="16,442,105,455" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" shape="rect" coords="16,455,105,468" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d" shape="rect" coords="46,468,75,481" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gaf2b9c281b2f5ba8d26ea598633d5c9ad" shape="rect" coords="16,487,105,500" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gaf2b9c281b2f5ba8d26ea598633d5c9ad" shape="rect" coords="31,500,90,513" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga0731cb012344bc03b7132941e630a426" shape="rect" coords="16,519,105,532" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga0731cb012344bc03b7132941e630a426" shape="rect" coords="28,532,93,545" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae000e324025458f142e5b1d6d2750060" shape="rect" coords="16,570,105,583" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#gae000e324025458f142e5b1d6d2750060" shape="rect" coords="13,583,108,596" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445" shape="rect" coords="16,602,105,615" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445" shape="rect" coords="16,615,105,628" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445" shape="rect" coords="52,628,69,641" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" shape="rect" coords="16,647,105,660" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" shape="rect" coords="16,660,105,673" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5" shape="rect" coords="46,673,75,686" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga7ce93a9770eb6360bdd9d9c79be4f1b6" shape="rect" coords="16,692,105,705" alt=""/>
<area href="group__usbd__cdc_functions__ncm__api.html#ga7ce93a9770eb6360bdd9d9c79be4f1b6" shape="rect" coords="19,705,102,718" alt=""/>
<area href="group__usbd__core_functions__api.html#ga9440f139618900f2011034e70cd7a528" shape="rect" coords="16,756,105,769" alt=""/>
<area href="group__usbd__core_functions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="16,807,105,820" alt=""/>
<area href="group__usbd__core_functions__api.html#gabefe6dae72a49806a96b981c286d0aeb" shape="rect" coords="52,820,69,833" alt=""/>
</map>
</div>
<h2>Implementation </h2>
<p>To <a class="el" href="_u_s_b__device.html#Creation_Steps">create an USB Device</a> with a CDC NCM class:</p>
<ul>
<li>Set the required number for USB:Device:CDC class instances during the <a class="el" href="_u_s_b__device.html#RTE_Software_Component_Selection">RTE Component Selection</a>.</li>
<li>Set the parameters in the configuration file <a class="el" href="group__usbd__cdc_functions__ncm__conf.html">USBD_Config_CDC_n.h</a>.</li>
<li>Implement the application specific behavior using this <a class="el" href="group__usbd__cdc_functions__ncm.html#USBD_User_CDC_NCM_UCT">template</a> <em>or</em> </li>
<li>Use the pre-built <a class="el" href="group__usbd__cdc_functions__ncm.html#USBD_User_CDC_NCM_ETH_UCT">template file for Ethernet-over-USB</a>.</li>
</ul>
<p><a class="anchor" id="USBD_User_CDC_NCM_UCT"></a><b>User Code Template USBD_User_CDC_NCM.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (NCM) Device.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:CDC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_NCM_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Network Control Model (NCM) User module</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.0.6</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;USBD_Config_CDC_n.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define USB_CDC_NUM             n       </span><span class="comment">/* USB CDC Instance number */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#define MAX_IN_DATAGRAMS        10</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">wchar_t</span>  *wsMacAddress = USBD_CDCn_NCM_MAC_ADDRESS;</div>
<div class="line"><span class="keyword">static</span>       uint8_t     MacAddress[6];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint16_t LinkState;</div>
<div class="line"><span class="keyword">static</span> uint32_t LinkSpeed;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div>
<div class="line">  uint32_t ntb_input_size;</div>
<div class="line">  uint16_t ntb_format;</div>
<div class="line">  uint16_t max_datagram_size;</div>
<div class="line">  uint16_t crc_mode;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  uint8_t  net_address[6];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#if (USBD_CDCn_NCM_W_NUMBER_MC_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  uint8_t  mc_filters[6*(USBD_CDCn_NCM_W_NUMBER_MC_FILTERS &amp; 0x7FFF)];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#if (USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  uint8_t  power_filter_active[(USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS + 7)/8];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  uint16_t packet_filter_bitmap;</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_BM_ETHERNET_STATISTICS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t eth_statistics[29];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>} NCM_State;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t FrameIN_Size;</div>
<div class="line"><span class="keyword">static</span> uint8_t  FrameIN [USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE];</div>
<div class="line"><span class="keyword">static</span> uint8_t  FrameOUT[USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE];</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread     (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread    (<span class="keywordtype">void</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> osRtxThread_t        connection_thread_cb_mem           __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t             connection_thread_stack_mem[512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        data_in_thread_cb_mem              __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t             data_in_thread_stack_mem   [512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        data_out_thread_cb_mem             __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t             data_out_thread_stack_mem  [512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t connection_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;Connection_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;connection_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;connection_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t data_in_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;DataIN_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;data_in_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;data_in_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t data_out_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;DataOUT_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;data_out_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;data_out_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread     (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread    (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_Connection_Thread;</div>
<div class="line">osThreadDef(Connection_Thread, osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_DataIN_Thread;</div>
<div class="line">osThreadDef(DataIN_Thread,     osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_DataOUT_Thread;</div>
<div class="line">osThreadDef(DataOUT_Thread,    osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *Connection_ThreadId;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *DataIN_ThreadId;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *DataOUT_ThreadId;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// MAC Address conversion from wide string</span></div>
<div class="line"><span class="comment">// \param[in]   wstr    Pointer to wide string.</span></div>
<div class="line"><span class="comment">// \param[out]  addr    Pointer to address.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> MAC_wstr_to_addr (<span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *wstr, uint8_t *addr) {</div>
<div class="line">  uint8_t  c;</div>
<div class="line">  uint8_t  n;</div>
<div class="line">  uint32_t i;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0U; i &lt; 12U; i++) {</div>
<div class="line">    c = (uint8_t)wstr[i];</div>
<div class="line">    <span class="keywordflow">if</span>        ((c &gt;= <span class="charliteral">&#39;0&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;9&#39;</span>)) {</div>
<div class="line">      n = c - <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;A&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;F&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;A&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;a&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;f&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;a&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      n = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((i &amp; 1U) != 0U) {</div>
<div class="line">      addr[i&gt;&gt;1] |= n;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      addr[i&gt;&gt;1]  = (uint8_t)((uint32_t)n &lt;&lt; 4);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (NCM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga5fd4c61b058d7478855d2eea82c03dab">USBD_CDCn_NCM_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for initialization</span></div>
<div class="line"> </div>
<div class="line">  MAC_wstr_to_addr(wsMacAddress, MacAddress);</div>
<div class="line"> </div>
<div class="line">  memset(&amp;NCM_State, 0, <span class="keyword">sizeof</span>(NCM_State));</div>
<div class="line">  NCM_State.ntb_input_size = USBD_CDCn_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  NCM_State.max_datagram_size = USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  memcpy(NCM_State.net_address, MacAddress, 6);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  NCM_State.packet_filter_bitmap = 0x0CU;</div>
<div class="line"> </div>
<div class="line">  LinkState = 0U;</div>
<div class="line">  LinkSpeed = 0U;</div>
<div class="line"> </div>
<div class="line">  FrameIN_Size = 0U;</div>
<div class="line">  memset(FrameIN, 0, <span class="keyword">sizeof</span>(FrameIN));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create Threads</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  Connection_ThreadId = osThreadNew(Connection_Thread, NULL, &amp;connection_thread_attr);</div>
<div class="line">  DataIN_ThreadId     = osThreadNew(DataIN_Thread,     NULL, &amp;data_in_thread_attr);</div>
<div class="line">  DataOUT_ThreadId    = osThreadNew(DataOUT_Thread,    NULL, &amp;data_out_thread_attr);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  Connection_ThreadId = osThreadCreate(osThread(Connection_Thread), NULL);</div>
<div class="line">  DataIN_ThreadId     = osThreadCreate(osThread(DataIN_Thread),     NULL);</div>
<div class="line">  DataOUT_ThreadId    = osThreadCreate(osThread(DataOUT_Thread),    NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (NCM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga83368d843269eaee8e5852ce835291f0">USBD_CDCn_NCM_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">  (void)osThreadTerminate(Connection_ThreadId);</div>
<div class="line">  (void)osThreadTerminate(DataIN_ThreadId);</div>
<div class="line">  (void)osThreadTerminate(DataOUT_ThreadId);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gaa0eded69e4418f2d6b45948fee84c8ea">USBD_CDCn_NCM_Reset</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for reset</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when USB Host changes data interface from alternate 0 to alternate 1 (activates data interface).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga2e3bccc42a3a46073533da3004481836">USBD_CDCn_NCM_Start</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for data interface activation</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osThreadFlagsSet(Connection_ThreadId, 1U);</div>
<div class="line">  (void)osThreadFlagsSet(DataIN_ThreadId,     1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osSignalSet(Connection_ThreadId, 1U);</div>
<div class="line">  (void)osSignalSet(DataIN_ThreadId,     1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when USB Host changes data interface from alternate 1 to alternate 0 (de-activates data interface).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga0fb025fb3475315f54f5a76375006927">USBD_CDCn_NCM_Stop</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for data interface de-activation</span></div>
<div class="line">  <span class="comment">// Explained in ncm10.pdf document from www.usb.org in paragraph 7.2</span></div>
<div class="line"> </div>
<div class="line">  FrameIN_Size = 0U;</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS</span></div>
<div class="line"><span class="preprocessor"></span>  osSignalClear(DataIN_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">  memset(&amp;NCM_State, 0, <span class="keyword">sizeof</span>(NCM_State));</div>
<div class="line">  NCM_State.ntb_input_size = USBD_CDCn_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  NCM_State.max_datagram_size = USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  memcpy(NCM_State.net_address, MacAddress, 6);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  NCM_State.packet_filter_bitmap = 0x0CU;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set the Ethernet device multicast filters.</span></div>
<div class="line"><span class="comment">// \param[in]   addr_list            Pointer to list of 48-bit Multicast addresses.</span></div>
<div class="line"><span class="comment">// \param[in]   num_of_filters       Number of filters.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gac376452779a524fb8b74f9684afeacaf">USBD_CDCn_NCM_SetEthernetMulticastFilters</a> (<span class="keyword">const</span> uint8_t *addr_list, uint16_t num_of_filters) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_W_NUMBER_MC_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (num_of_filters &gt; (USBD_CDCn_NCM_W_NUMBER_MC_FILTERS &amp; 0x7FFF)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  memcpy(NCM_State.mc_filters, addr_list, num_of_filters * 6);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)addr_list;</div>
<div class="line">  (void)num_of_filters;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set up the specified Ethernet power management pattern filter.</span></div>
<div class="line"><span class="comment">// \param[in]   filter_number        Filter number.</span></div>
<div class="line"><span class="comment">// \param[in]   pattern_filter       Power management pattern filter structure.</span></div>
<div class="line"><span class="comment">// \param[in]   pattern_filter_size  Size of pattern filter structure.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gacabf3368bcf30b530628d2f1c55aef8d">USBD_CDCn_NCM_SetEthernetPowerManagementPatternFilter</a> (uint16_t filter_number, <span class="keyword">const</span> uint8_t *pattern_filter, uint16_t pattern_filter_size) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (filter_number &gt;= USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  NCM_State.power_filter_active[filter_number / 8] |= 1U &lt;&lt; (filter_number % 8);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)filter_number;</div>
<div class="line">  (void)pattern_filter;</div>
<div class="line">  (void)pattern_filter_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve the status of the specified Ethernet power management pattern filter.</span></div>
<div class="line"><span class="comment">// \param[in]   filter_number        Filter number.</span></div>
<div class="line"><span class="comment">// \param[out]  pattern_active       Pointer to pattern active boolean.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga2b33946e39974bbb3dbc76adb0f42b70">USBD_CDCn_NCM_GetEthernetPowerManagementPatternFilter</a> (uint16_t filter_number, uint16_t *pattern_active) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  *pattern_active = (NCM_State.power_filter_active[filter_number / 8] &amp; (1U &lt;&lt; (filter_number % 8))) ? 1 : 0;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)filter_number;</div>
<div class="line">  (void)pattern_active;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to configure device Ethernet packet filter settings.</span></div>
<div class="line"><span class="comment">// \param[in]   packet_filter_bitmap Packet Filter Bitmap.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga2d8ff4045b0026c0be1ca7aa6cd58489">USBD_CDCn_NCM_SetEthernetPacketFilter</a> (uint16_t packet_filter_bitmap) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x01) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  NCM_State.packet_filter_bitmap = packet_filter_bitmap;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)packet_filter_bitmap;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve a statistic based on the feature selector.</span></div>
<div class="line"><span class="comment">// \param[in]   feature_selector     Feature Selector.</span></div>
<div class="line"><span class="comment">// \param[out]  data                 Pointer to Statistics Value.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga1125c952881c080ad9041033f7b62506">USBD_CDCn_NCM_GetEthernetStatistic</a> (uint16_t feature_selector, uint32_t *data) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_BM_ETHERNET_STATISTICS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (feature_selector == 0x00U) { <span class="keywordflow">return</span> <span class="keyword">true</span>;  }</div>
<div class="line">  <span class="keywordflow">if</span> (feature_selector &gt;  0x1DU) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  *data = NCM_State.eth_statistics[feature_selector - 1];</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)feature_selector;</div>
<div class="line">  (void)data;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve the parameters that describe NTBs for each direction.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_params           Pointer to NTB Parameter Structure.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga14fedc32c362e3b12d446cbc2a8be189">USBD_CDCn_NCM_GetNtbParameters</a> (CDC_NCM_NTB_PARAM *ntb_params) {</div>
<div class="line"> </div>
<div class="line">  ntb_params-&gt;wLength                 = <span class="keyword">sizeof</span>(CDC_NCM_NTB_PARAM);</div>
<div class="line">  ntb_params-&gt;bmNtbFormatsSupported   = USBD_CDCn_NCM_BM_NTB_FORMATS_SUPPORTED;</div>
<div class="line">  ntb_params-&gt;dwNtbInMaxSize          = USBD_CDCn_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  ntb_params-&gt;wNdpInDivisor           = USBD_CDCn_NCM_W_NDP_IN_DIVISOR;</div>
<div class="line">  ntb_params-&gt;wNdpInPayloadRemainder  = USBD_CDCn_NCM_W_NDP_IN_PAYLOAD_REMINDER;</div>
<div class="line">  ntb_params-&gt;wNdpInAlignment         = USBD_CDCn_NCM_W_NDP_IN_ALIGNMENT;</div>
<div class="line">  ntb_params-&gt;Reserved0               = 0U;</div>
<div class="line">  ntb_params-&gt;dwNtbOutMaxSize         = USBD_CDCn_NCM_DW_NTB_OUT_MAX_SIZE;</div>
<div class="line">  ntb_params-&gt;wNdpOutDivisor          = USBD_CDCn_NCM_W_NDP_OUT_DIVISOR;</div>
<div class="line">  ntb_params-&gt;wNdpOutPayloadRemainder = USBD_CDCn_NCM_W_NDP_OUT_PAYLOAD_REMINDER;</div>
<div class="line">  ntb_params-&gt;wNdpOutAlignment        = USBD_CDCn_NCM_W_NDP_OUT_ALIGNMENT;</div>
<div class="line">  ntb_params-&gt;Reserved1               = 0U;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the USB Device’s current EUI-48 station address.</span></div>
<div class="line"><span class="comment">// \param[out]  net_addr             Pointer to EUI-48 current address, in network byte order.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae68496f58e710418dec862ca858cf6e6">USBD_CDCn_NCM_GetNetAddress</a> (uint8_t *net_addr) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  memcpy(net_addr, NCM_State.net_address, 6);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)net_addr;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set the USB Device’s current EUI-48 station address.</span></div>
<div class="line"><span class="comment">// \param[in]   net_addr             Pointer to EUI-48 address, in network byte order.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gafdaf7e6ad871cae664e72d4b675de4ce">USBD_CDCn_NCM_SetNetAddress</a> (<span class="keyword">const</span> uint8_t *net_addr) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  memcpy(NCM_State.net_address, net_addr, 6);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)net_addr;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the NTB data format currently being used.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_format           Pointer to NTB format code.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga76fef9a918909a02d4b9b579fe1a9ff6">USBD_CDCn_NCM_GetNtbFormat</a> (uint16_t *ntb_format) {</div>
<div class="line">  *ntb_format = NCM_State.ntb_format;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the format of NTB to be used for NTBs transmitted to the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   ntb_format           NTB format selection:</span></div>
<div class="line"><span class="comment">//                - value 0 :        NTB-16</span></div>
<div class="line"><span class="comment">//                - value 1 :        NTB-32</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga9dd16928bb606f3ce546759fa6f66438">USBD_CDCn_NCM_SetNtbFormat</a> (uint16_t ntb_format) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_BM_NTB_FORMATS_SUPPORTED &gt; 1)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (ntb_format &gt; 1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (ntb_format &gt; 0) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  NCM_State.ntb_format = ntb_format;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return NTB input size currently being used.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_input_size       Pointer to NTB input size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gad93f53bc5f3e767f4afc1d36e130cb94">USBD_CDCn_NCM_GetNtbInputSize</a> (uint32_t *ntb_input_size) {</div>
<div class="line">  *ntb_input_size = NCM_State.ntb_input_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the maximum size of NTB that is permitted to be sent to the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   ntb_input_size       Maximum NTB size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga8dae0db40ccc745c8221b92082aa145a">USBD_CDCn_NCM_SetNtbInputSize</a> (uint32_t ntb_input_size) {</div>
<div class="line">  <span class="keywordflow">if</span> (ntb_input_size &gt; USBD_CDCn_NCM_DW_NTB_IN_MAX_SIZE) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.ntb_input_size = ntb_input_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the currently effective maximum datagram size.</span></div>
<div class="line"><span class="comment">// \param[out]  max_datagram_size    Pointer to current maximum datagram size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga0150ca9d0e0d1cd5bcc50bf37773ad39">USBD_CDCn_NCM_GetMaxDatagramSize</a> (uint16_t *max_datagram_size) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x08) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  *max_datagram_size = NCM_State.max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the maximum datagram size that can be sent in an NTB.</span></div>
<div class="line"><span class="comment">// \param[in]   max_datagram_size    Maximum datagram size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gafe4f737f31184318f2ec060db9b526ca">USBD_CDCn_NCM_SetMaxDatagramSize</a> (uint16_t max_datagram_size) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x08) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (max_datagram_size &gt; USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.max_datagram_size = max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the currently selected CRC mode.</span></div>
<div class="line"><span class="comment">// \param[out]  crc_mode             Pointer to current CRC mode.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga3a495bcfef9ebab08d044b67b6f89e80">USBD_CDCn_NCM_GetCrcMode</a> (uint16_t *crc_mode) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x10) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  *crc_mode = NCM_State.crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to control CRC mode.</span></div>
<div class="line"><span class="comment">// \param[in]   crc_mode             CRC mode:</span></div>
<div class="line"><span class="comment">//                - value 0 :        CRCs shall not be appended</span></div>
<div class="line"><span class="comment">//                - value 1 :        CRCs shall be appended</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gaaae74ae77df4b1f33e0a96768299eb95">USBD_CDCn_NCM_SetCrcMode</a> (uint16_t crc_mode) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x10) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (crc_mode &gt; 1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.crc_mode = crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when NTB was successfully sent.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga0731cb012344bc03b7132941e630a426">USBD_CDCn_NCM_NTB_IN_Sent</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osThreadFlagsSet(DataIN_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osSignalSet(DataIN_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when NTB was successfully received.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae000e324025458f142e5b1d6d2750060">USBD_CDCn_NCM_NTB_OUT_Received</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osThreadFlagsSet(DataOUT_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osSignalSet(DataOUT_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Thread handling ETH Connection</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#ifdef USB_CMSIS_RTOS</span></div>
<div class="line"><span class="preprocessor"></span>  osEvent            os_event;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t           event;</div>
<div class="line">  uint32_t           speed;</div>
<div class="line">  uint16_t           state;</div>
<div class="line">  int32_t            status;</div>
<div class="line"></div>
<div class="line">  (void)(arg);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">event</span> = osThreadFlagsWait(1U, osFlagsWaitAll, 500U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    os_event = osSignalWait(1U, 500U);</div>
<div class="line">    <span class="keywordflow">if</span> (os_event.status == osEventSignal) {</div>
<div class="line">      <span class="keyword">event</span> = (uint32_t)os_event.value.signals;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="keyword">event</span> = 0x80000000U;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">//  state = GetConnectionState();   // 0 = Disconnected, 1 = Connected</span></div>
<div class="line">    state = 1U;                     <span class="comment">// Emulate always connected</span></div>
<div class="line"><span class="comment">//  if (state == 1U) {</span></div>
<div class="line"><span class="comment">//    speed = GetConnectionSpeed();</span></div>
<div class="line">      speed = 100000000U;           <span class="comment">// Emulate 100M bsp link speed</span></div>
<div class="line"><span class="comment">//  } else {</span></div>
<div class="line"><span class="comment">//    speed = 0U;</span></div>
<div class="line"><span class="comment">//  }</span></div>
<div class="line">    <span class="keywordflow">if</span> (speed != LinkSpeed) {</div>
<div class="line">      LinkSpeed = speed;</div>
<div class="line"><span class="comment">//    if (state == 1U) {</span></div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55">USBD_CDC_NCM_Notify_ConnectionSpeedChange</a>(USB_CDC_NUM, speed, speed);</div>
<div class="line">        } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afa5dfd259ecc4bbe016eaffb65838da4cb">usbDriverBusy</a>);</div>
<div class="line"><span class="comment">//    }</span></div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (state != LinkState) {</div>
<div class="line">      LinkState = state;</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f">USBD_CDC_NCM_Notify_NetworkConnection</a>(USB_CDC_NUM, state);</div>
<div class="line">      } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afa5dfd259ecc4bbe016eaffb65838da4cb">usbDriverBusy</a>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((event &amp; 0x80000000U) == 0U) {</div>
<div class="line">      <span class="keywordflow">if</span> (LinkState == 1U) {</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55">USBD_CDC_NCM_Notify_ConnectionSpeedChange</a>(USB_CDC_NUM, LinkSpeed, LinkSpeed);</div>
<div class="line">        } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afa5dfd259ecc4bbe016eaffb65838da4cb">usbDriverBusy</a>);</div>
<div class="line">      }</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f">USBD_CDC_NCM_Notify_NetworkConnection</a>(USB_CDC_NUM, LinkState);</div>
<div class="line">      } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afa5dfd259ecc4bbe016eaffb65838da4cb">usbDriverBusy</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Thread handling Data IN (ETH -&gt; USB)</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t size;</div>
<div class="line">  uint32_t len;</div>
<div class="line">   int32_t status;</div>
<div class="line"></div>
<div class="line">  (void)arg;</div>
<div class="line"></div>
<div class="line">  size = 0U;</div>
<div class="line">  len  = 0U;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osThreadFlagsWait(3U, osFlagsWaitAll, osWaitForever);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osSignalWait(3U, osWaitForever);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae9c578e2dbb6b54b8963adee536aea11">USBD_CDC_NCM_NTB_IN_Initialize</a>(USB_CDC_NUM);</div>
<div class="line">    <span class="keywordflow">if</span> (status != (int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afacfe6cb72ed8e7b8e95a38cbf95418dbf">usbOK</a>) { <span class="keywordflow">continue</span>; }</div>
<div class="line">    status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae9fa4907d191f9e78483d588eef7081f">USBD_CDC_NCM_NTB_IN_CreateNDP</a>(USB_CDC_NUM, MAX_IN_DATAGRAMS);</div>
<div class="line">    <span class="keywordflow">if</span> (status != (int32_t)usbOK) { <span class="keywordflow">continue</span>; }</div>
<div class="line">    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">      <span class="keywordflow">if</span> (FrameIN_Size != 0) {</div>
<div class="line">        (void)<a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d">USBD_CDC_NCM_NTB_IN_WriteDatagram</a>(USB_CDC_NUM, FrameIN, FrameIN_Size);</div>
<div class="line">        FrameIN_Size = 0;</div>
<div class="line">      }</div>
<div class="line"></div>
<div class="line">      (void)size;       <span class="comment">// Emulate No Data</span></div>
<div class="line">      (void)len;</div>
<div class="line"><span class="comment">//    size = GetDatagramSize();</span></div>
<div class="line"><span class="comment">//    if (size == 0U) {</span></div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"><span class="comment">//    }</span></div>
<div class="line"><span class="comment">//    if ((size &lt; 14U) || (size &gt; NCM_State.max_datagram_size)) {</span></div>
<div class="line"><span class="comment">//      ReadDatagram(NULL);  // Discard datagram</span></div>
<div class="line"><span class="comment">//      continue;</span></div>
<div class="line"><span class="comment">//    }</span></div>
<div class="line"><span class="comment">//    len = ReadDatagram(FrameIN);</span></div>
<div class="line"><span class="comment">//    if (len &gt; 0) {</span></div>
<div class="line"><span class="comment">//      status = USBD_CDC_NCM_NTB_IN_WriteDatagram(USB_CDC_NUM, FrameIN, len);</span></div>
<div class="line"><span class="comment">//      if (status != (int32_t)usbOK) {</span></div>
<div class="line"><span class="comment">//        FrameIN_Size = len;</span></div>
<div class="line"><span class="comment">//#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="comment">//        (void)osThreadFlagsSet(DataIN_ThreadId, 2U);</span></div>
<div class="line"><span class="comment">//#else</span></div>
<div class="line"><span class="comment">//        (void)osSignalSet(DataIN_ThreadId, 2U);</span></div>
<div class="line"><span class="comment">//#endif</span></div>
<div class="line"><span class="comment">//        break;</span></div>
<div class="line"><span class="comment">//      }</span></div>
<div class="line"><span class="comment">//    }</span></div>
<div class="line">    }</div>
<div class="line">    (void)<a class="code" href="group__usbd__cdc_functions__ncm__api.html#gaf2b9c281b2f5ba8d26ea598633d5c9ad">USBD_CDC_NCM_NTB_IN_Send</a>(USB_CDC_NUM);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Thread handling Data OUT (USB -&gt; ETH)</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t size;</div>
<div class="line">  int32_t  len, status;</div>
<div class="line"></div>
<div class="line">  (void)(arg);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osThreadFlagsWait(1U, osFlagsWaitAll, osWaitForever);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osSignalWait(1U, osWaitForever);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">      status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445">USBD_CDC_NCM_NTB_OUT_ProcessNDP</a>(USB_CDC_NUM);</div>
<div class="line">      <span class="keywordflow">if</span> (status != (int32_t)usbOK) { <span class="keywordflow">break</span>; }</div>
<div class="line">      <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        size = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga07e08df67e7fbc5a81f8ae9efabfc486">USBD_CDC_NCM_NTB_OUT_GetDatagramSize</a>(USB_CDC_NUM);</div>
<div class="line">        <span class="keywordflow">if</span> (size == 0U) { <span class="keywordflow">break</span>; }</div>
<div class="line">        <span class="keywordflow">if</span> ((size &lt; 14U) || (size &gt; NCM_State.max_datagram_size)) {</div>
<div class="line">          (void)<a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5">USBD_CDC_NCM_NTB_OUT_ReadDatagram</a>(USB_CDC_NUM, NULL, 0U);</div>
<div class="line">          <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        len = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5">USBD_CDC_NCM_NTB_OUT_ReadDatagram</a>(USB_CDC_NUM, FrameOUT, size);</div>
<div class="line">        <span class="keywordflow">if</span> (len &gt; 0) {</div>
<div class="line"><span class="comment">//        WriteDatagram(FrameOUT, len);</span></div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    (void)<a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga7ce93a9770eb6360bdd9d9c79be4f1b6">USBD_CDC_NCM_NTB_OUT_Release</a>(USB_CDC_NUM);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --><p><a class="anchor" id="USBD_User_CDC_NCM_ETH_UCT"></a><b>User Code Template USBD_User_CDC_NCM_ETH_n.c</b></p>
<p>The following source code contains all the required callback functions and can be used to implement the application specific behavior of a USB CDC (NCM) Device with Ethernet-over-USB functionality.</p>
<div class="fragment"><div class="line"><span class="comment">/*------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * MDK Middleware - Component ::USB:Device:CDC</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2004-2020 Arm Limited (or its affiliates). All rights reserved.</span></div>
<div class="line"><span class="comment"> *------------------------------------------------------------------------------</span></div>
<div class="line"><span class="comment"> * Name:    USBD_User_CDC_NCM_ETH_n.c</span></div>
<div class="line"><span class="comment"> * Purpose: USB Device Communication Device Class (CDC)</span></div>
<div class="line"><span class="comment"> *          Network Control Model (NCM) User module for an USB Ethernet Bridge</span></div>
<div class="line"><span class="comment"> * Rev.:    V1.0.8</span></div>
<div class="line"><span class="comment"> *----------------------------------------------------------------------------*/</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;stdio.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;string.h&gt;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;rl_usb.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH_MAC.h&quot;</span>             <span class="comment">// ::CMSIS Driver:Ethernet MAC</span></div>
<div class="line"><span class="preprocessor">#include &quot;Driver_ETH_PHY.h&quot;</span>             <span class="comment">// ::CMSIS Driver:Ethernet PHY</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBD_Config_CDC_n.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#define ETH_MAC_NUM             0       </span><span class="comment">/* ETH MAC Driver number */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define ETH_PHY_NUM             0       </span><span class="comment">/* ETH PHY Driver number */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define USB_CDC_NUM             n       </span><span class="comment">/* USB CDC Instance number */</span><span class="preprocessor"></span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#define MAX_IN_DATAGRAMS        10</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="keyword">extern</span> ARM_DRIVER_ETH_MAC ARM_Driver_ETH_MAC_(ETH_MAC_NUM);</div>
<div class="line"><span class="keyword">extern</span> ARM_DRIVER_ETH_PHY ARM_Driver_ETH_PHY_(ETH_PHY_NUM);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ARM_DRIVER_ETH_MAC *EthMac = &amp;ARM_Driver_ETH_MAC_(ETH_MAC_NUM);</div>
<div class="line"><span class="keyword">static</span> ARM_DRIVER_ETH_PHY *EthPhy = &amp;ARM_Driver_ETH_PHY_(ETH_PHY_NUM);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">wchar_t</span>   *wsMacAddress = USBD_CDCn_NCM_MAC_ADDRESS;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_MAC_ADDR   MacAddress;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> ARM_ETH_LINK_STATE LinkState;</div>
<div class="line"><span class="keyword">static</span> ARM_ETH_LINK_INFO  LinkInfo;</div>
<div class="line"><span class="keyword">static</span> uint32_t           LinkSpeed;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t           PacketFilter;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">struct </span>{</div>
<div class="line">  uint32_t ntb_input_size;</div>
<div class="line">  uint16_t ntb_format;</div>
<div class="line">  uint16_t max_datagram_size;</div>
<div class="line">  uint16_t crc_mode;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  uint8_t  net_address[6];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#if (USBD_CDCn_NCM_W_NUMBER_MC_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  uint8_t  mc_filters[6*(USBD_CDCn_NCM_W_NUMBER_MC_FILTERS &amp; 0x7FFF)];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#if (USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  uint8_t  power_filter_active[(USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS + 7)/8];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  uint16_t packet_filter_bitmap;</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_BM_ETHERNET_STATISTICS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t eth_statistics[29];</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>} NCM_State;</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> uint32_t FrameIN_Size;</div>
<div class="line"><span class="keyword">static</span> uint8_t  FrameIN [USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE];</div>
<div class="line"><span class="keyword">static</span> uint8_t  FrameOUT[USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE];</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> EthMac_Notify (uint32_t event);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread     (<span class="keywordtype">void</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread    (<span class="keywordtype">void</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> osRtxThread_t        connection_thread_cb_mem           __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t             connection_thread_stack_mem[512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        data_in_thread_cb_mem              __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t             data_in_thread_stack_mem   [512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="keyword">static</span> osRtxThread_t        data_out_thread_cb_mem             __SECTION(.bss.os.thread.cb);</div>
<div class="line"><span class="keyword">static</span> uint64_t             data_out_thread_stack_mem  [512/8] __SECTION(.bss.os.thread.stack);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t connection_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;Connection_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;connection_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;connection_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t data_in_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;DataIN_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;data_in_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;data_in_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> osThreadAttr_t data_out_thread_attr = {</div>
<div class="line">  <span class="stringliteral">&quot;DataOUT_Thread&quot;</span>,</div>
<div class="line">  0U,</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2_RTX5</span></div>
<div class="line"><span class="preprocessor"></span> &amp;data_out_thread_cb_mem,</div>
<div class="line">  <span class="keyword">sizeof</span>(osRtxThread_t),</div>
<div class="line"> &amp;data_out_thread_stack_mem[0],</div>
<div class="line">#<span class="keywordflow">else</span></div>
<div class="line">  NULL,</div>
<div class="line">  0U,</div>
<div class="line">  NULL,</div>
<div class="line">#endif</div>
<div class="line">  512U,</div>
<div class="line">  osPriorityNormal,</div>
<div class="line">  0U,</div>
<div class="line">  0U</div>
<div class="line">};</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread     (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread    (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg);</div>
<div class="line"> </div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_Connection_Thread;</div>
<div class="line">osThreadDef(Connection_Thread, osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_DataIN_Thread;</div>
<div class="line">osThreadDef(DataIN_Thread,     osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="keyword">extern</span> <span class="keyword">const</span> osThreadDef_t os_thread_def_DataOUT_Thread;</div>
<div class="line">osThreadDef(DataOUT_Thread,    osPriorityNormal, 1, NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *Connection_ThreadId;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *DataIN_ThreadId;</div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> *DataOUT_ThreadId;</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// MAC Address conversion from wide string</span></div>
<div class="line"><span class="comment">// \param[in]   wstr    Pointer to wide string.</span></div>
<div class="line"><span class="comment">// \param[out]  addr    Pointer to address.</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> MAC_wstr_to_addr (<span class="keyword">const</span> <span class="keywordtype">wchar_t</span> *wstr, uint8_t *addr) {</div>
<div class="line">  uint8_t  c;</div>
<div class="line">  uint8_t  n;</div>
<div class="line">  uint32_t i;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (i = 0U; i &lt; 12U; i++) {</div>
<div class="line">    c = (uint8_t)wstr[i];</div>
<div class="line">    <span class="keywordflow">if</span>        ((c &gt;= <span class="charliteral">&#39;0&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;9&#39;</span>)) {</div>
<div class="line">      n = c - <span class="charliteral">&#39;0&#39;</span>;</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;A&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;F&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;A&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c &gt;= <span class="charliteral">&#39;a&#39;</span>) &amp;&amp; (c &lt;= <span class="charliteral">&#39;f&#39;</span>)) {</div>
<div class="line">      n = c - (<span class="charliteral">&#39;a&#39;</span> + 10U);</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      n = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((i &amp; 1U) != 0U) {</div>
<div class="line">      addr[i&gt;&gt;1] |= n;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      addr[i&gt;&gt;1]  = (uint8_t)((uint32_t)n &lt;&lt; 4);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Initialize to initialize the USB CDC class instance (NCM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga5fd4c61b058d7478855d2eea82c03dab">USBD_CDCn_NCM_Initialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for initialization</span></div>
<div class="line">  ARM_ETH_MAC_CAPABILITIES capabilities;</div>
<div class="line">  int32_t                  status;</div>
<div class="line"> </div>
<div class="line">  MAC_wstr_to_addr(wsMacAddress, (uint8_t *)&amp;MacAddress);</div>
<div class="line"> </div>
<div class="line">  memset(&amp;NCM_State, 0, <span class="keyword">sizeof</span>(NCM_State));</div>
<div class="line">  NCM_State.ntb_input_size = USBD_CDCn_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  NCM_State.max_datagram_size = USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  memcpy(NCM_State.net_address, &amp;MacAddress, 6);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  NCM_State.packet_filter_bitmap = 0x0CU;</div>
<div class="line"> </div>
<div class="line">  LinkState = ARM_ETH_LINK_DOWN;</div>
<div class="line">  LinkInfo.speed  = 0U;</div>
<div class="line">  LinkInfo.duplex = 0U;</div>
<div class="line">  LinkSpeed = 0U;</div>
<div class="line"> </div>
<div class="line">  PacketFilter = ARM_ETH_MAC_ADDRESS_BROADCAST;</div>
<div class="line"> </div>
<div class="line">  FrameIN_Size = 0U;</div>
<div class="line">  memset(FrameIN, 0, <span class="keyword">sizeof</span>(FrameIN));</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize Media Access Controller</span></div>
<div class="line">  capabilities = EthMac-&gt;GetCapabilities();</div>
<div class="line"> </div>
<div class="line">  status = EthMac-&gt;Initialize(EthMac_Notify);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line">  status = EthMac-&gt;PowerControl(ARM_POWER_FULL);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line"> </div>
<div class="line">  status = EthMac-&gt;SetMacAddress(&amp;MacAddress);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Initialize Physical Media Interface</span></div>
<div class="line">  status = EthPhy-&gt;Initialize(EthMac-&gt;PHY_Read, EthMac-&gt;PHY_Write);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line">  status = EthPhy-&gt;PowerControl(ARM_POWER_FULL);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line">  status = EthPhy-&gt;SetInterface(capabilities.media_interface);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line">  status = EthPhy-&gt;SetMode(ARM_ETH_PHY_AUTO_NEGOTIATE);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Create Threads</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  Connection_ThreadId = osThreadNew(Connection_Thread, NULL, &amp;connection_thread_attr);</div>
<div class="line">  DataIN_ThreadId     = osThreadNew(DataIN_Thread,     NULL, &amp;data_in_thread_attr);</div>
<div class="line">  DataOUT_ThreadId    = osThreadNew(DataOUT_Thread,    NULL, &amp;data_out_thread_attr);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  Connection_ThreadId = osThreadCreate(osThread(Connection_Thread), NULL);</div>
<div class="line">  DataIN_ThreadId     = osThreadCreate(osThread(DataIN_Thread),     NULL);</div>
<div class="line">  DataOUT_ThreadId    = osThreadCreate(osThread(DataOUT_Thread),    NULL);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called during USBD_Uninitialize to de-initialize the USB CDC class instance (NCM).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga83368d843269eaee8e5852ce835291f0">USBD_CDCn_NCM_Uninitialize</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for de-initialization</span></div>
<div class="line">  (void)osThreadTerminate(Connection_ThreadId);</div>
<div class="line">  (void)osThreadTerminate(DataIN_ThreadId);</div>
<div class="line">  (void)osThreadTerminate(DataOUT_ThreadId);</div>
<div class="line"> </div>
<div class="line">  (void)EthPhy-&gt;PowerControl(ARM_POWER_OFF);</div>
<div class="line">  (void)EthPhy-&gt;Uninitialize();</div>
<div class="line"> </div>
<div class="line">  (void)EthMac-&gt;PowerControl(ARM_POWER_OFF);</div>
<div class="line">  (void)EthMac-&gt;Uninitialize();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Bus Reset Event.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gaa0eded69e4418f2d6b45948fee84c8ea">USBD_CDCn_NCM_Reset</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for reset</span></div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when USB Host changes data interface from alternate 0 to alternate 1 (activates data interface).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga2e3bccc42a3a46073533da3004481836">USBD_CDCn_NCM_Start</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for data interface activation</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osThreadFlagsSet(Connection_ThreadId, 1U);</div>
<div class="line">  (void)osThreadFlagsSet(DataIN_ThreadId,     1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osSignalSet(Connection_ThreadId, 1U);</div>
<div class="line">  (void)osSignalSet(DataIN_ThreadId,     1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when USB Host changes data interface from alternate 1 to alternate 0 (de-activates data interface).</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga0fb025fb3475315f54f5a76375006927">USBD_CDCn_NCM_Stop</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for data interface de-activation</span></div>
<div class="line">  <span class="comment">// Explained in ncm10.pdf document from www.usb.org in paragraph 7.2</span></div>
<div class="line"> </div>
<div class="line">  FrameIN_Size = 0U;</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS</span></div>
<div class="line"><span class="preprocessor"></span>  osSignalClear(DataIN_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line">  memset(&amp;NCM_State, 0, <span class="keyword">sizeof</span>(NCM_State));</div>
<div class="line">  NCM_State.ntb_input_size = USBD_CDCn_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  NCM_State.max_datagram_size = USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE;</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  memcpy(NCM_State.net_address, &amp;MacAddress, 6);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  NCM_State.packet_filter_bitmap = 0x0CU;</div>
<div class="line"> </div>
<div class="line">  PacketFilter = ARM_ETH_MAC_ADDRESS_BROADCAST;</div>
<div class="line"> </div>
<div class="line">  (void)EthMac-&gt;SetMacAddress(&amp;MacAddress);</div>
<div class="line">  (void)EthMac-&gt;SetAddressFilter(NULL, 0);</div>
<div class="line">  (void)EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                       (uint32_t)(LinkInfo.speed                           ) |</div>
<div class="line">                       (uint32_t)(LinkInfo.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                        PacketFilter);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set the Ethernet device multicast filters.</span></div>
<div class="line"><span class="comment">// \param[in]   addr_list            Pointer to list of 48-bit Multicast addresses.</span></div>
<div class="line"><span class="comment">// \param[in]   num_of_filters       Number of filters.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gac376452779a524fb8b74f9684afeacaf">USBD_CDCn_NCM_SetEthernetMulticastFilters</a> (<span class="keyword">const</span> uint8_t *addr_list, uint16_t num_of_filters) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_W_NUMBER_MC_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  int32_t status;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">if</span> (num_of_filters &gt; (USBD_CDCn_NCM_W_NUMBER_MC_FILTERS &amp; 0x7FFF)) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  status = EthMac-&gt;SetAddressFilter((ARM_ETH_MAC_ADDR *)((uint32_t)addr_list), num_of_filters);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  memcpy(NCM_State.mc_filters, addr_list, num_of_filters * 6);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)addr_list;</div>
<div class="line">  (void)num_of_filters;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set up the specified Ethernet power management pattern filter.</span></div>
<div class="line"><span class="comment">// \param[in]   filter_number        Filter number.</span></div>
<div class="line"><span class="comment">// \param[in]   pattern_filter       Power management pattern filter structure.</span></div>
<div class="line"><span class="comment">// \param[in]   pattern_filter_size  Size of pattern filter structure.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gacabf3368bcf30b530628d2f1c55aef8d">USBD_CDCn_NCM_SetEthernetPowerManagementPatternFilter</a> (uint16_t filter_number, <span class="keyword">const</span> uint8_t *pattern_filter, uint16_t pattern_filter_size) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (filter_number &gt;= USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"> </div>
<div class="line">  NCM_State.power_filter_active[filter_number / 8] |= 1U &lt;&lt; (filter_number % 8);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)filter_number;</div>
<div class="line">  (void)pattern_filter;</div>
<div class="line">  (void)pattern_filter_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve the status of the specified Ethernet power management pattern filter.</span></div>
<div class="line"><span class="comment">// \param[in]   filter_number        Filter number.</span></div>
<div class="line"><span class="comment">// \param[out]  pattern_active       Pointer to pattern active boolean.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga2b33946e39974bbb3dbc76adb0f42b70">USBD_CDCn_NCM_GetEthernetPowerManagementPatternFilter</a> (uint16_t filter_number, uint16_t *pattern_active) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_B_NUMBER_POWER_FILTERS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  *pattern_active = (NCM_State.power_filter_active[filter_number / 8] &amp; (1U &lt;&lt; (filter_number % 8))) ? 1 : 0;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)filter_number;</div>
<div class="line">  (void)pattern_active;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to configure device Ethernet packet filter settings.</span></div>
<div class="line"><span class="comment">// \param[in]   packet_filter_bitmap Packet Filter Bitmap.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga2d8ff4045b0026c0be1ca7aa6cd58489">USBD_CDCn_NCM_SetEthernetPacketFilter</a> (uint16_t packet_filter_bitmap) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x01) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  int32_t status;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  PacketFilter = ((packet_filter_bitmap &amp; 0x01U) ? ARM_ETH_MAC_ADDRESS_ALL       : 0) |</div>
<div class="line">                 ((packet_filter_bitmap &amp; 0x02U) ? ARM_ETH_MAC_ADDRESS_MULTICAST : 0) |</div>
<div class="line">                 ((packet_filter_bitmap &amp; 0x08U) ? ARM_ETH_MAC_ADDRESS_BROADCAST : 0);</div>
<div class="line"> </div>
<div class="line">  status = EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                          (uint32_t)(LinkInfo.speed                           ) |</div>
<div class="line">                          (uint32_t)(LinkInfo.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                           PacketFilter);</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  NCM_State.packet_filter_bitmap = packet_filter_bitmap;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)packet_filter_bitmap;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve a statistic based on the feature selector.</span></div>
<div class="line"><span class="comment">// \param[in]   feature_selector     Feature Selector.</span></div>
<div class="line"><span class="comment">// \param[out]  data                 Pointer to Statistics Value.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga1125c952881c080ad9041033f7b62506">USBD_CDCn_NCM_GetEthernetStatistic</a> (uint16_t feature_selector, uint32_t *data) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_BM_ETHERNET_STATISTICS != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (feature_selector == 0x00U) { <span class="keywordflow">return</span> <span class="keyword">true</span>;  }</div>
<div class="line">  <span class="keywordflow">if</span> (feature_selector &gt;  0x1DU) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  *data = NCM_State.eth_statistics[feature_selector - 1];</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)feature_selector;</div>
<div class="line">  (void)data;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to retrieve the parameters that describe NTBs for each direction.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_params           Pointer to NTB Parameter Structure.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga14fedc32c362e3b12d446cbc2a8be189">USBD_CDCn_NCM_GetNtbParameters</a> (CDC_NCM_NTB_PARAM *ntb_params) {</div>
<div class="line"> </div>
<div class="line">  ntb_params-&gt;wLength                 = <span class="keyword">sizeof</span>(CDC_NCM_NTB_PARAM);</div>
<div class="line">  ntb_params-&gt;bmNtbFormatsSupported   = USBD_CDCn_NCM_BM_NTB_FORMATS_SUPPORTED;</div>
<div class="line">  ntb_params-&gt;dwNtbInMaxSize          = USBD_CDCn_NCM_DW_NTB_IN_MAX_SIZE;</div>
<div class="line">  ntb_params-&gt;wNdpInDivisor           = USBD_CDCn_NCM_W_NDP_IN_DIVISOR;</div>
<div class="line">  ntb_params-&gt;wNdpInPayloadRemainder  = USBD_CDCn_NCM_W_NDP_IN_PAYLOAD_REMINDER;</div>
<div class="line">  ntb_params-&gt;wNdpInAlignment         = USBD_CDCn_NCM_W_NDP_IN_ALIGNMENT;</div>
<div class="line">  ntb_params-&gt;Reserved0               = 0U;</div>
<div class="line">  ntb_params-&gt;dwNtbOutMaxSize         = USBD_CDCn_NCM_DW_NTB_OUT_MAX_SIZE;</div>
<div class="line">  ntb_params-&gt;wNdpOutDivisor          = USBD_CDCn_NCM_W_NDP_OUT_DIVISOR;</div>
<div class="line">  ntb_params-&gt;wNdpOutPayloadRemainder = USBD_CDCn_NCM_W_NDP_OUT_PAYLOAD_REMINDER;</div>
<div class="line">  ntb_params-&gt;wNdpOutAlignment        = USBD_CDCn_NCM_W_NDP_OUT_ALIGNMENT;</div>
<div class="line">  ntb_params-&gt;Reserved1               = 0U;</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the USB Devices current EUI-48 station address.</span></div>
<div class="line"><span class="comment">// \param[out]  net_addr             Pointer to EUI-48 current address, in network byte order.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae68496f58e710418dec862ca858cf6e6">USBD_CDCn_NCM_GetNetAddress</a> (uint8_t *net_addr) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  memcpy(net_addr, NCM_State.net_address, 6);</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)net_addr;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to set the USB Devices current EUI-48 station address.</span></div>
<div class="line"><span class="comment">// \param[in]   net_addr             Pointer to EUI-48 address, in network byte order.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gafdaf7e6ad871cae664e72d4b675de4ce">USBD_CDCn_NCM_SetNetAddress</a> (<span class="keyword">const</span> uint8_t *net_addr) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x02) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  int32_t status;</div>
<div class="line"> </div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line">  status = EthMac-&gt;SetMacAddress((ARM_ETH_MAC_ADDR *)((uint32_t)net_addr));</div>
<div class="line">  <span class="keywordflow">if</span> (status != ARM_DRIVER_OK) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"> </div>
<div class="line">  memcpy(NCM_State.net_address, net_addr, 6);</div>
<div class="line"> </div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)net_addr;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the NTB data format currently being used.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_format           Pointer to NTB format code.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga76fef9a918909a02d4b9b579fe1a9ff6">USBD_CDCn_NCM_GetNtbFormat</a> (uint16_t *ntb_format) {</div>
<div class="line">  *ntb_format = NCM_State.ntb_format;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the format of NTB to be used for NTBs transmitted to the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   ntb_format           NTB format selection:</span></div>
<div class="line"><span class="comment">//                - value 0 :        NTB-16</span></div>
<div class="line"><span class="comment">//                - value 1 :        NTB-32</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga9dd16928bb606f3ce546759fa6f66438">USBD_CDCn_NCM_SetNtbFormat</a> (uint16_t ntb_format) {</div>
<div class="line"><span class="preprocessor">#if (USBD_CDCn_NCM_BM_NTB_FORMATS_SUPPORTED &gt; 1)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (ntb_format &gt; 1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (ntb_format &gt; 0) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  NCM_State.ntb_format = ntb_format;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return NTB input size currently being used.</span></div>
<div class="line"><span class="comment">// \param[out]  ntb_input_size       Pointer to NTB input size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gad93f53bc5f3e767f4afc1d36e130cb94">USBD_CDCn_NCM_GetNtbInputSize</a> (uint32_t *ntb_input_size) {</div>
<div class="line">  *ntb_input_size = NCM_State.ntb_input_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the maximum size of NTB that is permitted to be sent to the USB Host.</span></div>
<div class="line"><span class="comment">// \param[in]   ntb_input_size       Maximum NTB size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga8dae0db40ccc745c8221b92082aa145a">USBD_CDCn_NCM_SetNtbInputSize</a> (uint32_t ntb_input_size) {</div>
<div class="line">  <span class="keywordflow">if</span> (ntb_input_size &gt; USBD_CDCn_NCM_DW_NTB_IN_MAX_SIZE) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.ntb_input_size = ntb_input_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the currently effective maximum datagram size.</span></div>
<div class="line"><span class="comment">// \param[out]  max_datagram_size    Pointer to current maximum datagram size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga0150ca9d0e0d1cd5bcc50bf37773ad39">USBD_CDCn_NCM_GetMaxDatagramSize</a> (uint16_t *max_datagram_size) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x08) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  *max_datagram_size = NCM_State.max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to select the maximum datagram size that can be sent in an NTB.</span></div>
<div class="line"><span class="comment">// \param[in]   max_datagram_size    Maximum datagram size.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gafe4f737f31184318f2ec060db9b526ca">USBD_CDCn_NCM_SetMaxDatagramSize</a> (uint16_t max_datagram_size) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x08) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (max_datagram_size &gt; USBD_CDCn_NCM_W_MAX_SEGMENT_SIZE) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.max_datagram_size = max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)max_datagram_size;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to return the currently selected CRC mode.</span></div>
<div class="line"><span class="comment">// \param[out]  crc_mode             Pointer to current CRC mode.</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga3a495bcfef9ebab08d044b67b6f89e80">USBD_CDCn_NCM_GetCrcMode</a> (uint16_t *crc_mode) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x10) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  *crc_mode = NCM_State.crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called upon USB Host request to control CRC mode.</span></div>
<div class="line"><span class="comment">// \param[in]   crc_mode             CRC mode:</span></div>
<div class="line"><span class="comment">//                - value 0 :        CRCs shall not be appended</span></div>
<div class="line"><span class="comment">//                - value 1 :        CRCs shall be appended</span></div>
<div class="line"><span class="comment">// \return      true                 if this request was handled.</span></div>
<div class="line"><span class="comment">// \return      false                if this request was not handled.</span></div>
<div class="line"><span class="keywordtype">bool</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gaaae74ae77df4b1f33e0a96768299eb95">USBD_CDCn_NCM_SetCrcMode</a> (uint16_t crc_mode) {</div>
<div class="line"><span class="preprocessor">#if ((USBD_CDCn_NCM_BM_NETWORK_CAPABILITIES &amp; 0x10) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>  <span class="keywordflow">if</span> (crc_mode &gt; 1) { <span class="keywordflow">return</span> <span class="keyword">false</span>; }</div>
<div class="line">  NCM_State.crc_mode = crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)crc_mode;</div>
<div class="line">  <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when NTB was successfully sent.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga0731cb012344bc03b7132941e630a426">USBD_CDCn_NCM_NTB_IN_Sent</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osThreadFlagsSet(DataIN_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osSignalSet(DataIN_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"><span class="comment">// Called when NTB was successfully received.</span></div>
<div class="line"><span class="keywordtype">void</span> <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae000e324025458f142e5b1d6d2750060">USBD_CDCn_NCM_NTB_OUT_Received</a> (<span class="keywordtype">void</span>) {</div>
<div class="line">  <span class="comment">// Add code for handling request</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osThreadFlagsSet(DataOUT_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>  (void)osSignalSet(DataOUT_ThreadId, 1U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>}</div>
<div class="line"> </div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Called upon Ethernet MAC Event</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> EthMac_Notify (uint32_t event) {</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">switch</span> (event) {</div>
<div class="line">    <span class="keywordflow">case</span> ARM_ETH_MAC_EVENT_RX_FRAME:</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>      (void)osThreadFlagsSet(DataIN_ThreadId, 2U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>      (void)osSignalSet(DataIN_ThreadId, 2U);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>      <span class="keywordflow">break</span>;</div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">      <span class="keywordflow">break</span>;</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"></div>
<div class="line"><span class="comment">// Thread handling ETH Connection</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> Connection_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  ARM_ETH_LINK_STATE link_state;</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS</span></div>
<div class="line"><span class="preprocessor"></span>  osEvent            os_event;</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t           event;</div>
<div class="line">  uint32_t           speed;</div>
<div class="line">  uint16_t           state;</div>
<div class="line">  int32_t            status;</div>
<div class="line"></div>
<div class="line">  (void)(arg);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keyword">event</span> = osThreadFlagsWait(1U, osFlagsWaitAll, 500U);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    os_event = osSignalWait(1U, 500U);</div>
<div class="line">    <span class="keywordflow">if</span> (os_event.status == osEventSignal) {</div>
<div class="line">      <span class="keyword">event</span> = (uint32_t)os_event.value.signals;</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      <span class="keyword">event</span> = 0x80000000U;</div>
<div class="line">    }</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    link_state = EthPhy-&gt;GetLinkState();</div>
<div class="line">    <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">      LinkInfo = EthPhy-&gt;GetLinkInfo();</div>
<div class="line">      <span class="keywordflow">switch</span> (LinkInfo.speed) {</div>
<div class="line">        <span class="keywordflow">case</span> 0:  speed =   10000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 1:  speed =  100000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">case</span> 2:  speed = 1000000000U; <span class="keywordflow">break</span>;</div>
<div class="line">        <span class="keywordflow">default</span>: speed = 0U;</div>
<div class="line">      }</div>
<div class="line">    } <span class="keywordflow">else</span> {</div>
<div class="line">      speed = 0U;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (speed != LinkSpeed) {</div>
<div class="line">      LinkSpeed = speed;</div>
<div class="line">      <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55">USBD_CDC_NCM_Notify_ConnectionSpeedChange</a>(USB_CDC_NUM, speed, speed);</div>
<div class="line">        } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afa5dfd259ecc4bbe016eaffb65838da4cb">usbDriverBusy</a>);</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (link_state != LinkState) {</div>
<div class="line">      LinkState = link_state;</div>
<div class="line">      <span class="keywordflow">if</span> (link_state == ARM_ETH_LINK_UP) {</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONFIGURE,</div>
<div class="line">                             (uint32_t)(LinkInfo.speed                           ) |</div>
<div class="line">                             (uint32_t)(LinkInfo.duplex &lt;&lt; ARM_ETH_MAC_DUPLEX_Pos) |</div>
<div class="line">                              PacketFilter);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_TX, 1U);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_RX, 1U);</div>
<div class="line">      } <span class="keywordflow">else</span> {</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_FLUSH,</div>
<div class="line">                              ARM_ETH_MAC_FLUSH_TX |</div>
<div class="line">                              ARM_ETH_MAC_FLUSH_RX);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_TX, 0U);</div>
<div class="line">        (void)EthMac-&gt;Control(ARM_ETH_MAC_CONTROL_RX, 0U);</div>
<div class="line">      }</div>
<div class="line">      state = (link_state == ARM_ETH_LINK_UP) ? 1U : 0U;</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f">USBD_CDC_NCM_Notify_NetworkConnection</a>(USB_CDC_NUM, state);</div>
<div class="line">      } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afa5dfd259ecc4bbe016eaffb65838da4cb">usbDriverBusy</a>);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> ((event &amp; 0x80000000U) == 0U) {</div>
<div class="line">      <span class="keywordflow">if</span> (LinkState == ARM_ETH_LINK_UP) {</div>
<div class="line">        <span class="keywordflow">do</span> {</div>
<div class="line">          status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga5888e54f798b2bf2d20bdc41b1e8af55">USBD_CDC_NCM_Notify_ConnectionSpeedChange</a>(USB_CDC_NUM, LinkSpeed, LinkSpeed);</div>
<div class="line">        } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afa5dfd259ecc4bbe016eaffb65838da4cb">usbDriverBusy</a>);</div>
<div class="line">      }</div>
<div class="line">      state = (LinkState == ARM_ETH_LINK_UP) ? 1U : 0U;</div>
<div class="line">      <span class="keywordflow">do</span> {</div>
<div class="line">        status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga6966c46d11f2592edf7dde71f4220e3f">USBD_CDC_NCM_Notify_NetworkConnection</a>(USB_CDC_NUM, state);</div>
<div class="line">      } <span class="keywordflow">while</span> (status == -(int32_t)<a class="code" href="group__status__error__codes__usb.html#ggaa48e102b9b2600828158b5319c3386afa5dfd259ecc4bbe016eaffb65838da4cb">usbDriverBusy</a>);</div>
<div class="line">    }</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Thread handling Data IN (ETH -&gt; USB)</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataIN_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t size;</div>
<div class="line">   int32_t status;</div>
<div class="line"></div>
<div class="line">  (void)arg;</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osThreadFlagsWait(3U, osFlagsWaitAll, osWaitForever);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osSignalWait(3U, osWaitForever);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">do</span> {</div>
<div class="line">      status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae9c578e2dbb6b54b8963adee536aea11">USBD_CDC_NCM_NTB_IN_Initialize</a>(USB_CDC_NUM);</div>
<div class="line">      <span class="keywordflow">if</span> (status != (int32_t)usbOK) { <span class="keywordflow">continue</span>; }</div>
<div class="line">      status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae9fa4907d191f9e78483d588eef7081f">USBD_CDC_NCM_NTB_IN_CreateNDP</a>(USB_CDC_NUM, MAX_IN_DATAGRAMS);</div>
<div class="line">      <span class="keywordflow">if</span> (status != (int32_t)usbOK) { <span class="keywordflow">continue</span>; }</div>
<div class="line">      <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        <span class="keywordflow">if</span> (FrameIN_Size != 0) {</div>
<div class="line">          (void)<a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d">USBD_CDC_NCM_NTB_IN_WriteDatagram</a>(USB_CDC_NUM, FrameIN, FrameIN_Size);</div>
<div class="line">          FrameIN_Size = 0;</div>
<div class="line">        }</div>
<div class="line">        size = EthMac-&gt;GetRxFrameSize();</div>
<div class="line">        <span class="keywordflow">if</span> (size == 0U) {</div>
<div class="line">          <span class="keywordflow">break</span>;</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">if</span> ((size &lt; 14U) || (size &gt; NCM_State.max_datagram_size)) {</div>
<div class="line">          (void)EthMac-&gt;ReadFrame(NULL, 0U);</div>
<div class="line">          <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        (void)EthMac-&gt;ReadFrame(FrameIN, size);</div>
<div class="line">        <span class="keywordflow">if</span> (size &gt; 0) {</div>
<div class="line"><span class="preprocessor">          #if ((USBD_CDCn_NCM_BM_ETHERNET_STATISTICS &amp; 0x00000002) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>            NCM_State.eth_statistics[1]++;</div>
<div class="line"><span class="preprocessor">          #endif</span></div>
<div class="line"><span class="preprocessor"></span>          status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#gae55b3d343bccc5829fc5987a86cbe25d">USBD_CDC_NCM_NTB_IN_WriteDatagram</a>(USB_CDC_NUM, FrameIN, size);</div>
<div class="line">          <span class="keywordflow">if</span> (status != (int32_t)usbOK) {</div>
<div class="line">            FrameIN_Size = size;</div>
<div class="line">            <span class="keywordflow">break</span>;</div>
<div class="line">          }</div>
<div class="line">        }</div>
<div class="line">      }</div>
<div class="line">      (void)<a class="code" href="group__usbd__cdc_functions__ncm__api.html#gaf2b9c281b2f5ba8d26ea598633d5c9ad">USBD_CDC_NCM_NTB_IN_Send</a>(USB_CDC_NUM);</div>
<div class="line">    } <span class="keywordflow">while</span> (FrameIN_Size);</div>
<div class="line">  }</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="comment">// Thread handling Data OUT (USB -&gt; ETH)</span></div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread (<span class="keywordtype">void</span> *arg) {</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>__NO_RETURN <span class="keyword">static</span> <span class="keywordtype">void</span> DataOUT_Thread (<span class="keywordtype">void</span> <span class="keyword">const</span> *arg) {</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>  uint32_t size;</div>
<div class="line">  int32_t  len, status;</div>
<div class="line"></div>
<div class="line">  (void)(arg);</div>
<div class="line"></div>
<div class="line">  <span class="keywordflow">for</span> (;;) {</div>
<div class="line"><span class="preprocessor">#ifdef USB_CMSIS_RTOS2</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osThreadFlagsWait(1U, osFlagsWaitAll, osWaitForever);</div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor"></span>    (void)osSignalWait(1U, osWaitForever);</div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor"></span>    <span class="keywordflow">for</span> (;;) {</div>
<div class="line">      status = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga0a24001aff5d9af6e8b040dc0cde6445">USBD_CDC_NCM_NTB_OUT_ProcessNDP</a>(USB_CDC_NUM);</div>
<div class="line">      <span class="keywordflow">if</span> (status != (int32_t)usbOK) { <span class="keywordflow">break</span>; }</div>
<div class="line">      <span class="keywordflow">for</span> (;;) {</div>
<div class="line">        size = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga07e08df67e7fbc5a81f8ae9efabfc486">USBD_CDC_NCM_NTB_OUT_GetDatagramSize</a>(USB_CDC_NUM);</div>
<div class="line">        <span class="keywordflow">if</span> (size == 0U) { <span class="keywordflow">break</span>; }</div>
<div class="line">        <span class="keywordflow">if</span> ((size &lt; 14U) || (size &gt; NCM_State.max_datagram_size)) {</div>
<div class="line">          (void)<a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5">USBD_CDC_NCM_NTB_OUT_ReadDatagram</a>(USB_CDC_NUM, NULL, 0U);</div>
<div class="line">          <span class="keywordflow">continue</span>;</div>
<div class="line">        }</div>
<div class="line">        len = <a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga74f401a77a548941e2c5ec998f4bf7f5">USBD_CDC_NCM_NTB_OUT_ReadDatagram</a>(USB_CDC_NUM, FrameOUT, size);</div>
<div class="line">        <span class="keywordflow">if</span> (len &gt; 0) {</div>
<div class="line">          <span class="keywordflow">do</span> {</div>
<div class="line">            status = EthMac-&gt;SendFrame(FrameOUT, (uint32_t)(len), 0U);</div>
<div class="line">          } <span class="keywordflow">while</span> (status == ARM_DRIVER_ERROR_BUSY);</div>
<div class="line"><span class="preprocessor">          #if ((USBD_CDCn_NCM_BM_ETHERNET_STATISTICS &amp; 0x00000001) != 0)</span></div>
<div class="line"><span class="preprocessor"></span>            NCM_State.eth_statistics[0]++;</div>
<div class="line"><span class="preprocessor">          #endif</span></div>
<div class="line"><span class="preprocessor"></span>        }</div>
<div class="line">      }</div>
<div class="line">    }</div>
<div class="line">    (void)<a class="code" href="group__usbd__cdc_functions__ncm__api.html#ga7ce93a9770eb6360bdd9d9c79be4f1b6">USBD_CDC_NCM_NTB_OUT_Release</a>(USB_CDC_NUM);</div>
<div class="line">  }</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue May 25 2021 13:57:49 for USB Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
