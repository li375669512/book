<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Create an Application Using the File System</title>
<title>File System Component: Create an Application Using the File System</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">File System Component
   &#160;<span id="projectnumber">Version 6.14.1</span>
   </div>
   <div id="projectbrief">MDK Middleware for Devices with Flash File System</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('fs_create_app.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Create an Application Using the File System </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#fs_RTE_Software_Component_Selection">RTE Component Selection</a></li>
<li class="level1"><a href="#fs_drives">Using Drives</a><ul><li class="level2"><a href="#nor_usage">NOR Flash Drive</a></li>
<li class="level2"><a href="#ram_usage">RAM Disk Drive</a></li>
<li class="level2"><a href="#mc_usage">Memory Card Drive</a></li>
<li class="level2"><a href="#usb_usage">USB Flash Drive</a></li>
<li class="level2"><a href="#nand_usage">NAND Flash Drive</a></li>
</ul>
</li>
<li class="level1"><a href="#fs_Device_Configuration">File System Configuration</a></li>
<li class="level1"><a href="#fs_Driver_Configuration">Hardware Configuration</a></li>
<li class="level1"><a href="#fs_sys_req">System Resource Configuration</a></li>
<li class="level1"><a href="#fs_User_Code_Implementation">User Code Implementation</a></li>
<li class="level1"><a href="#fs_debugging">Debugging</a></li>
</ul>
</div>
<div class="textblock"><p>The steps to create a microcontroller application that uses the File System are:</p>
<ol type="1">
<li>Select <a class="el" href="fs_create_app.html#fs_RTE_Software_Component_Selection">RTE Components</a> along with other components that are required for your application.</li>
<li>Configure the <a class="el" href="fs_create_app.html#fs_Device_Configuration">File System</a>.</li>
<li>Configure the <a class="el" href="fs_create_app.html#fs_Driver_Configuration">hardware</a>.</li>
<li>Implement the <a class="el" href="fs_create_app.html#fs_User_Code_Implementation">User Code</a>.</li>
<li><a class="el" href="fs_create_app.html#fs_debugging">Debug</a> you application using the built-in mechanisms of the File System Component.</li>
</ol>
<h1><a class="anchor" id="fs_RTE_Software_Component_Selection"></a>
RTE Component Selection</h1>
<p>Only a few steps are necessary to complete the RTE Component selection:</p>
<ol type="1">
<li>From the <b>File</b> <b>System</b> Component:<ul>
<li>Select <b>File System:CORE</b> that provides the basic functionality required for data storage and access. In the <b>Variant</b> drop-down box you can choose to use the short (SFN) or long filename (LFN) version.</li>
<li>Select your desired <b>File System:Drive</b>. <a class="el" href="fs_create_app.html#fs_drives">Using Drives</a> gives more details.</li>
</ul>
</li>
<li>From the <b>CMSIS</b> <b>Driver</b> Component select an appropriate driver suitable for your <b>drive</b>. <a class="el" href="fs_create_app.html#fs_drives">Using Drives</a> gives more details.</li>
<li>From the <b>Device</b> Component:<ul>
<li>Additional device specific drivers may be required according to the validation output.</li>
</ul>
</li>
<li>From the CMSIS Component:<ul>
<li>Select the <b>CMSIS:CORE</b> to provide the core interface to the processor.</li>
<li>Select a suitable <b>CMSIS:RTOS</b> that is a required for the File System Component.</li>
</ul>
</li>
</ol>
<div class="image">
<img src="fs_rte_comp_selection.png" alt="fs_rte_comp_selection.png"/>
<div class="caption">
RTE Component for File System</div></div>
<h1><a class="anchor" id="fs_drives"></a>
Using Drives</h1>
<p>The section <a class="el" href="fs_operation.html#drive">Drives, Memory Devices and Drivers</a> shows the relationship between drive - memory device - and driver/interface.</p>
<h2><a class="anchor" id="nor_usage"></a>
NOR Flash Drive</h2>
<p>For using a NOR Flash drive, a <script>link_ext('Flash-API');</script> driver is required, which encapsulates either the Memory Bus interface or SPI (in which case an <script>link_ext('SPI-API');</script> driver is required in addition):</p>
<ul>
<li>Set <b>File System:Drive:NOR</b> to at least '1' to use a NOR Flash drive (independently if it is using a memory bus or SPI interface).</li>
<li>From the <b>CMSIS</b> <b>Driver</b> Component, select an appropriate <b>Flash (API)</b> device. If your NOR Flash uses an SPI interface, select <b>SPI (API)</b> additionally.</li>
</ul>
<p>If your NOR Flash device is not listed, use one of the examples as a reference to implement a driver for your specific device:</p>
<ul>
<li>AM29x800BB/<a href="https://www.micron.com/~/media/documents/products/data-sheet/nor-flash/parallel/m29w/m29w640f.pdf" target="_blank">M29W640FB</a> (Flash with 16-bit memory bus interface)</li>
<li><a href="http://www.spansion.com/Support/Datasheets/s29gl-n_01.pdf" target="_blank">S29GL064Nx2</a> (Flash with 32-bit memory bus interface)</li>
<li><a href="http://www.atmel.com/images/doc1638.pdf" target="_blank">AT45DB642D</a> (Flash with SPI interface using an SPI driver)</li>
</ul>
<div class="image">
<img src="fs_flash_drivers.png" alt="fs_flash_drivers.png"/>
<div class="caption">
Flash (API) Drivers shipped with the Middleware Component</div></div>
<p> Configure the driver-hardware relationship using the <b>FS_Config_NOR_n.h</b> file:</p>
<div class="image">
<img src="fs_config_nor_0_h.png" alt="fs_config_nor_0_h.png"/>
<div class="caption">
NOR Flash Drive Configuration File</div></div>
 <dl class="section note"><dt>Note</dt><dd>General <a class="el" href="fs_create_app.html#fs_sys_req">System Resource Configuration</a> requirements apply.</dd></dl>
<h2><a class="anchor" id="ram_usage"></a>
RAM Disk Drive</h2>
<p>To enable a RAM disk drive, select <b>File System:Drive:RAM</b>.</p>
<p>Set the drive characteristics in the <b>FS_Config_RAM.h</b> file:</p>
<div class="image">
<img src="fs_config_ram_0_h.png" alt="fs_config_ram_0_h.png"/>
<div class="caption">
RAM Disk Configuration File</div></div>
 <dl class="section note"><dt>Note</dt><dd>General <a class="el" href="fs_create_app.html#fs_sys_req">System Resource Configuration</a> requirements apply.</dd></dl>
<h2><a class="anchor" id="mc_usage"></a>
Memory Card Drive</h2>
<p>Memory cards can be connected to a microcontroller device either using an SD/MMC bus mode (MCI) or an SPI bus mode.</p>
<ul>
<li>Set <b>File System:Drive:Memory Card</b> to at least '1'.</li>
<li>From the <b>CMSIS</b> <b>Driver</b> Component, select <b>MCI (API)</b> or <b>SPI (API)</b>, depending on the actual connection of the card drive to the microcontroller.</li>
</ul>
<p>Set the drive characteristics in the <b>FS_Config_MC_n.h</b> file:</p>
<div class="image">
<img src="fs_config_mc_0_h.png" alt="fs_config_mc_0_h.png"/>
<div class="caption">
Memory Card Drive Configuration File</div></div>
 <dl class="section note"><dt>Note</dt><dd><ul>
<li>If your microcontroller device does not have a <b>CMSIS</b> <b>Driver</b> for the <b>MCI (API)</b> or <b>SPI (API)</b>, you can try to develop your own one based on the <script>link_ext('CMSIS-Driver-Ref');</script> documentation.</li>
<li>The page <a class="el" href="mc_control_layer.html">Memory Card Control Layer</a> lists all supported memory card types and gives further details on how to use these cards.</li>
<li>General <a class="el" href="fs_create_app.html#fs_sys_req">System Resource Configuration</a> requirements apply.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="usb_usage"></a>
USB Flash Drive</h2>
<ul>
<li>Set <b>File System:Drive:USB</b> to at least '1'.</li>
<li>From the <b>USB</b> Component, please select the <b>USB:CORE</b>, set <b>USB:Host</b> to '1', and select <b>USB:Host:MSC</b>.</li>
<li>From the <b>CMSIS</b> <b>Driver</b> component, select the appropriate USB driver from <b>USB Host (API)</b>.</li>
</ul>
<p>Set the drive characteristics in the <b>FS_Config_USB_n.h</b> file:</p>
<div class="image">
<img src="fs_config_usb_0_h.png" alt="fs_config_usb_0_h.png"/>
<div class="caption">
USB Host Mass Storage Class Drive Configuration File</div></div>
 <dl class="section note"><dt>Note</dt><dd><ul>
<li>If your microcontroller device does not have a <b>CMSIS</b> <b>Driver</b> for the <b>USB Host (API)</b>, you can try to develop your own one based on the  <script>link_ext('CMSIS-Driver-Ref');</script> documentation.</li>
<li>General <a class="el" href="fs_create_app.html#fs_sys_req">System Resource Configuration</a> requirements apply.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="nand_usage"></a>
NAND Flash Drive</h2>
<ul>
<li>Set <b>File System:Drive:NAND</b> to at least '1'.</li>
<li>From the <b>CMSIS</b> <b>Driver</b> component, select the appropriate NAND driver from <b>NAND (API)</b>.</li>
</ul>
<p>Set the drive characteristics in the <b>FS_Config_NAND_n.h</b> file:</p>
<div class="image">
<img src="fs_config_nand_0_h.png" alt="fs_config_nand_0_h.png"/>
<div class="caption">
NAND Flash Drive Configuration File</div></div>
 <dl class="section note"><dt>Note</dt><dd><ul>
<li>If your microcontroller device does not have a <b>CMSIS</b> <b>Driver</b> for the <b>NAND (API)</b>, you can try to develop your own one based on the <script>link_ext('CMSIS-Driver-Ref');</script> documentation.</li>
<li>The page <a class="el" href="nand_flash__t_l.html">NAND Flash Translation Layer</a> describes additional features specific to these devices.</li>
<li>Using a <b>NAND (API)</b> driver, you can use any NAND Flash device with an 8-/16-bit memory bus interface for data storage.</li>
<li>NAND Flashes with SPI interface (Serial NAND) are currently <em>not</em> <em>supported</em> by the File System Component.</li>
<li>General <a class="el" href="fs_create_app.html#fs_sys_req">System Resource Configuration</a> requirements apply.</li>
</ul>
</dd></dl>
<h1><a class="anchor" id="fs_Device_Configuration"></a>
File System Configuration</h1>
<p>The File System configuration file <b>FS_Config.c</b> contains settings for the amount of files that can be open at the same time and the initial current drive which needs to be set according to the <a class="el" href="fs_create_app.html#fs_drives">drives</a> that have been selected:</p>
<div class="image">
<img src="fs_config_c.png" alt="fs_config_c.png"/>
<div class="caption">
File System Configuration File</div></div>
<p> If the <b>Initial</b> <b>Current</b> <b>Drive</b> is not configured correctly, the project will not build. The File System Component will flag this with an error message: </p>
<pre class="fragment">C:\Keil_v5\ARM\PACK\Keil\MDK-Middleware\7.0.0\FileSystem\Include\fs_config.h(178): error: #35:
#error directive: "Initial Current ::File System:Drive is not enabled"
#error "Initial Current ::File System:Drive is not enabled"
</pre><h1><a class="anchor" id="fs_Driver_Configuration"></a>
Hardware Configuration</h1>
<p>As the file system is not bound to a special type of hardware, you need to configure the necessary drivers according to the requirements of your target device. This configuration is done in the <b>RTE_Device.h</b> configuration file:</p>
<div class="image">
<img src="rte_device_h.png" alt="rte_device_h.png"/>
<div class="caption">
Hardware Configuration Example using RTE_Device.h</div></div>
 <dl class="section note"><dt>Note</dt><dd>Consult the device's user manual or hardware reference guide for more details.</dd></dl>
<h1><a class="anchor" id="fs_sys_req"></a>
System Resource Configuration</h1>
<p>For proper operation, the File System Component requires some system configuration settings. The requirements are:</p>
<ul>
<li>Minimum <b>heap</b> size of <b>512 + 96 Bytes for each opened file</b>. If you want to be able to have three files open at the same time, you need to set a heap size of at least 3 * (512+96) Bytes = 1824 Bytes. This can be configured in the device's  <script>link_ext('startup_device');</script> file (<code>Heap_Size</code>).</li>
<li>As the File System Component is not creating any additional threads, you need to add thread stack size to the calling thread. This calling thread can be the main thread, a thread with a default stack size or a thread with a user provided stack size. Changing the size for these threads can be done in the  <script>link_ext('RTX-Conf-CM5');</script> file.</li>
<li>Each opened file is protected with a mutex in order to ensure thread-safe operation. When working with file functions from the standard C library, you need to ensure enough mutex objects available for the file stream operations in the standard library system. File System component's <a class="el" href="fs_resource_requirements.html">Resource Requirements</a> section explains how to determine the right setting in detail. Adjusting the number of mutex objects available for standard library system can be done in the <script>link_ext('RTX-Conf-CM5');</script> file.</li>
</ul>
<p>For more information, check the File System component's <a class="el" href="fs_resource_requirements.html">Resource Requirements</a> section.</p>
<h1><a class="anchor" id="fs_User_Code_Implementation"></a>
User Code Implementation</h1>
<p>All available functions are documented in the <a href="./modules.html" class="el">Reference</a> section of the File System Component. These routines can be adapted to the needs of the microcontroller application, in case more functionality is needed.</p>
<h1><a class="anchor" id="fs_debugging"></a>
Debugging</h1>
<p>File System Component is distributed in library form and doesn't allow direct code debug. However it can be easily configured to generate debug events and provide dynamic visibility to the component operation.</p>
<p>Following variants can be selected for the <b>File System:CORE</b> software component in the <b>Manage Run-Time Environment</b> window:</p>
<ul>
<li><b>LFN/SFN Debug</b>: these variants support event annotations for the <script>link_ext('Event-Recorder-About');</script> and make it very easy to analyze the internal operation of the File System Component during application debug. <a class="el" href="fs_create_app.html#fsEvrSupport">Event Recorder Support</a> below explains how to configure and use this variant.</li>
<li><b>LFN/SFN Release</b>: these variants do not include additional debugging code. Use these variants when deploying the application.</li>
</ul>
<p>The figure below shows selection of the <b>LFN Debug</b> variant as an example. </p>
<div class="image">
<img src="fs_debug_variant.png" alt="fs_debug_variant.png"/>
</div>
<p>The <a class="el" href="group__evr__gr.html">Debug Events</a> describes the events implemented in the File System Component.</p>
<p><a class="anchor" id="fsEvrSupport"></a></p>
<h2>Event Recorder Support </h2>
 <script>link_ext('Event-Recorder-About');</script> is a powerful tool that provides visibility to the dynamic execution of the program.</p>
<p>The File System Component generates <a class="el" href="group__evr__gr.html">a broad set of Debug Events</a> for the Event Recorder and implements required infrastructure to interface with it.</p>
<p>To use the Event Recorder it is required to create an image with event generation support. The necessary steps are:</p>
<ol type="1">
<li> <script>link_ext('Debug-Variant-Select');</script>: in the RTE management dialog select the <b>Debug</b> variant for the target <b>File System:CORE</b> software component.</li>
<li> <script>link_ext('Event-Recorder-Enable');</script>: in the RTE management dialog enable the software component <b>Compiler:Event Recorder</b>.</li>
<li>Ensure that Event Recorder is initialized preferably by <script>link_ext('RTX5-Event-Recorder-Config');</script> if CMSIS-RTOS2 RTX v5 is used, or alternatively by calling the function <script>link_ext('Event-Recorder-Initialize-Func');</script> in the application code.</li>
<li><a class="el" href="fs_create_app.html#fsEvrConfig">Event Recorder Configuration</a>: if necessary, adjust default Event Recorder configuration.</li>
<li>Build the application code, download it to the target hardware and start debug session.</li>
</ol>
<p>Now, when the File System generates event information, it can be viewed in the <script>link_ext('uv4-Event-Recorder');</script>.</p>
<p><a class="anchor" id="fsEvrConfig"></a></p>
<h2>Event Recorder Configuration </h2>
<p>This section describes the configuration settings for the Event Recorder. The usage requires the debug variant of the <b>File System:CORE</b> software component; refer to <a class="el" href="fs_create_app.html#fsEvrSupport">Event Recorder Support</a> for more information.</p>
<p><b>File System Event Generation Configuration</b></p>
<p>Selecting the <b>File System:CORE</b> debug variant will add the file <code>FS_Debug.c</code> to your project. Use this file to set the event generation configuration for File System core and drivers separately.</p>
<div class="image">
<img src="fs_debug_c.png" alt="fs_debug_c.png"/>
<div class="caption">
FS_Debug.c file for event generation configuration</div></div>
<p> The following settings are available for event generation configuration of each module:</p>
<ul>
<li><b>Off</b> means no events will be generated by the module</li>
<li><b>Errors</b> means only error events will be generated by the module</li>
<li><b>Errors + API</b> means error and API call events will be generated by the module</li>
<li><b>All</b> means all available events will be generated by the module. Besides error and API call events, this contains operation and detailed events.</li>
</ul>
<h2>Event IDs </h2>
<p>The file system component uses the following event IDs:</p>
<table class="doxtable">
<tr>
<th>Component </th><th>Event ID  </th></tr>
<tr>
<td>FsCore </td><td>0x80 </td></tr>
<tr>
<td>FsFAT </td><td>0x81 </td></tr>
<tr>
<td>FsEFS </td><td>0x82 </td></tr>
<tr>
<td>FsIOC </td><td>0x83 </td></tr>
<tr>
<td>FsNFTL </td><td>0x84 </td></tr>
<tr>
<td>FsNAND </td><td>0x85 </td></tr>
<tr>
<td>FsMcMCI </td><td>0x86 </td></tr>
<tr>
<td>FsMcSPI </td><td>0x87 </td></tr>
</table>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Tue May 25 2021 13:57:20 for File System Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
