<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<title>Using Secure Services</title>
<title>Network Component: Using Secure Services</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="drv.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="printComponentTabs.js"></script>
<script type="text/javascript" src="URL_keys.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="stylsheetf" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 46px;">
  <td id="projectlogo"><img alt="Logo" src="keilarm.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">Network Component
   &#160;<span id="projectnumber">Version 7.15.0</span>
   </div>
   <div id="projectbrief">MDK Middleware for IPv4 and IPv6 Networking</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<div id="DRVnav" class="tabs1">
    <ul class="tablist">
      <script type="text/javascript">
		<!--
		writeComponentTabs.call(this);
		//-->
      </script>
	  </ul>
</div>
<!-- Generated by Doxygen 1.8.6 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Usage&#160;and&#160;Description</span></a></li>
      <li><a href="modules.html"><span>Reference</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('use_secure_components.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Groups</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Using Secure Services </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>The Network Component offers secure software components that are using <a class="el" href="use_mbed_tls.html">Mbed TLS</a>. The user of the Network Component does not see the Mbed TLS API as it is hidden by the standard API of the secure component.</p>
<p>Currently, the following component is available in a secure variant:</p>
<ul>
<li><a class="el" href="use_secure_components.html#https_server">HTTPS Server</a></li>
<li><a class="el" href="use_secure_components.html#smtps_client">SMTPS Client</a></li>
</ul>
<p>To be able to communicate securely, you will need to generate appropriate certificates for the server. The section <a class="el" href="use_secure_components.html#cert_creation">Creating your own certificates and keys</a> explains how to achieve this for the secure components by using additional tools that are part of the Network Component.</p>
<h1><a class="anchor" id="https_server"></a>
HTTPS Server</h1>
<p>The web server and the compact web server have secure variants available. In the <b>Manage Run-Time Environment</b> window simply select the appropriate variant:</p>
<div class="image">
<img src="select_https.png" alt="select_https.png"/>
</div>
<h2><a class="anchor" id="add_ssl_to_http"></a>
Converting the HTTP server to HTTPS</h2>
<p>It is also possible to convert an already existing (compact) web server to a secure HTTPS web server. A few simple steps are required to achieve this:</p>
<ol type="1">
<li>Download and install the <b>ARM:mbedTLS</b> Software Pack (see <a class="el" href="use_mbed_tls.html#add_mbedtls">Add the mbed TLS library to a µVision project</a>).</li>
<li>Change the following software components in the Manage Run-Time Environment:<ul>
<li>Set <b>Network:Service:Web Server (Compact)</b> variant to <b>HTTPS</b>. This adds the file <code>Net_Security.c</code> to the project which contains test keys/certificates. To change them, follow the steps provided in <a class="el" href="use_secure_components.html#cert_creation">Creating your own certificates and keys</a>.</li>
<li>Enable <b>Security:mbed TLS</b> or resolve this dependency automatically.</li>
</ul>
</li>
<li>Update the <code>mbedTLS_Config.h</code> configuration file with the following (a copy named <code>mbedTLS_config_HTTPS.h</code> is available in the <b>Template</b> folder): <div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  Configuration template for HTTPS</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  Copyright (C) 2006-2015, ARM Limited, All Rights Reserved</span></div>
<div class="line"><span class="comment"> *  SPDX-License-Identifier: Apache-2.0</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span></div>
<div class="line"><span class="comment"> *  not use this file except in compliance with the License.</span></div>
<div class="line"><span class="comment"> *  You may obtain a copy of the License at</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><span class="comment"> *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span></div>
<div class="line"><span class="comment"> *  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><span class="comment"> *  See the License for the specific language governing permissions and</span></div>
<div class="line"><span class="comment"> *  limitations under the License.</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  This file is part of mbed TLS (https://tls.mbed.org)</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This set of compile-time options may be used to enable</span></div>
<div class="line"><span class="comment"> * or disable features selectively, and reduce the global</span></div>
<div class="line"><span class="comment"> * memory footprint.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#ifndef MBEDTLS_CONFIG_H</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CONFIG_H</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">/* System support */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ENTROPY_HARDWARE_ALT</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">/* mbed TLS feature support */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_AES_ROM_TABLES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_MODE_CBC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_MODE_CFB</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_MODE_CTR</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_PKCS7</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_ONE_AND_ZEROS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_ZEROS_AND_LEN</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_ZEROS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_REMOVE_ARC4_CIPHERSUITES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_DHE_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_RSA_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_RSA_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_DHE_RSA_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_GENPRIME</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_NO_PLATFORM_ENTROPY</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PK_RSA_ALT_SUPPORT</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PKCS1_V15</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PKCS1_V21</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_ALL_ALERT_MESSAGES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_ENCRYPT_THEN_MAC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_EXTENDED_MASTER_SECRET</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_FALLBACK_SCSV</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_CBC_RECORD_SPLITTING</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_RENEGOTIATION</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_MAX_FRAGMENT_LENGTH</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_PROTO_SSL3</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_PROTO_TLS1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_PROTO_TLS1_1</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_PROTO_TLS1_2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_ALPN</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_SESSION_TICKETS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_SERVER_NAME_INDICATION</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_TRUNCATED_HMAC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_CHECK_KEY_USAGE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_CHECK_EXTENDED_KEY_USAGE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_RSASSA_PSS_SUPPORT</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">/* mbed TLS modules */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_AES_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ARC4_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ASN1_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_BASE64_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_BIGNUM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_BLOWFISH_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CAMELLIA_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CCM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CTR_DRBG_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">//#define MBEDTLS_DEBUG_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_DES_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_DHM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ENTROPY_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_GCM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_HMAC_DRBG_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_MD_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_MD5_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_OID_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PEM_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PK_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PK_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PKCS5_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PKCS12_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PLATFORM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_RIPEMD160_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_RSA_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SHA1_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SHA256_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SHA512_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_CACHE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_COOKIE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_TICKET_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_SRV_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_TLS_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_USE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_CRT_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_CSR_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">// ======== Optimizations =========</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Save RAM at the expense of interoperability: do this only if you control</span></div>
<div class="line"><span class="comment"> * both ends of the connection!  (See coments in &quot;mbedtls/ssl.h&quot;.)</span></div>
<div class="line"><span class="comment"> * The minimum size here depends on the certificate chain used as well as the</span></div>
<div class="line"><span class="comment"> * typical size of records.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_MAX_CONTENT_LEN             4096</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#include &quot;check_config.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_CONFIG_H */</span><span class="preprocessor"></span></div>
</div><!-- fragment --></li>
<li>Set your device's heap to 90KB or more (or increase existing). In the <b>Project</b> window, under <b>Device</b>, open the file <code>startup_xxx.s</code> and set <div class="fragment"><div class="line">Heap_Size = 0x16000</div>
</div><!-- fragment --> or more, depending on your application.</li>
<li>Configure the RTX threads<ul>
<li>If you use <b>RTX v5</b>, you do not need to change the <b>RTX settings</b>, because all resources are statically allocated.</li>
<li>If you use <b>RTX v4</b>, you must change the following settings in the <script>link_ext('RTX-Conf-CM4');</script> file:<ul>
<li>Increase the <b>Number of concurrent running user threads</b> by <b>1</b> </li>
<li>Increase the <b>Number of threads with user-provided stack size</b> by <b>1</b> </li>
<li>Increase <b>Total stack size [bytes] for threads with user-provided stack size</b> by the value set for the macro <code>TLS_THREAD_STACK_SIZE</code> in TLS_mbed.c (default is 4096)</li>
</ul>
</li>
</ul>
</li>
<li>Update the HTTP Server configuration file (<code>Net_Config_HTTP_Server.h</code>):<ul>
<li>Change the <b>Port</b> <b>Number</b> to <em>443</em> or to <em>0</em> (auto-selects 443 for HTTPS or 80 for HTTP)</li>
</ul>
</li>
<li>Build the example and download to Flash. If it fails, please check your "Read/Write Memory Areas" in your target options.</li>
<li>You can test the example from a browser by connecting to "https://board_name" or "https://ip_address" (depending on your settings in <code>Net_Config.c</code> file.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>The first connection might take a while (a few seconds up to 10s) and depends on the browser and how many sockets/sessions it initially opens (differs in Edge, Chrome, Firefox, etc.). This delay is normal and due to the time required for asymmetric cryptography calculations on the target. After the initial delay, the HTTPS server works almost as fast the HTTP server.</li>
<li>Your browser will complain during the connection that the certificate has a problem or is not trusted. You will need to add the certificate to your browser's trusted certificate storage manually.</li>
<li>Do not use the test certificate in productive environments as it is not secret. Before shipping your product, make sure that you have added your <a class="el" href="use_secure_components.html#cert_creation">own certificates and keys</a>.</li>
</ul>
</dd></dl>
<h2><a class="anchor" id="cert_creation"></a>
Creating your own certificates and keys</h2>
<p>The Network Component's HTTPS service adds the file <code>Net_Security.c</code> to the project. This file contains generic test keys/certificates which enable the application to run out of the box. If you want to adapt the keys/certificates to your needs, you can do this by modifying this file or by executing the batch file <code>Net_Security.bat</code> that is part of the Network Component.</p>
<p><code>Net_Security.bat</code> can be registered in µVision under <b>Tools</b> for general usage:</p>
<ul>
<li>Go to <b>Tools</b> &ndash;&gt; <b>Customize Tools Menu</b></li>
<li>Click the <b>New (Insert)</b> button and enter a meaningful name, for example "Net_Security Keys"</li>
<li>In the <b>Command</b> box enter <code>$PRTE\Network\Net_Security.bat</code> </li>
<li>In the <b>Initial</b> <b>Folder</b> box enter <code>$PRTE\Network</code> </li>
<li>In the <b>Arguments</b> box enter <code>@K</code> </li>
<li>Enable <b>Run</b> <b>Independent</b> </li>
</ul>
<div class="image">
<img src="Net_Security_Keys.PNG" alt="Net_Security_Keys.PNG"/>
<div class="caption">
Settings required for the Net_Security.bat file</div></div>
<p> This setting is needed only once in µVision and will work for any project since it uses project related folders.</p>
<p>The file <code>Net_Security.bat</code> is copied to the project (.\RTE\Network) folder together with <code>Net_Security.c</code>. As it is project specific, the batch file can be customized to reflect your specific values for the certificates:</p>
<ul>
<li>CA and Server Private Keys: type (default: RSA) and key_size (default: 2048)</li>
<li>CA certificate: issuer_name (default:CN="Test CA",O="Unknown",C=US), serial (default: 0), not_before (default: 20200101000000), not_after (20301231235959)</li>
<li>Server certificate: subject_name (default: CN="localhost",O="MyOrganization",C=US), serial (default: 1), not_before (default: 20200101000000), not_after (20301231235959)</li>
</ul>
<p>The beginning of the file contains some environment settings that can also be changed:</p>
<ul>
<li>RTEPATH: specifies the path to Software Packs. This is required if the batch file is executed directly from Windows. When it is executed from µVision, it is set automatically.</li>
<li>Pack Versions (MDK-MW and mbedTLS): only required if you want to select a specific Pack version. By default, the latest available Pack is used.</li>
</ul>
<p>As soon as you run the batch file from the <b>Tools</b> menu, it will create the keys/certificates and change the <code>Net_Security.c</code> automatically to reflect the changes. You can then continue building the project.</p>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>The Net_Security.bat file calls the pem2mw.exe utility. This utility does not support all kinds of certificates.</li>
<li>If you are using an unsupported certificate, you can bypass pem2mw easily by manually creating the output Net_Security.c file:<ul>
<li>Adapt Net_Security.bat to skip calling pem2mw (optional)</li>
<li>Copy the contents of ca.crt into NetSecurity_ServerCA structure in Net_Security.c and add leading " and trailing \n" to each line</li>
<li>Copy the contents of server.crt into NetSecurity_ServerCert structure in Net_Security.c and add leading " and trailing \n" to each line</li>
<li>Copy the contents of server.key into NetSecurity_ServerKey structure in Net_Security.c and add leading " and trailing \n" to each line</li>
</ul>
</li>
</ul>
</dd></dl>
<p><b>Code</b> <b>example:</b> <br/>
Server.key </p>
<div class="fragment"><div class="line">-----BEGIN PUBLIC KEY-----</div>
<div class="line">MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEd3Jlb4FLOZJ51eHxeB+sbwmaPFyh</div>
<div class="line">sONTUYNLCLZeC1clkM2vj3aTYbzzSs/BHl4HToQmvd4Evm5lOUVElhfeRQ==</div>
<div class="line">-----END PUBLIC KEY-----</div>
</div><!-- fragment --><p>Net_Security.c </p>
<div class="fragment"><div class="line"><span class="keyword">const</span> uint8_t NetSecurity_ServerKey[] =</div>
<div class="line"><span class="stringliteral">&quot;-----BEGIN PUBLIC KEY-----\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEd3Jlb4FLOZJ51eHxeB+sbwmaPFyh\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;sONTUYNLCLZeC1clkM2vj3aTYbzzSs/BHl4HToQmvd4Evm5lOUVElhfeRQ==\n&quot;</span></div>
<div class="line"><span class="stringliteral">&quot;-----END PUBLIC KEY-----\n&quot;</span></div>
<div class="line">;</div>
</div><!-- fragment --><h1><a class="anchor" id="smtps_client"></a>
SMTPS Client</h1>
<p>The e-mail client is available in a secure variant. In the <b>Manage Run-Time Environment</b> window, simply select the appropriate variant:</p>
<div class="image">
<img src="select_smtps.png" alt="select_smtps.png"/>
</div>
<h2><a class="anchor" id="add_ssl_to_smtp"></a>
Converting the SMTP client to SMTPS</h2>
<p>It is also possible to convert an already existing e-mail client to a secure SMTPS e-mail client. A few simple steps are required to achieve this:</p>
<ol type="1">
<li>Download and install the <b>ARM:mbedTLS</b> Software Pack (see <a class="el" href="use_mbed_tls.html#add_mbedtls">Add the mbed TLS library to a µVision project</a>).</li>
<li>Change the following software components in the Manage Run-Time Environment:<ul>
<li>Set <b>Network:Service:SMTP Client</b> variant to <b>SMTPS</b>.</li>
<li>Enable <b>Security:mbed TLS</b> or resolve this dependency automatically.</li>
</ul>
</li>
<li>Update the <code>mbedTLS_Config.h</code> configuration file with the following (a copy named <code>mbedTLS_config_SMTPS.h</code> is available in the <b>Template</b> folder): <div class="fragment"><div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> *  Configuration template for SMTPS</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  Copyright (C) 2006-2015, ARM Limited, All Rights Reserved</span></div>
<div class="line"><span class="comment"> *  SPDX-License-Identifier: Apache-2.0</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may</span></div>
<div class="line"><span class="comment"> *  not use this file except in compliance with the License.</span></div>
<div class="line"><span class="comment"> *  You may obtain a copy of the License at</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  http://www.apache.org/licenses/LICENSE-2.0</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  Unless required by applicable law or agreed to in writing, software</span></div>
<div class="line"><span class="comment"> *  distributed under the License is distributed on an &quot;AS IS&quot; BASIS, WITHOUT</span></div>
<div class="line"><span class="comment"> *  WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span></div>
<div class="line"><span class="comment"> *  See the License for the specific language governing permissions and</span></div>
<div class="line"><span class="comment"> *  limitations under the License.</span></div>
<div class="line"><span class="comment">  </span></div>
<div class="line"><span class="comment"> *  This file is part of mbed TLS (https://tls.mbed.org)</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * This set of compile-time options may be used to enable</span></div>
<div class="line"><span class="comment"> * or disable features selectively, and reduce the global</span></div>
<div class="line"><span class="comment"> * memory footprint.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#ifndef MBEDTLS_CONFIG_H</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CONFIG_H</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">/* System support */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ENTROPY_HARDWARE_ALT</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">/* mbed TLS feature support */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_AES_ROM_TABLES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_MODE_CBC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_PADDING_PKCS7</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_REMOVE_ARC4_CIPHERSUITES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ECP_DP_SECP256R1_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ECP_DP_SECP384R1_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ECP_NIST_OPTIM</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ECDSA_DETERMINISTIC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_ECDHE_PSK_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_ECDHE_RSA_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_KEY_EXCHANGE_ECDHE_ECDSA_ENABLED</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ERROR_STRERROR_DUMMY</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_NO_PLATFORM_ENTROPY</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PK_RSA_ALT_SUPPORT</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PKCS1_V15</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PKCS1_V21</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SELF_TEST</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_ALL_ALERT_MESSAGES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_ENCRYPT_THEN_MAC</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_EXTENDED_MASTER_SECRET</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_RENEGOTIATION</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_MAX_FRAGMENT_LENGTH</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_PROTO_TLS1_2</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_ALPN</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_SESSION_TICKETS</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_SERVER_NAME_INDICATION</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_VERSION_FEATURES</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_CHECK_KEY_USAGE</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_CHECK_EXTENDED_KEY_USAGE</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">/* mbed TLS modules */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_AES_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ASN1_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ASN1_WRITE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_BASE64_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_BIGNUM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CCM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CERTS_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CIPHER_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_CTR_DRBG_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="comment">//#define MBEDTLS_DEBUG_C</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_ECDH_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ECDSA_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ECP_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ENTROPY_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_ERROR_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_GCM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_HMAC_DRBG_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_MD_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_OID_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PEM_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PK_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PK_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PK_WRITE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_PLATFORM_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_RSA_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SHA256_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SHA512_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_CACHE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_COOKIE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_TICKET_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_CLI_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_SSL_TLS_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_VERSION_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_USE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_CRT_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span><span class="preprocessor">#define MBEDTLS_X509_CRL_PARSE_C</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="comment">// ======== Optimizations =========</span></div>
<div class="line"><span class="comment">/*</span></div>
<div class="line"><span class="comment"> * Save RAM at the expense of interoperability: do this only if you control</span></div>
<div class="line"><span class="comment"> * both ends of the connection!  (See coments in &quot;mbedtls/ssl.h&quot;.)</span></div>
<div class="line"><span class="comment"> * The minimum size here depends on the certificate chain used as well as the</span></div>
<div class="line"><span class="comment"> * typical size of records.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define MBEDTLS_SSL_MAX_CONTENT_LEN             8192</span></div>
<div class="line"><span class="preprocessor"></span> </div>
<div class="line"><span class="preprocessor">#include &quot;check_config.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* MBEDTLS_CONFIG_H */</span><span class="preprocessor"></span></div>
</div><!-- fragment --></li>
<li>Set your device's heap to at least 49 KB or increase appropriately. In the <b>Project</b> window, under <b>Device</b>, open the file <code>startup_xxx.s</code> and set <div class="fragment"><div class="line">Heap_Size = 0xC000</div>
</div><!-- fragment --> or more, depending on your application.</li>
<li>Configure the RTX threads<ul>
<li>If you use <b>RTX v5</b>, you do not need to change the <b>RTX settings</b>, because all recources are statically allocated.</li>
<li>If you use <b>RTX v4</b>, you must change the following settings in the <script>link_ext('RTX-Conf-CM4');</script> file:<ul>
<li>Increase the <b>Number of concurrent running user threads</b> by <b>1</b> </li>
<li>Increase the <b>Number of threads with user-provided stack size</b> by <b>1</b> </li>
<li>Increase <b>Total stack size [bytes] for threads with user-provided stack size</b> by the value set for the macro <code>TLS_THREAD_STACK_SIZE</code> in TLS_mbed.c (default is 4096)</li>
</ul>
</li>
</ul>
</li>
<li>Build the example and download to Flash. If it fails, please check your "Read/Write Memory Areas" in your target options.</li>
<li>You can test the example by sending an e-mail to your e-mail account, for example to Gmail or Yahoo.</li>
</ol>
<dl class="section note"><dt>Note</dt><dd><ul>
<li>It is not required to create your own certificates or keys to send secure e-mails using SMTPS. </li>
</ul>
</dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="secure_communication.html">Secure Communication</a></li>
    <li class="footer">Generated on Tue May 25 2021 13:57:37 for Network Component by ARM Ltd. All rights reserved.
	<!--
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.6 
	-->
	</li>
  </ul>
</div>
</body>
</html>
